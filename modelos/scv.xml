<root nsw="Livre">


	<item create="true"  id="1" name="TBCADUSU" friendlyname="Users" modelversion="3" descriptor="Cadastro de Usuários">
		<CSharpPartial>True</CSharpPartial>
		<SqlTable>
		</SqlTable>


		<view>
			<item owner="dbo" script="true" name="VWCADUSU" desc ="View de Informações de usuários">
				<query>
					<![CDATA[
SELECT USU.CODUSU
      ,USU.CODATR
	  ,ATR.DSCATR
	  ,USU.CODCMF
      ,USU.TYPCMF
	  ,TYP.DSCTYP
	  ,USU.CODREF
	  ,USU.RAZSOC
	  ,USU.NOMFAN
	  ,USU.DATADM
	  ,USU.DATNAC
	  ,USU.ENVNEW
      ,USU.LGNTYP
	  ,DSCLGN = ISNULL(T940.DSCTAB,'')
	  ,USU.LGNUSU
	  ,USU.PSWUSU
	  ,USU.PSWRST
	  ,USU.PFLUSU
	  ,PFL.DSCPFU
      ,USU.CODSPT
	  ,USU.NUMCRV
	  ,USU.UFECRV
	  ,USU.ULTACE
	  ,USU.ULTLOG
	  ,USU.STAREC
	  ,USU.DATCAD
	  ,USU.DATUPD
	  ,USU.UPDUSU
	  ,USU.CODGEN
	  ,GEN.DSCGEN
	  ,LGN.LGNUSU AS DSCOPE
	  ,STA.DSCREC
	  ,SPT.DSCSPT
	  ,ISNULL(ADR.DSCEND,'') AS DSCMAL
  FROM TBCADUSU AS USU 
 INNER JOIN RFCODATR AS ATR ON USU.CODATR = ATR.CODATR 
 INNER JOIN RFTYPCMF AS TYP ON USU.TYPCMF = TYP.TYPCMF 
 INNER JOIN RFCODGEN AS GEN ON USU.CODGEN = GEN.CODGEN 
 INNER JOIN RFPFLUSU AS PFL ON USU.PFLUSU = PFL.PFLUSU 
 INNER JOIN RFSPTVET AS SPT ON USU.CODSPT = SPT.CODSPT
 INNER JOIN TBSTAREC AS STA ON USU.STAREC = STA.STAREC
  LEFT JOIN (SELECT NIDGER, CODATR, DSCEND FROM TBCADEND (NOLOCK) WHERE TIPEND=3 AND REGATV =1 AND STAREC=1) AS ADR ON USU.CODUSU = ADR.NIDGER AND USU.CODATR = ADR.CODATR 
  LEFT OUTER JOIN TBCADUSU AS LGN ON USU.UPDUSU = LGN.CODUSU
  LEFT JOIN TBTABGER (NOLOCK) T940
    ON (T940.CODTAB = 940 AND T940.KEYCOD = USU.LGNTYP)

        ]]>
				</query>
			</item>
		</view>

		<objectclass>
			<item acess="" modifier="" name="UsersList" inherit="" desc ="Objeto de Retenção de Informações de Usuários" remarks="">
				<query>
					<![CDATA[
SELECT USU.CODUSU
      ,USU.CODATR
	  ,ATR.DSCATR
	  ,USU.CODCMF
      ,USU.TYPCMF
	  ,TYP.DSCTYP
	  ,USU.CODREF
	  ,USU.RAZSOC
	  ,USU.NOMFAN
	  ,USU.DATADM
	  ,USU.DATNAC
	  ,USU.ENVNEW
      ,USU.LGNTYP
	  ,DSCLGN = ISNULL(T940.DSCTAB,'')
	  ,USU.LGNUSU
	  ,USU.PSWUSU
	  ,USU.PSWRST
	  ,USU.PFLUSU
	  ,PFL.DSCPFU
      ,USU.CODSPT
	  ,USU.NUMCRV
	  ,USU.UFECRV
	  ,USU.ULTACE
	  ,USU.ULTLOG
	  ,USU.STAREC
	  ,USU.DATCAD
	  ,USU.DATUPD
	  ,USU.UPDUSU
	  ,USU.CODGEN
	  ,GEN.DSCGEN
	  ,LGN.LGNUSU AS DSCOPE
	  ,STA.DSCREC
	  ,SPT.DSCSPT
	  ,ISNULL(ADR.DSCEND,'') AS DSCMAL
  FROM TBCADUSU AS USU 
 INNER JOIN RFCODATR AS ATR ON USU.CODATR = ATR.CODATR 
 INNER JOIN RFTYPCMF AS TYP ON USU.TYPCMF = TYP.TYPCMF 
 INNER JOIN RFCODGEN AS GEN ON USU.CODGEN = GEN.CODGEN 
 INNER JOIN RFPFLUSU AS PFL ON USU.PFLUSU = PFL.PFLUSU 
 INNER JOIN RFSPTVET AS SPT ON USU.CODSPT = SPT.CODSPT
 INNER JOIN TBSTAREC AS STA ON USU.STAREC = STA.STAREC
  LEFT JOIN (SELECT NIDGER, CODATR, DSCEND FROM TBCADEND (NOLOCK) WHERE TIPEND=3 AND REGATV =1 AND STAREC=1) AS ADR ON USU.CODUSU = ADR.NIDGER AND USU.CODATR = ADR.CODATR 
  LEFT OUTER JOIN TBCADUSU AS LGN ON USU.UPDUSU = LGN.CODUSU
  LEFT JOIN TBTABGER (NOLOCK) T940
    ON (T940.CODTAB = 940 AND T940.KEYCOD = USU.LGNTYP)
     
        ]]>

				</query>
			</item>

			<item acess="" modifier="" name="UserLogged" inherit="" desc ="Objeto de Retenção de Informações de Usuário Logado" remarks="">
				<query>
					<![CDATA[
   SELECT TOP 1
          USU.LGNUSU,
          USU.CODUSU,
		  USU.RAZSOC,
          NUMTEL = ISNULL(CTO.NUMTEL,''),
          DSCMAL = ISNULL(ADR.DSCMAL,''),
          USU.PFLUSU,
		   DSCPFU,
		   PSWRST
    FROM TBCADUSU (NOLOCK) USU
   LEFT JOIN (SELECT NIDGER, CODATR, DSCEND AS DSCMAL FROM TBCADEND (NOLOCK) A WHERE A.STAREC=1 ) ADR
      ON (ADR.NIDGER = USU.CODUSU AND ADR.CODATR  = USU.CODATR)
   LEFT JOIN (SELECT NIDGER, CODATR, NUMTEL FROM TBCADCTO (NOLOCK) A WHERE A.STAREC=1 ) CTO
      ON (CTO.NIDGER = USU.CODUSU AND CTO.CODATR  = USU.CODATR)
   INNER JOIN RFPFLUSU (NOLOCK) PFL ON (PFL.PFLUSU = USU.PFLUSU)
   WHERE USU.CODUSU=-1
     
        ]]>

				</query>
			</item>
		</objectclass>

		<insertcommand key="Key" fieldreturn="" exceptionparamns="'DATCAD','DATUPD'" procname="PRCADUSUINS">
			<maxfield field=""/>
			<nextnumber field="" id="" />
			<pre>
				<![CDATA[
				
/*
   CAMPOS PSWUSU e PSWRST
    ALTERACAO : respectivamente senha de usuário e definição de reset de senha, somente podem ser alterados por módulo específico solicitado pelo usuário.
    INCLUSAO  : No processo de inclusão, respectivamente é incluido com a senha Mudar@123 e forçado a redefinir a senha no logon do aplicativo.
 
 */
IF(@CODATR<=0)
	SET @RETURN_VALUE =-1;	

IF(@RETURN_VALUE=0)
   BEGIN
		IF(@CODCMF IS NULL OR @CODCMF = '')
			SET @RETURN_VALUE =-2;	
   END
IF(@RETURN_VALUE=0)
   BEGIN
		IF(@RAZSOC IS NULL OR @RAZSOC= '')
			SET @RETURN_VALUE =-3;	
   END
   
IF(@RETURN_VALUE=0)
	BEGIN
		IF(@NOMFAN IS NULL OR @NOMFAN= '')
			SET @NOMFAN=N'';	
	END
	
IF(@RETURN_VALUE=0 AND @CODUSU <> 0)
	BEGIN
		IF (EXISTS ( SELECT 1 FROM TBCADUSU (NOLOCK) WHERE CODUSU = @CODUSU AND CODATR = @CODATR ) )
		    SET @RETURN_VALUE = -2;
	END
	
IF(@RETURN_VALUE=0 AND @CODUSU = 0)
	BEGIN
		IF (EXISTS (SELECT 1 FROM TBCADUSU (NOLOCK) WHERE LGNUSU = @LGNUSU))
			    SET @RETURN_VALUE = -4;
		ELSE
			SET @PSWUSU = 'dgefdfagbd`cacbcc';
			SET @PSWRST = 1;
	END

			]]>
			</pre>
			<body></body>
			<pos>
				<![CDATA[
IF(@RETURN_VALUE = -2)
	BEGIN
	
		IF (EXISTS (SELECT 1 FROM TBCADUSU (NOLOCK) WHERE LGNUSU = @LGNUSU AND  NOT (CODUSU = @CODUSU AND CODATR = @CODATR)))
			    SET @RETURN_VALUE = -5;
				
		IF(@RETURN_VALUE = -2 )
			BEGIN
				UPDATE TBCADUSU
				   SET CODCMF = @CODCMF
					  ,TYPCMF = @TYPCMF
					  ,CODREF = @CODREF
					  ,RAZSOC = @RAZSOC
					  ,NOMFAN = @NOMFAN
					  ,CODGEN = @CODGEN
					  ,DATADM = @DATADM
					  ,DATNAC = @DATNAC
					  ,ENVNEW = @ENVNEW
					  ,LGNTYP = @LGNTYP
					  ,LGNUSU = @LGNUSU
					  ,PFLUSU = @PFLUSU
					  ,CODSPT = @CODSPT
					  ,NUMCRV = @NUMCRV
					  ,UFECRV = @UFECRV
					  ,STAREC = @STAREC
					  ,DATUPD = GETDATE()
					  ,UPDUSU = @UPDUSU
				 WHERE CODUSU = @CODUSU AND CODATR = @CODATR	
				 
				 IF(@@ERROR = 0)
					SET @RETURN_VALUE  = 2;
			END
	END
	

			]]>

			</pos>
			<returns>
				<return operator=">" value="0" message="Registro inserido com sucesso" error="OK"/>
				<return value="-1" message="Código de Atributo inválido" error="FAILALL"/>
				<return value="-2" message="O CPF/CNPJ/RNE é inválido ou não foi fornecido" error="FAILALL"/>
				<return value="-3" message="O Nome ou Razão Social deverá ser informado" error="FAILALL"/>
				<return value="-4" message="O Login infomado já existe para outro usuário" error="FAILALL"/>
				<return value="-5" message="O Login informado já possui outro proprietário" error="FAILALL"/>

			</returns>
		</insertcommand>

		<selectcommand>
			<item script="false" alias="A." sql="" method="Select" return="Users" procname="" desc ="Seleciona o registro de acordo com o Código do Usuário">
				<query>
					<![CDATA[SELECT * FROM TBCADUSU (NOLOCK) A ]]>
				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="ID de Registro" name="CODUSU" type="int" default="" output="" null="false"/>
				</parameters>
			</item>
			<item script="false" alias="A." sql="" method="Select" return="Users" procname="" desc ="Seleciona o registro de acordo com o Código do Usuário">
				<query>
					<![CDATA[SELECT * FROM TBCADUSU (NOLOCK) A ]]>
				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="Código do Atributo" name="CODATR" type="System.Byte" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Código CMF" name="CODCMF" type="System.String" default="" output="" null="false"/>

				</parameters>
			</item>

			<item script="false" alias="A." sql="" method="LocateCMF" return="int" returnmode="2" procname="" desc ="Verifica se existe um registro cadastrado atraves do CODCMF e CODATR, independente do status do registro, se existir retorna o CODUSU do registro" returnvalue="0" remarks="Retorna o ID do Registro, -1 indica se que não existe">
				<query>
					<![CDATA[
DECLARE @RETURN_VALUE INT = 0
IF(EXISTS(SELECT 1 FROM TBCADUSU (NOLOCK) A  WHERE A.CODATR = @CODATR AND  A.CODCMF = @CODCMF))
    SELECT TOP 1 @RETURN_VALUE = CODUSU FROM TBCADUSU (NOLOCK) A WHERE A.CODATR = @CODATR AND  A.CODCMF = @CODCMF ORDER BY DATCAD;
ELSE
    SET @RETURN_VALUE = -1;
IF(@RETURN_VALUE IS NULL)
   SET @RETURN_VALUE = -1;
SELECT @RETURN_VALUE AS RETURN_VALUE;
          ]]>
				</query>
				<parameters>
					<parameter input="true" apply="true" omit="true" desc ="Código do CMF" name="CODCMF" type="System.String" size="15" default="" output="" null="false"/>
					<parameter input="true" apply="true" omit="true" desc ="Código do Atributo" name="CODATR" type="int" default="1" output="" null="false"/>
				</parameters>
			</item>

		</selectcommand>
		<selectallcommand>
			<item script="false" alias="A." sql="" type="List" method="SelectAll" return="UsersList" procname="" desc ="Obtêm uma lista de todos os usuario cadastrados">
				<query>
					<![CDATA[SELECT * FROM VWCADUSU A]]>
				</query>
				<parameters>
					<parameter input="true" desc ="Nome"  islike="true" name="RAZSOC" type="System.String" size="70" default="null" output="" null="true"/>
					<parameter input="true" desc ="Email" omit="true" alias="" islike="true" name="DSCMAL" type="System.String" size="70" default="null" output="" null="true"/>
					<parameter input="true" desc ="Login" islike="true" name="LGNUSU" type="System.String" size="70" default="null" output="" null="true"/>
					<parameter input="true" desc ="Atributo" name="CODATR" type="System.Byte" default="3" output="" null="true"/>

				</parameters>
			</item>
		</selectallcommand>

	</item>

	<item create="true"  id="1" name="RLUSUEMP" friendlyname="UsersxCompany" modelversion="3" descriptor="Associação de Usuário x Empresa">
		<CSharpPartial>True</CSharpPartial>
		<SqlTable>
		</SqlTable>
		<extendedmodel>
			<![CDATA[SELECT UXE.*, USU.RAZSOC, EMP.APEEMP, STA.DSCREC, LGN.LGNUSU
  FROM RLUSUEMP UXE
 INNER JOIN TBCADUSU (NOLOCK) USU
    ON (USU.CODUSU = UXE.CODUSU)
 INNER JOIN TBCADEMP (NOLOCK) EMP
    ON (EMP.CODEMP = UXE.CODEMP)
 INNER JOIN TBSTAREC (NOLOCK) STA
    ON (STA.STAREC = UXE.STAREC)
  LEFT JOIN (SELECT CODUSU, LGNUSU FROM TBCADUSU (NOLOCK) ) LGN
    ON (LGN.CODUSU = UXE.UPDUSU) WHERE USU.CODUSU=-1;]]>
		</extendedmodel>



		<insertcommand key="Key" fieldreturn="" exceptionparamns="'DATCAD','DATUPD'" procname="PRUSUEMPINS">
			<maxfield field=""/>
			<nextnumber field="" id="" />
			<pre>
				<![CDATA[
IF(EXISTS (SELECT 1 FROM RLUSUEMP (NOLOCK) WHERE CODUSU = @CODUSU AND CODEMP = @CODEMP))
   SET @RETURN_VALUE = -2;
			]]>
			</pre>
			<body></body>
			<pos>
				<![CDATA[
IF(@RETURN_VALUE = -2)
	BEGIN
	
		IF (EXISTS (SELECT 1 FROM RLUSUEMP (NOLOCK) WHERE CODUSU = @CODUSU AND CODEMP =@CODEMP AND STAREC=@STAREC))
			    SET @RETURN_VALUE = -3;
				
		IF(@RETURN_VALUE = -2 )
			BEGIN
				UPDATE RLUSUEMP
				   SET STAREC = @STAREC
					  ,DATUPD = GETDATE()
					  ,UPDUSU = @UPDUSU
				 WHERE CODUSU = @CODUSU AND CODEMP =@CODEMP	
				 
				 IF(@@ERROR = 0)
					SET @RETURN_VALUE  = 2;
			END
	END
	

			]]>

			</pos>
			<returns>
				<return operator=">" value="0" message="Registro atualizado com sucesso" error="OK"/>
				<return value="-1" error="FAILALL"/>
				<return value="-2" message="O CPF/CNPJ/RNE é inválido ou não foi fornecido" error="RECORDFOUND"/>
				<return value="-3" message="A Atualização solicitada não é necessária, o registro já se encontra nas condições da atualização" error="RECORDFOUND"/>

			</returns>
		</insertcommand>

		<selectcommand>
			<item script="false" alias="A." sql="" method="Select" return="UsersxCompany" procname="" desc ="Seleciona o registro de acordo com o Código do Usuário">
				<query>
					<![CDATA[SELECT * FROM RLUSUEMP (NOLOCK) A ]]>
				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="Código do Usuário" name="CODUSU" type="int" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Código da Empresa" name="CODEMP" type="int" default="" output="" null="false"/>

				</parameters>
			</item>



		</selectcommand>


		<selectallcommand>
			<item script="false" alias="A." sql="" type="List" method="SelectAll" return="UsersxCompany" procname="" desc ="Obtêm uma lista de todos os usuario cadastrados associados a uma empresa">
				<query>
					<![CDATA[
					SELECT UXE.CODUSU, A01.RAZSOC, UXE.CODEMP, EMP.APEEMP, UXE.STAREC, STA.DSCREC, UXE.DATCAD, UXE.DATUPD, LGNUSU = ISNULL(LGN.LGNUSU,'')
  FROM RLUSUEMP (NOLOCK) UXE
 INNER JOIN (SELECT CODUSU, RAZSOC 
          FROM TBCADUSU USU
          LEFT JOIN (SELECT NIDGER, CODATR, DSCEND FROM TBCADEND (NOLOCK) WHERE TIPEND=3 AND REGATV =1 AND STAREC=1) AS ADR
           ON USU.CODUSU = ADR.NIDGER AND USU.CODATR = ADR.CODATR 
        WHERE (@RAZSOC IS NULL OR  RAZSOC LIKE '%' +  @RAZSOC + '%'
		   OR @LGNUSU IS NULL OR LGNUSU LIKE '%' + @LGNUSU  + '%'
           OR @DSCMAL IS NULL OR DSCEND LIKE '%' + @DSCMAL  +'%')
		   AND USU.CODATR = @CODATR) A01
    ON (A01.CODUSU = UXE.CODUSU)
 INNER JOIN TBCADEMP (NOLOCK) EMP
    ON (EMP.CODEMP = UXE.CODEMP)
 INNER JOIN TBSTAREC (NOLOCK) STA
    ON (STA.STAREC = UXE.STAREC)
  LEFT JOIN (SELECT CODUSU, LGNUSU FROM TBCADUSU (NOLOCK) ) LGN
    ON (LGN.CODUSU = UXE.UPDUSU)

     ]]>
				</query>
				<parameters>
					<parameter input="true" desc ="Nome"  omit="true" islike="true" name="RAZSOC" type="System.String" size="70" default="null" output="" null="true"/>
					<parameter input="true" desc ="Email" omit="true" alias="" islike="true" name="DSCMAL" type="System.String" size="70" default="null" output="" null="true"/>
					<parameter input="true" desc ="Login" omit="true" islike="true" name="LGNUSU" type="System.String" size="70" default="null" output="" null="true"/>
					<parameter input="true" desc ="Atributo" omit="true" name="CODATR" type="System.Byte" default="3" output="" null="true"/>

				</parameters>
			</item>

			<item script="false" alias="A." sql="" type="List" method="SelectAll" return="UsersxCompany" procname="" desc ="Obtêm uma lista de todos os usuario cadastrados associados a uma empresa conforme o atributo">
				<query>
					<![CDATA[

SELECT UXE.*, USU.RAZSOC, EMP.APEEMP, STA.DSCREC, LGNUSU = ISNULL(LGN.LGNUSU,'')
  FROM RLUSUEMP UXE
 INNER JOIN TBCADUSU (NOLOCK) USU
    ON (USU.CODUSU = UXE.CODUSU)
 INNER JOIN TBCADEMP (NOLOCK) EMP
    ON (EMP.CODEMP = UXE.CODEMP)
 INNER JOIN TBSTAREC (NOLOCK) STA
    ON (STA.STAREC = UXE.STAREC)
  LEFT JOIN (SELECT CODUSU, LGNUSU FROM TBCADUSU (NOLOCK) ) LGN
    ON (LGN.CODUSU = UXE.UPDUSU)

     ]]>
				</query>
				<parameters>
					<parameter input="true" desc ="Atributo" alias="USU." name="CODATR" type="System.Byte" default="3" output="" null="true"/>

				</parameters>
			</item>
		</selectallcommand>

	</item>
	<item create="true"  id="1" name="TBLGNUSU" friendlyname="UserLogin" modelversion="3" descriptor="Login de Usuário">
		<UpdateKey>Identity</UpdateKey>
		<audit>FALSE</audit>
		<keyaudit></keyaudit>
		<FilterSelect>False</FilterSelect>
		<listselect></listselect>
		<CSharpPartial>true</CSharpPartial>
		<SqlTable></SqlTable>
		<procedure>1111000000</procedure>
		<asp>1111000000</asp>
		<csharp>1111000000</csharp>
		<extendedmodel>
			<![CDATA[SELECT A.*, ISNULL(C.DSCTAB,'') AS DSCREC, B.RAZSOC, LGNUPD = D.LGNUSU
 FROM TBLGNUSU A (NOLOCK)
INNER JOIN TBCADGER (NOLOCK) B ON (B.CODGER = A.CODGER)
INNER JOIN TBTABGER (NOLOCK) C ON (C.CODTAB = 7 AND C.KEYCOD = A.STAREC)	 
 LEFT JOIN TBLGNUSU (NOLOCK) D ON (D.UPDUSU = A.UPDUSU AND D.REGATV = 1) WHERE A.CODGER=-1;	]]>
		</extendedmodel>




		<objectclass>
			<item script="true" alias="A." sql="" method="UserLogged" return="int" returnmode="1" procname="" desc ="Objeto de Retenção de Informações de Login" returnvalue="1">
				<query>
					<![CDATA[

SELECT A.NIDLOG, A.CODGER,B.RAZSOC, A.LGNUSU, A.PSWRST, DSCMAL = C.DSCEND, NUMCEL = D.NUMTEL, B.CODATR, '   ' AS ABRATR FROM TBLGNUSU (NOLOCK) A
INNER JOIN TBCADGER (NOLOCK) B ON (B.CODGER = A.CODGER)
INNER JOIN TBCADEND (NOLOCK) C ON (C.CODGER = A.CODGER AND C.REGATV = 1 AND C.TIPEND = 3 AND C.STAREC=1)
INNER JOIN TBCADCTO (NOLOCK) D ON (D.CODGER = A.CODGER AND D.REGATV = 1 AND D.TIPCTO = 3 AND D.STAREC=1)
WHERE A.NIDLOG=-1;

        ]]>

				</query>
			</item>
		</objectclass>
		<insertcommand key="Identity" exceptionparamns="'DATCAD','DATUPD'" fieldreturn="NIDLOG" procname="PRLGNUSUINS">
			<maxfield field=""/>
			<nextnumber field="" id="" />
			<pre>
				<![CDATA[
DECLARE @ACEESP BIT =0;
DECLARE @CODATR TINYINT = 0
IF(EXISTS(SELECT 1 FROM TBLGNUSU (NOLOCK) WHERE LGNUSU = @LGNUSU))
    SET @RETURN_VALUE=-1;

IF(@RETURN_VALUE=0)
   BEGIN
		IF(NOT EXISTS(SELECT 1 FROM TBCADGER (NOLOCK) WHERE CODGER = @CODGER AND STAREC=1))
			SET @RETURN_VALUE=-2;
   END

IF(@RETURN_VALUE=0)
   BEGIN
		IF(@PSWUSU IS NULL OR @PSWUSU = '')
			SET @RETURN_VALUE=-3;
   END
	
SELECT @ACEESP = ISNULL(ACEESP,0), @CODATR = CODATR FROM TBCADGER (NOLOCK) WHERE CODGER = @CODGER AND STAREC=1

IF(@RETURN_VALUE=0)
   BEGIN
		IF(@ACEESP = 0)
			BEGIN
				IF(NOT EXISTS(SELECT 1 FROM TBTIPATR (NOLOCK) WHERE CODATR = @CODATR AND STAREC=1 AND PERLOG=1))
					SET @RETURN_VALUE=-4;	
			END
	END
      ]]>


			</pre>
			<body></body>
			<pos>
				<![CDATA[
	IF(@RETURN_VALUE>0)
		UPDATE TBLGNUSU SET REGATV=0 WHERE CODGER = @CODGER AND NIDLOG <> @RETURN_VALUE ;]]>
			</pos>
			<returns>
				<return operator=">" value="0" message="Registro inserido com sucesso" error="OK"/>
				<return value="-1" message="O Login já existe" error="RECORDFOUND"/>
				<return value="-2" message="O Cadastro de referência não existe ou está inativo" error="USERNOTFOUND"/>
				<return value="-3" message="" error="PASSWORDEMPTY"/>
				<return value="-4" message="O Acesso desse registro não é permitido" error="FAILALL"/>

			</returns>
		</insertcommand>

		<updatecommand key="Identity" exceptionparamns="'DATCAD'" procname="PRLGNUSUUPD" method="" fieldreturn="NIDLOG">
			<maxfield field=""/>
			<nextnumber field="" id="" />
			<pre>
				<![CDATA[
				
DECLARE @ACEESP BIT =0;
IF(EXISTS(SELECT 1 FROM TBLGNUSU (NOLOCK) WHERE LGNUSU = @LGNUSU AND NIDLOG<>@NIDLOG))
    SET @RETURN_VALUE=-1;


IF(@RETURN_VALUE=0)
   BEGIN
		IF(@PSWUSU IS NULL OR @PSWUSU = '')
			SET @RETURN_VALUE=-3;
   END
	
SET @DATUPD=GETDATE()		
			]]>
			</pre>
			<body></body>
			<pos>
				<![CDATA[
  	IF(@RETURN_VALUE>0 AND @REGATV=1)
		UPDATE TBLGNUSU SET REGATV=0 WHERE CODGER = @CODGER AND NIDLOG <> @RETURN_VALUE ; 
      ]]>
			</pos>
			<returns>
				<return operator=">" value="0" message="Registro alterado com sucesso" error="OK"/>
				<return value="-1" message="O Login já existe" error="RECORDFOUND"/>
				<return value="-3" message="" error="PASSWORDEMPTY"/>
				<return value="-4" message="Falha na inserção do Login de Usuário" error="FAILALL"/>
			</returns>
		</updatecommand>
		<selectcommand>
			<item script="true" alias="A." sql="" method="Select" return="UserLogin" procname="PRLGNUSUSEL" desc ="Seleciona o registro de acordo com o código do cadastro de contatos">
				<query>
					<![CDATA[SELECT * FROM TBLGNUSU (NOLOCK) A]]>
				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="ID do Registro de Login" name="NIDLOG" type="int" default="" output="" null="false"/>
				</parameters>
			</item>
			<item script="true" alias="A." sql="" method="GetUserLogged" return="UserLogged" procname="PRLGNUSULOGGED" desc ="Obtêm os dados de um usuário logado">
				<query>
					<![CDATA[  SELECT A.NIDLOG, A.CODGER,B.RAZSOC, A.LGNUSU, A.PSWRST, DSCMAL = ISNULL(C.DSCEND,''), NUMCEL = ISNULL(D.NUMTEL,''), B.CODATR, E.ABRATR FROM TBLGNUSU (NOLOCK) A
    INNER JOIN TBCADGER (NOLOCK) B ON (B.CODGER = A.CODGER)
	INNER JOIN TBTIPATR (NOLOCK) E ON (E.CODATR = B.CODATR)
     LEFT JOIN TBCADEND (NOLOCK) C ON (C.CODGER = A.CODGER AND C.REGATV = 1 AND C.TIPEND = 3 AND C.STAREC=1)
     LEFT JOIN TBCADCTO (NOLOCK) D ON (D.CODGER = A.CODGER AND D.REGATV = 1 AND D.TIPCTO = 3 AND D.STAREC=1)]]>
				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="ID do Registro de Login" name="NIDLOG" type="int" default="" output="" null="false"/>
				</parameters>
			</item>


		</selectcommand>
		<selectallcommand>
			<item script="true" alias="A." sql="" type="List" method="SelectAll" return="UserLogin" procname="PRLNGUSUSELALL" desc ="Obtêm uma lista de todos os logins cadastrados">
				<query>
					<![CDATA[SELECT A.*, ISNULL(C.DSCTAB,'') AS DSCREC, B.RAZSOC, LGNUPD=D.LGNUSU
 FROM TBLGNUSU A (NOLOCK)
INNER JOIN TBCADGER (NOLOCK) B ON (B.CODGER = A.CODGER)
INNER JOIN TBTABGER (NOLOCK) C ON (C.CODTAB = 7 AND C.KEYCOD = A.STAREC)	 
 LEFT JOIN TBLGNUSU (NOLOCK) D ON (D.UPDUSU = A.UPDUSU AND D.REGATV = 1)]]>
				</query>
				<parameters>
					<parameter input="true" desc ="ID do Cadastro" name="CODGER" type="System.Int32" default="null" output="" null="true"/>
				</parameters>
			</item>
		</selectallcommand>
		<methods>

			<item script="true" alias="A." sql="" method="LoginExist" return="int" returnmode="2" procname="PRLGNUSUVALLGN" desc ="Verifica se o Login já existe para outro cadastro do tipo de atributo" returnvalue="0">
				<query>
					<![CDATA[
DECLARE @RETURN_VALUE INT =0;
DECLARE @REGATV TINYINT =0

BEGIN
	SELECT @RETURN_VALUE = NIDLOG FROM TBLGNUSU (NOLOCK) WHERE CODGER <> @CODGER AND LGNUSU = @LGNUSU
END
IF(@RETURN_VALUE IS NULL)
   SET @RETURN_VALUE=0;
SELECT @RETURN_VALUE AS RETURN_VALUE
          ]]>
				</query>
				<parameters>
					<parameter input="true" desc ="Código do Usuário" name="CODGER" sysnull="true" type="int" default="" output="" null="true"/>
					<parameter input="true" desc ="Login do Usuário" name="LGNUSU" size="50" type="System.String" default="" output="" null="false"/>
				</parameters>
			</item>

			<item script="true" alias="A." sql="" method="Login" audit="false" responsemode="1" return="ExecutionResponse" returnmode="2" procname="PRLGNUSULGN" desc ="Executa o Login de um usuário" returnvalue="0">
				<query>
					<![CDATA[
DECLARE @RETURN_VALUE INT = 0
DECLARE @CODGER INT =0;
DECLARE @ULTACE DATETIME = GETDATE()
IF(@PSWUSU IS NULL OR @PSWUSU='')
   SET @RETURN_VALUE = -1
IF(@RETURN_VALUE=0)
	BEGIN
		IF(@LGNUSU IS NULL OR @LGNUSU='')
			SET @RETURN_VALUE = -2
	END

IF(@RETURN_VALUE=0)
	BEGIN
		IF(@LGNTYP IS NULL OR @LGNTYP<>1)
			SET @RETURN_VALUE = -3
	END
   
IF(@RETURN_VALUE=0)
	BEGIN
	    IF(EXISTS(SELECT 1 FROM TBLGNUSU (NOLOCK) WHERE LGNUSU = @LGNUSU AND PSWUSU=@PSWUSU AND REGATV=1 AND STAREC=1))
			SELECT @RETURN_VALUE = NIDLOG, @CODGER = CODGER FROM TBLGNUSU WHERE LGNUSU = @LGNUSU AND PSWUSU=@PSWUSU AND REGATV=1 AND STAREC=1
		ELSE
		    SET @RETURN_VALUE = -4
    END
	
	
IF(@RETURN_VALUE>0)
   BEGIN
		UPDATE TBCADGER SET ULTACE = @ULTACE WHERE CODGER = @CODGER
		UPDATE TBLGNUSU SET ULTACE = @ULTACE WHERE NIDLOG=@RETURN_VALUE;
   END
RETURN @RETURN_VALUE;
          ]]>
				</query>
				<parameters>
					<parameter input="true" desc ="Tipo de Login" name="LGNTYP" type="System.Byte" default="" output="" null="false"/>
					<parameter input="true" desc ="Login do Usuário" name="LGNUSU" size="50" type="System.String" default="" output="" null="false"/>
					<parameter input="true" desc ="Código do Usuário" name="PSWUSU" size="255"  type="System.String" default="" output="" null="false"/>
				</parameters>

				<returns>
					<return operator=">" value="0" message="Login efetuado com sucessoo" error="OK"/>
					<return value="-1" message="" error="PASSWORDEMPTY"/>
					<return value="-2" message="" error="LOGINBLANK"/>
					<return value="-3" message="O Tipo de Acesso é inválido" error="INVALID_LOGIN"/>
					<return value="-4" message="" error="LOGINNOTFOUND"/>
				</returns>
			</item>


			<item script="true" alias="A." sql="" method="Logoff" return="int" returnmode="2" procname="PRCADUSULOGOUT" desc ="Executa o Logoff de um usuário" returnvalue="0">
				<query>
					<![CDATA[
DECLARE @RETURN_VALUE INT = 0;
UPDATE TBCADUSU SET ULTLOG = GETDATE() WHERE CODUSU = @CODUSU;
IF(@@ERROR=0 AND @@ROWCOUNT>0)
	BEGIN
		INSERT INTO [dbo].[TBAUDDAT]
			   ([AUDDAT]
			   ,[AUDKEY]
			   ,[AUDIDR]
			   ,[AUDIMS]
			   ,[AUDOBJ]
			   ,[AUDSRC]
			   ,[AUDCHG]
			   ,[NUMIPA]
			   ,[UPDUSU])
		 VALUES
			   (GETDATE()
			   ,1
			   ,@CODUSU
			   ,1
			   ,OBJECT_NAME(@@PROCID)
			   ,''
			   ,'EXECUTOU LOGOUT DE APLICATIVO'
			   ,''
			   ,@CODUSU);

					  
		IF(@@ERROR=0)
			SET @RETURN_VALUE = 1
	END


          ]]>
				</query>

				<parameters>
					<parameter input="true" apply="true" desc ="ID do Usuário" name="CODUSU" type="int" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Localizacao" name="NUMIPA" type="System.String" size="255" default="" output="" null="false"/>

				</parameters>
			</item>


		</methods>

	</item>

	<item create="true"  id="1" name="TBAUDDAT" friendlyname="Audit" modelversion="3" descriptor="Tabela de Auditoria">

		<listselect></listselect>
		<CSharpPartial>true</CSharpPartial>
		<SqlTable></SqlTable>

		<insertcommand key="Identity" exceptionparamns="'AUDDAT'" procname="">
			<maxfield field=""/>
			<nextnumber field="" id="" />
			<pre>
				<![CDATA[

      ]]>
			</pre>
			<body></body>
			<pos>
				<![CDATA[
  
      ]]>
			</pos>
			<returns>
				<return operator=">" value="0" message="Registro inserido com sucesso" error="OK"/>
				<return value="-1" message="" error="FAILALL"/>
			</returns>
		</insertcommand>
	</item>

	<item create="true"  id="2" name="TBTABGER" friendlyname="GeneralTable" modelversion="3" descriptor="Tabela Geral do Sistema">
		<CSharpPartial>False</CSharpPartial>
		<SqlTable></SqlTable>


		<objectclass>
			<item script="true" alias="A." sql="" method="GeneralTables" return="int" returnmode="1" procname="" desc ="Objeto de Retenção de Informações da Tabela Geral" returnvalue="1">
				<query>
					<![CDATA[
SELECT A.NIDTAB,A.CODTAB,A.KEYCOD,KEYTXT = ISNULL(A.KEYTXT,''),A.NUMREF,A.DSCTAB,A.USRDSP,A.IDEPRE,A.STAREC,ISNULL(B.DSCTAB,'') DSCREC,A.DATCAD,A.DATUPD,A.UPDUSU,LGNUSU =  ISNULL(C.LGNUSU,'')
  FROM TBTABGER (NOLOCK) A
 INNER JOIN TBTABGER (NOLOCK) B ON (B.CODTAB = 7 AND B.KEYCOD = A.STAREC)
  LEFT JOIN TBLGNUSU (NOLOCK) C ON (C.CODGER = A.UPDUSU  AND C.REGATV=1)     
        ]]>
				</query>
			</item>
		</objectclass>

		<insertcommand script="true" key="Identity" exceptionparamns="'DATCAD','DATUPD'" procname="PRTABGERINS" fieldreturn="NIDTAB">
			<maxfield field=""/>
			<nextnumber field="" id="" />
			<pre></pre>
			<body></body>
			<pos></pos>
			<returns>
				<return operator=">" value="0" message="Registro inserido com sucesso" error="OK"/>
				<return value="-1" message="" error="FAILALL"/>
			</returns>
		</insertcommand>
		<updatecommand script="true" key="Identity" exceptionparamns="'DATCAD'" procname="PRTABGERUPD" fieldreturn="NIDTAB">
			<maxfield field=""/>
			<nextnumber field="" id="" />
			<pre>
			</pre>
			<body></body>
			<pos></pos>
			<returns>
				<return operator=">" value="0" message="Registro alterado com sucesso" error="OK"/>
				<return value="-1" message="" error="FAILALL"/>
			</returns>
		</updatecommand>
		<selectcommand>
			<item script="true" alias="A." sql="" method="Select" return="GeneralTable" procname="PRTABGERSEL" desc ="Seleciona o registro de acordo com o id de registro da tabela geral">
				<query>
					<![CDATA[SELECT * FROM TBTABGER (nolock) A]]>
				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="ID de Registro da Tabela" name="NIDTAB" type="int" default="" output="" null="false"/>
				</parameters>
			</item>
		</selectcommand>
		<methods>
			<item script="true" alias="A." sql="" method="FindKey" return="int" returnmode="12" procname="PRTABGERFNDKEY" desc ="Localiza uma chave de registro com base no codigo chave" returnvalue="0">
				<query merge="true">
					<![CDATA[DECLARE @RETURN_VALUE INT=0;
					SELECT @RETURN_VALUE = COALESCE(ISNULL(NIDTAB,0),0) FROM TBTABGER (NOLOCK) A WHERE CODTAB = @CODTAB AND KEYCOD = @KEYCOD AND STAREC=1
					SET @RETURN_VALUE = ISNULL(@RETURN_VALUE,0)
					SELECT @RETURN_VALUE AS RETURN_VALUE]]>
				</query>
				<parameters>
					<parameter input="true" apply="false" desc ="Código do Tabela" name="CODTAB" type="int" default="" output="" null="false"/>
					<parameter input="true" apply="false" desc ="Código Numérico da Chave" name="KEYCOD" type="int" default="" output="" null="false"/>
				</parameters>
			</item>
			<item script="true" alias="A." sql="" method="FindKeyText" return="int" returnmode="12" procname="PRTABGERFNDTXT" desc ="Localiza uma chave de registro com base no texto chave" returnvalue="0">
				<query merge="true">
					<![CDATA[DECLARE @RETURN_VALUE INT =0;
					SELECT @RETURN_VALUE = COALESCE(ISNULL(NIDTAB,0),0)  FROM TBTABGER (NOLOCK) A WHERE CODTAB=@CODTAB AND KEYTXT=@KEYTXT AND STAREC=1;
					SET @RETURN_VALUE = ISNULL(@RETURN_VALUE,0)
					SELECT @RETURN_VALUE AS RETURN_VALUE]]>
				</query>
				<parameters>
					<parameter input="true" apply="false" desc ="Código do Tabela" name="CODTAB" type="int" default="" output="" null="false"/>
					<parameter input="true" apply="false" desc ="Código Texto da Chave" name="KEYTXT" type="System.String" size="10" default="" output="" null="false"/>
				</parameters>
			</item>
		</methods>
		<selectallcommand>
			<item script="true" alias="A." sql="" type="List" method="SelectAll" return="GeneralTable" procname="PRTABGERSELALL" desc ="Obtêm todos os registros de uma tabela específica do sistema" remarks="O Código de Tabela 0 define todas as tabelas existentes no sistema">
				<query order="A.CODTAB, A.KEYCOD">
					<![CDATA[
SELECT A.NIDTAB,A.CODTAB,A.KEYCOD,KEYTXT = ISNULL(A.KEYTXT,''),A.NUMREF,A.DSCTAB,A.USRDSP,A.IDEPRE,A.STAREC,ISNULL(B.DSCTAB,'') DSCREC,A.DATCAD,A.DATUPD,A.UPDUSU,LGNUSU =  ISNULL(C.LGNUSU,'')
  FROM TBTABGER (NOLOCK) A
 INNER JOIN TBTABGER (NOLOCK) B ON (B.CODTAB = 7 AND B.KEYCOD = A.STAREC)
  LEFT JOIN TBLGNUSU (NOLOCK) C ON (C.CODGER = A.UPDUSU  AND C.REGATV=1)          
          ]]>
				</query>
				<parameters>
					<parameter input="true" desc ="Número da Tabela" name="CODTAB" sysnull="true" type="System.Int32" default="" output="" null="true"/>
				</parameters>
			</item>
		</selectallcommand>
	</item>

	<item create="true"  id="18" name="RFCODATR" friendlyname="Attributes" modelversion="3" descriptor ="Atributos do Cadastro Geral">
		<CSharpPartial>False</CSharpPartial>
		<SqlTable></SqlTable>

		<extendedmodel>
			<![CDATA[SELECT ATR.CODATR
      ,DSCATR
      ,ATR.HASLOG
      ,ATR.STAREC
	  ,STA.DSCREC
      ,ATR.DATCAD
      ,ATR.DATUPD
      ,ATR.UPDUSU
	  ,LGNUSU = ISNULL(LGN.LGNUSU,'')
  FROM RFCODATR (NOLOCK) ATR
 INNER JOIN TBSTAREC (NOLOCK) STA ON (STA.STAREC = ATR.STAREC)
  LEFT JOIN TBCADUSU (NOLOCK) LGN ON (LGN.CODUSU = ATR.UPDUSU)
 WHERE ATR.CODATR=-1]]>
		</extendedmodel>

		<insertcommand key="Key" exceptionparamns="'DATCAD','DATUPD'" procname="PRCODATRINS" method="Insert">
			<maxfield field="CODATR"/>
			<nextnumber field="" id="" />
			<pre><![CDATA[
IF(EXISTS(SELECT 1 FROM RFCODATR (NOLOCK) WHERE CODATR = @CODATR))
   SET @RETURN_VALUE = -2;
			
			]]></pre>
			<body></body>
			<pos>
				<![CDATA[
				
IF(@RETURN_VALUE = -2)
	BEGIN
		UPDATE dbo.RFCODATR
		   SET CODATR = @CODATR
			  ,DSCATR = @DSCATR
			  ,HASLOG = @HASLOG
			  ,STAREC = @STAREC
			  ,DATUPD = GETDATE()
			  ,UPDUSU = @UPDUSU
		 WHERE CODATR = @CODATR;
			IF(@@ERROR=0)
			   SET @RETURN_VALUE=2;
	
	END
				]]>
			</pos>
			<returns>
				<return operator="==" value="1" message="Registro inserido com sucesso" error="OK"/>
				<return operator="==" value="2" message="Registro alterado com sucesso" error="OK"/>
				<return value="-1" message="" error="FAILALL"/>
			</returns>
		</insertcommand>

		<selectcommand>
			<item script="false" alias="A." sql="" method="Select" return="Attributes" procname="" desc ="Obtêm o registro de atributo de acordo com o código do atributo">
				<query>
					<![CDATA[SELECT * FROM RFCODATR (NOLOCK) A]]>
				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="Código do Atributo" alias="" name="CODATR" type="System.Byte" default="" output="" null="false"/>
				</parameters>
			</item>
		</selectcommand>
		<selectallcommand>
			<item script="false" alias="A." sql="" type="List" method="SelectAll" return="Attributes" procname="" desc ="Obtêm todos os registros de atributos cadastrados">
				<query>
					<![CDATA[SELECT ATR.CODATR
      ,DSCATR
      ,ATR.HASLOG
      ,ATR.STAREC
	  ,STA.DSCREC
      ,ATR.DATCAD
      ,ATR.DATUPD
      ,ATR.UPDUSU
	  ,LGNUSU = ISNULL(LGN.LGNUSU,'')
  FROM RFCODATR (NOLOCK) ATR
 INNER JOIN TBSTAREC (NOLOCK) STA ON (STA.STAREC = ATR.STAREC)
  LEFT JOIN TBCADUSU (NOLOCK) LGN ON (LGN.CODUSU = ATR.UPDUSU)

]]>
				</query>
			</item>
		</selectallcommand>
	</item>


	<item create="true"  id="1" name="TBCADGER" friendlyname="GeneralRegister" modelversion="3" descriptor="Cadastro Geral">
		<CSharpPartial>True</CSharpPartial>
		<SqlTable>
		</SqlTable>



		<view>
			<item owner="dbo" script="true" name="VWCADGERPSQBAS" desc ="View de Informações integradas do Cadastro Geral">
				<query>
					<![CDATA[SELECT A.CODGER
      ,A.NIDEXT
      ,A.CODATR
	  ,J.DSCATR
      ,dbo.FORMATCMF(A.CODCMF,A.TYPCMF) AS CODCMF
	  ,A.TYPCMF
      ,A.CODGEN
	  ,DSCGEN = ISNULL(H.DSCTAB,'')
      ,A.CODPJU
	  ,DSCPJU = ISNULL(I.DSCTAB,'')
      ,A.ATRPPE
      ,A.CODNAC
	  ,DSCNAC = ISNULL(G.DSCTAB,'')
      ,A.RAZSOC
      ,A.NOMFAN
      ,A.CODREF
      ,A.ACEESP
      ,A.DATNAC
      ,A.ULTACE
      ,A.STAREC
	  ,DSCREC = ISNULL(E.DSCTAB,'')
      ,A.DATCAD
      ,A.DATUPD
      ,A.UPDUSU
	  ,LGNSU = ISNULL(F.LGNUSU,'')
	  ,ENDCNT = ISNULL(B.NUMERO,0)
	  ,CTOCNT = ISNULL(C.NUMERO,0)
	   ,RSPCNT = ISNULL(D.NUMERO,0)
	   ,HASREF = CAST( ISNULL(K.CODGER,0) AS BIT )
	   ,NUMIRG = ISNULL(K.NUMIRG,'')
	   ,ORGIRG = ISNULL(K.ORGIRG,'')
	   ,UFEIRG = ISNULL(K.UFEIRG,'')
	   ,DATIRG = FORMAT (K.DATIRG, 'd', 'pt-BR') 
	   ,NUMCRV = CONVERT(VARCHAR,ISNULL(K.NUMCRV,'')) + ISNULL(K.UFECRV,'')
	   ,NOMCON = ISNULL(K.NOMCON,'')
	   ,DSCECV = ISNULL(L.DSCTAB,'')
FROM TBCADGER (NOLOCK) A
LEFT JOIN (SELECT CODGER, COUNT(*) AS NUMERO FROM TBCADEND (NOLOCK) WHERE STAREC=1  GROUP BY CODGER) B ON (B.CODGER = A.CODGER)
LEFT JOIN (SELECT CODGER, COUNT(*) AS NUMERO FROM TBCADCTO (NOLOCK) WHERE STAREC=1  GROUP BY CODGER) C ON (C.CODGER = A.CODGER)
LEFT JOIN (SELECT CODREF, COUNT(*) AS NUMERO FROM TBCADGER (NOLOCK) WHERE CODATR = 7 AND STAREC=1  GROUP BY CODREF) D ON (D.CODREF = A.CODGER)
INNER JOIN TBTABGER (NOLOCK) E ON (E.CODTAB = 7 AND E.KEYCOD = A.STAREC)
LEFT JOIN TBLGNUSU (NOLOCK) F ON (F.CODGER = A.UPDUSU AND F.REGATV=1)
LEFT JOIN TBTABGER (NOLOCK) G ON (G.CODTAB = 112 AND G.KEYCOD = A.CODNAC)
LEFT JOIN TBTABGER (NOLOCK) H ON (H.CODTAB = 13 AND H.KEYCOD = A.CODGEN)
LEFT JOIN TBTABGER (NOLOCK) I ON (I.CODTAB = 9 AND I.KEYCOD = A.CODPJU)
INNER JOIN TBTIPATR (NOLOCK) J ON (J.CODATR = A.CODATR)
LEFT JOIN TBREFGER (NOLOCK) K ON (K.CODGER = A.CODGER)
LEFT JOIN TBTABGER (NOLOCK) L ON (L.CODTAB=76 AND L.KEYCOD = K.CODECV)
WHERE K.STAREC IS NULL OR K.STAREC=1

        ]]>
				</query>
			</item>
		</view>


		<objectclass>
			<item script="true" alias="A." sql="" method="GeneralRegisters" return="int" returnmode="1" procname="" desc ="Objeto de Retenção de Informações do Cadastro Geral" returnvalue="1">
				<query>
					<![CDATA[SELECT * FROM VWCADGERPSQBAS A WHERE A.CODGER=-1]]>
				</query>
			</item>
		</objectclass>

		<insertcommand key="Key" fieldreturn="" exceptionparamns="'DATCAD','DATUPD'" procname="PRCADGETINS">
			<maxfield field="NIDGER"/>
			<nextnumber field="" id="" />
			<pre>
				<![CDATA[
IF(@CODATR<=0)
	SET @RETURN_VALUE =-1;	

IF(@RETURN_VALUE=0)
   BEGIN
		IF(@CODCMF IS NULL OR @CODCMF = '')
			SET @RETURN_VALUE =-2;	
   END
IF(@RETURN_VALUE=0)
   BEGIN
		IF(@RAZSOC IS NULL OR @RAZSOC= '')
			SET @RETURN_VALUE =-3;	
   END
   
IF(@RETURN_VALUE=0)
	BEGIN
		IF(@NOMFAN IS NULL OR @NOMFAN= '')
			SET @NOMFAN=N'';	
	END
	
	
			]]>
			</pre>
			<body></body>
			<pos>
			</pos>
			<returns>
				<return operator=">" value="0" message="Registro inserido com sucesso" error="OK"/>
				<return value="-1" message="Código de Atributo inválido" error="FAILALL"/>
				<return value="-2" message="O CPF/CNPJ/RNE é inválido ou não foi fornecido" error="FAILALL"/>
				<return value="-3" message="O Nome ou Razão Social deverá ser informado" error="FAILALL"/>
			</returns>
		</insertcommand>

		<selectcommand>
			<item script="true" alias="A." sql="" method="Select" return="GeneralRegister" procname="" desc ="Seleciona o registro de acordo com o Código do Usuário">
				<query>
					<![CDATA[SELECT * FROM TBCADGER (NOLOCK) A ]]>
				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="ID de Registro" name="NIDGER" type="int" default="" output="" null="false"/>
				</parameters>
			</item>
			<item script="true" alias="A." sql="" method="Select" return="GeneralRegister" procname="" desc ="Seleciona o registro de acordo com o Código do Usuário">
				<query>
					<![CDATA[SELECT * FROM TBCADGER (NOLOCK) A ]]>
				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="Código do Atributo" name="CODATR" type="System.Byte" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Código CMF" name="CODCMF" type="System.String" default="" output="" null="false"/>

				</parameters>
			</item>
			<item script="false" alias="A." sql="" method="GetDefaultLoginName" return="string" procname="" desc ="Obtêm um nome de login  padrão">
				<query>
					<![CDATA[SELECT dbo.GetLoginName(@RAZSOC)]]>
				</query>
				<parameters>
					<parameter input="true" apply="false" desc ="Nome do Usuário" name="RAZSOC" type="string" size="70" default="" output="" null="false"/>
				</parameters>
			</item>
		</selectcommand>

		<!--<selectallcommand>
			<item script="true" alias="A." sql="" type="List" method="SelectAll" return="GeneralRegisters" procname="PRCADGERSELALL" desc ="Obtêm uma lista de todos os registros do cadastro geral">
				<query>
					<![CDATA[SELECT * FROM VWCADGERPSQBAS A]]>
				</query>
				<parameters>
					<parameter input="true" desc ="Código do Atributo" name="CODATR" type="System.Byte"  output="" null="false"/>
				</parameters>
			</item>
		</selectallcommand>-->
		<methods>
			<item script="true" alias="A." sql="" method="LocateCMF" return="int" returnmode="2" procname="PRCADGERLOCCMF" desc ="Verifica se existe um registro cadastrado atraves do CODCMF e CODATR, independente do status do registro, se existir retorna o CODGER do registro" returnvalue="0" remarks="Retorna o ID do Registro, -1 indica se que não existe">
				<query merge="true">
					<![CDATA[
DECLARE @RETURN_VALUE INT = 0
IF(EXISTS(SELECT 1 FROM TBCADGER (NOLOCK) A  WHERE A.CODATR = @CODATR AND  A.CODCMF = @CODCMF  ))
    SELECT TOP 1 @RETURN_VALUE = NIDGER FROM TBCADGER (NOLOCK) A WHERE A.CODATR = @CODATR AND  A.CODCMF = @CODCMF ORDER BY DATCAD;
ELSE
    SET @RETURN_VALUE = -1;
IF(@RETURN_VALUE IS NULL)
   SET @RETURN_VALUE = -1;
SELECT @RETURN_VALUE AS RETURN_VALUE;
          ]]>
				</query>
				<parameters>
					<parameter input="true" apply="false" desc ="Código do CMF" name="CODCMF" type="System.String" size="15" default="" output="" null="false"/>
					<parameter input="true" apply="false" desc ="Código do Atributo" name="CODATR" type="int" default="1" output="" null="false"/>
				</parameters>
			</item>
		</methods>

	</item>


	<item create="true"  id="4" name="TBCADCLI" friendlyname="Tutors" modelversion="3" descriptor="Cadastro de Tutores">
		<CSharpPartial>true</CSharpPartial>
		<SqlTable></SqlTable>
		<extendedmodel>
			<![CDATA[SELECT CLI.CODCLI
      ,CLI.CODATR
      ,CLI.CODCMF
      ,CLI.TYPCMF
	  ,TYP.DSCTYP
      ,CLI.CODREF
      ,CLI.RAZSOC
      ,CLI.NOMFAN
      ,CLI.CODGEN
	  ,GEN.DSCGEN
      ,CLI.CODIND
	  ,IND.DSCIND
      ,CLI.DATNAC
      ,CLI.ENVNEW
      ,CLI.OBSCLI
      ,CLI.STAREC
	  ,STA.DSCREC
      ,CLI.DATCAD
      ,CLI.DATUPD
      ,CLI.UPDUSU
	  ,LGNUSU = ISNULL(LGN.LGNUSU,'')
	  ,CNTANI = ISNULL(ANI.NUMREC,0)
  FROM TBCADCLI (NOLOCK) CLI
 INNER JOIN RFTYPCMF (NOLOCK) TYP ON (TYP.TYPCMF = CLI.TYPCMF)
 INNER JOIN RFCODGEN (NOLOCK) GEN ON (GEN.CODGEN = CLI.CODGEN)
 INNER JOIN RFCODIND (NOLOCK) IND ON (IND.CODIND = CLI.CODIND)
 INNER JOIN TBSTAREC (NOLOCK) STA ON (STA.STAREC = CLI.STAREC)
  LEFT JOIN TBCADUSU (NOLOCK) LGN ON (LGN.CODUSU = CLI.UPDUSU)
  LEFT JOIN (SELECT CODCLI, COUNT(*) AS NUMREC FROM TBCADANI (NOLOCK) WHERE STAREC =1 AND HASFAL=0 GROUP BY CODCLI) ANI ON (ANI.CODCLI = CLI.CODCLI)
  WHERE CLI.CODCLI=-1]]>
		</extendedmodel>



		<insertcommand key="Key" exceptionparamns="'DATCAD','DATUPD'" procname="PRCADCLIINS" method="Insert">
			<maxfield field="CODCLI"/>
			<nextnumber field="" id="" />
			<pre>
				<![CDATA[

IF(EXISTS(SELECT 1 FROM TBCADCLI (NOLOCK) WHERE CODCMF = @CODCMF AND CODATR = @CODATR ))
   SET @RETURN_VALUE = -2;
      ]]>


			</pre>
			<body></body>
			<pos>
				<![CDATA[
				
IF(@RETURN_VALUE = -2)
	BEGIN
		UPDATE TBCADCLI
		   SET TYPCMF = @TYPCMF
			  ,CODREF = @CODREF
			  ,RAZSOC = @RAZSOC
			  ,NOMFAN = @NOMFAN
			  ,CODGEN = @CODGEN
			  ,CODIND = @CODIND
			  ,DATNAC = @DATNAC
			  ,ENVNEW = @ENVNEW
			  ,OBSCLI = @OBSCLI
			  ,STAREC = @STAREC
			  ,DATUPD = GETDATE()
			  ,UPDUSU = @UPDUSU
		 WHERE CODCMF = @CODCMF AND CODATR = @CODATR
		 
		    IF (@@ERROR =0)
			   SET @RETURN_VALUE = 2;
	END
      ]]>
			</pos>
			<returns>
				<return operator="==" value="1" message="Registro inserido com sucesso" error="OK"/>
				<return operator="==" value="2" message="Registro alterado com sucesso" error="OK"/>

				<return value="-1" message="" error="FAILALL"/>
			</returns>
		</insertcommand>

		<selectcommand>
			<item script="false" alias="A." sql="" method="Select" return="Tutors" procname="" desc ="Obtêm o registro de tutor conforme o id especificado">
				<query>
					<![CDATA[SELECT * FROM TBCADCLI (NOLOCK) A]]>
				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="Código do Tutor" name="CODCLI" type="int" default="" output="" null="false"/>
				</parameters>
			</item>
		</selectcommand>
		<selectallcommand>
			<item script="true" alias="A." sql="" method="SelectAll" type="List" return="Tutors" procname="PRCADCLISELALL" desc ="Obtêm uma lista de tutores conforme os parâmetros informados">
				<query>
					<![CDATA[
SELECT CLI.CODCLI
      ,CLI.CODATR
      ,CLI.CODCMF
      ,CLI.TYPCMF
	  ,TYP.DSCTYP
      ,CLI.CODREF
      ,CLI.RAZSOC
      ,CLI.NOMFAN
      ,CLI.CODGEN
	  ,GEN.DSCGEN
      ,CLI.CODIND
	  ,IND.DSCIND
      ,CLI.DATNAC
      ,CLI.ENVNEW
      ,CLI.OBSCLI
      ,CLI.STAREC
	  ,STA.DSCREC
      ,CLI.DATCAD
      ,CLI.DATUPD
      ,CLI.UPDUSU
	  ,LGNUSU = ISNULL(LGN.LGNUSU,'')
	  ,CNTANI = ISNULL(ANI.NUMREC,0)
  FROM TBCADCLI (NOLOCK) CLI
 INNER JOIN RFTYPCMF (NOLOCK) TYP ON (TYP.TYPCMF = CLI.TYPCMF)
 INNER JOIN RFCODGEN (NOLOCK) GEN ON (GEN.CODGEN = CLI.CODGEN)
 INNER JOIN RFCODIND (NOLOCK) IND ON (IND.CODIND = CLI.CODIND)
 INNER JOIN TBSTAREC (NOLOCK) STA ON (STA.STAREC = CLI.STAREC)
  LEFT JOIN TBCADUSU (NOLOCK) LGN ON (LGN.CODUSU = CLI.UPDUSU)
  LEFT JOIN (SELECT CODCLI, COUNT(*) AS NUMREC FROM TBCADANI (NOLOCK) WHERE STAREC =1 AND HASFAL=0 GROUP BY CODCLI) ANI ON (ANI.CODCLI = CLI.CODCLI)
  
 WHERE (@RAZSOC IS NULL OR CLI.RAZSOC LIKE @RAZSOC) AND (@CODCMF IS NULL OR CLI.CODCMF LIKE @CODCMF)
        ]]>
				</query>
				<parameters>
					<parameter input="true" desc ="Nome ou parte a procurar" omit="true" alias="CLI." islike="True" name="RAZSOC" type="System.String" size="70" default="" output="" null="false"/>
					<parameter input="true" desc ="Código CMF"               omit="true" alias="CLI." islike="True" name="CODCMF" type="System.String" size="15" default="" output="" null="false"/>
				</parameters>
			</item>
		</selectallcommand>
	</item>

	<item create="true"  id="4" name="TBCADRSP" friendlyname="Responsibles" modelversion="3" descriptor="Cadastro de Responsáveis">
		<CSharpPartial>true</CSharpPartial>
		<SqlTable></SqlTable>
		<extendedmodel>
			<![CDATA[SELECT CODRSP
      ,RSP.CODATR
	  ,RSP.CODCLI
      ,RSP.CODCMF
      ,RSP.TYPCMF
	  ,TYP.DSCTYP
      ,RSP.RAZSOC
      ,RSP.NOMFAN
      ,RSP.CODGEN
	  ,GEN.DSCGEN
	  ,RSP.CODREL
	  ,T942.DSCTAB AS DSCREL
      ,RSP.DATNAC
      ,RSP.ENVNEW
      ,RSP.OBSRSP
      ,RSP.STAREC
	  ,STA.DSCREC
      ,RSP.DATCAD
      ,RSP.DATUPD
      ,RSP.UPDUSU
	  ,LGNUSU = ISNULL(LGN.LGNUSU,'')
  FROM TBCADRSP (NOLOCK) RSP
 INNER JOIN TBCADCLI (NOLOCK) CLI ON (CLI.CODCLI = RSP.CODCLI AND CLI.CODATR = 1)
 INNER JOIN RFTYPCMF (NOLOCK) TYP ON (TYP.TYPCMF = RSP.TYPCMF)
 INNER JOIN RFCODGEN (NOLOCK) GEN ON (GEN.CODGEN = RSP.CODGEN)
 INNER JOIN TBSTAREC (NOLOCK) STA ON (STA.STAREC = RSP.STAREC)
  LEFT JOIN TBCADUSU (NOLOCK) LGN ON (LGN.CODUSU = RSP.UPDUSU)
 INNER JOIN TBTABGER (NOLOCK) T942 ON (T942.CODTAB = 942 AND T942.KEYCOD = RSP.CODREL) WHERE CODRSP=-1]]>
		</extendedmodel>

		<insertcommand key="Key" exceptionparamns="'DATCAD','DATUPD'" procname="PRCADRSPINS" method="Insert">
			<maxfield field="CODRSP"/>
			<nextnumber field="" id="" />
			<pre>
				<![CDATA[
IF(@CODCLI=0)
	SET @RETURN_VALUE = -3;

IF(@RETURN_VALUE=0)
	BEGIN
		IF(EXISTS(SELECT 1 FROM TBCADRSP (NOLOCK) WHERE CODCMF = @CODCMF AND CODATR = @CODATR AND CODCLI=@CODCLI ))
			SET @RETURN_VALUE = -2;
	END
	
      ]]>


			</pre>
			<body></body>
			<pos>
				<![CDATA[
				
IF(@RETURN_VALUE = -2)
	BEGIN
		UPDATE TBCADRSP
		   SET CODCMF = @CODCMF
			  ,TYPCMF = @TYPCMF
			  ,CODREL = @CODREL
			  ,RAZSOC = @RAZSOC
			  ,NOMFAN = @NOMFAN
			  ,CODGEN = @CODGEN
			  ,DATNAC = @DATNAC
			  ,ENVNEW = @ENVNEW
			  ,OBSRSP = @OBSRSP
			  ,STAREC = @STAREC
			  ,DATUPD = GETDATE()
			  ,UPDUSU = @UPDUSU
		 WHERE CODRSP = @CODRSP AND CODATR = @CODATR AND CODCLI = @CODCLI
		 
		    IF (@@ERROR =0)
			   SET @RETURN_VALUE = 2;
	END
      ]]>
			</pos>
			<returns>
				<return operator="==" value="1" message="Registro inserido com sucesso" error="OK"/>
				<return operator="==" value="2" message="Registro alterado com sucesso" error="OK"/>
				<return operator="==" value="-3" message="Não é possível registrar um responsável sem uma associação de tutor" error="FAILALL"/>

				<return value="-1" message="" error="FAILALL"/>
			</returns>
		</insertcommand>

		<selectcommand>
			<item script="false" alias="A." sql="" method="Select" return="Responsibles" procname="" desc ="Obtêm o registro de tutor conforme o id especificado">
				<query>
					<![CDATA[SELECT * FROM TBCADRSP (NOLOCK) A]]>
				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="Código do Responsável" name="CODRSP" type="int" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Atributo"              name="CODATR" type="System.Byte" default="6" output="" null="false"/>

				</parameters>
			</item>
		</selectcommand>
		<selectallcommand>
			<item script="false" alias="A." sql="" method="SelectAll" type="List" return="Responsibles" procname="" desc ="Obtêm uma lista de responsáveis conforme os parâmetros informados">
				<query>
					<![CDATA[
SELECT CODRSP
      ,RSP.CODATR
	  ,RSP.CODCLI
      ,RSP.CODCMF
      ,RSP.TYPCMF
	  ,TYP.DSCTYP
      ,RSP.RAZSOC
      ,RSP.NOMFAN
      ,RSP.CODGEN
	  ,GEN.DSCGEN
	  ,RSP.CODREL
	  ,T942.DSCTAB AS DSCREL
      ,RSP.DATNAC
      ,RSP.ENVNEW
      ,RSP.OBSRSP
      ,RSP.STAREC
	  ,STA.DSCREC
      ,RSP.DATCAD
      ,RSP.DATUPD
      ,RSP.UPDUSU
	  ,LGNUSU = ISNULL(LGN.LGNUSU,'')
  FROM TBCADRSP (NOLOCK) RSP
 INNER JOIN TBCADCLI (NOLOCK) CLI ON (CLI.CODCLI = RSP.CODCLI AND CLI.CODATR = 1)
 INNER JOIN RFTYPCMF (NOLOCK) TYP ON (TYP.TYPCMF = RSP.TYPCMF)
 INNER JOIN RFCODGEN (NOLOCK) GEN ON (GEN.CODGEN = RSP.CODGEN)
 INNER JOIN TBSTAREC (NOLOCK) STA ON (STA.STAREC = RSP.STAREC)
  LEFT JOIN TBCADUSU (NOLOCK) LGN ON (LGN.CODUSU = RSP.UPDUSU)
 INNER JOIN TBTABGER (NOLOCK) T942 ON (T942.CODTAB = 942 AND T942.KEYCOD = RSP.CODREL)
        ]]>
				</query>
				<parameters>
					<parameter input="true" desc ="Nome ou parte a procurar" alias="RSP."  islike="True" name="RAZSOC" type="System.String" size="70" default="" output="" null="false"/>
					<parameter input="true" desc ="Código CMF"               alias="RSP."  islike="True" name="CODCMF" type="System.String" size="15" default="" output="" null="false"/>
					<parameter input="true" desc ="Código CLiente"           alias="RSP."  name="CODCLI" type="System.Int32"     default="" output="" null="false"/>

				</parameters>
			</item>
		</selectallcommand>
	</item>


	<item create="true"  id="4" name="TBCADCTO" friendlyname="ContactBook" modelversion="3" descriptor="Tabela de Contatos">

		<CSharpPartial>true</CSharpPartial>
		<SqlTable></SqlTable>

		<view>
			<item owner="dbo" script="true" name="VWCADCTO" desc ="View de Informações de Contatos">
				<query>
					<![CDATA[
 SELECT CTO.*
        ,DSCATR
		,DSCCTT
		,PAI.CODDDI
		,PAI.DSCPAI
		,LGNUSU = ISNULL(LGN.LGNUSU,'')
		,DSCEND = ISNULL(ADR.DSCEND,'')
		,FULCTO = '+' + CONVERT(VARCHAR, PAI.CODDDI) + ' (' + CONVERT(VARCHAR,CTO.NUMDDD) + ') ' + CTO.NUMTEL
		,DSCREC = ISNULL(STA.DSCREC,'')
    FROM TBCADCTO (NOLOCK) CTO
   INNER JOIN RFCODATR (NOLOCK) ATR
      ON (ATR.CODATR = CTO.CODATR)
   INNER JOIN RFTIPCTT (NOLOCK) CTT
      ON (CTT.TIPCTT = CTO.TIPCTT)
   INNER JOIN RFCODPAI (NOLOCK) PAI
      ON (PAI.NIDPAI = CTO.CODPAI)
   INNER JOIN RFTELOPE (NOLOCK) OPR
      ON (OPR.NIDOPT = CTO.NIDOPT)
    LEFT JOIN TBCADUSU (NOLOCK) LGN
      ON (LGN.CODUSU = CTO.UPDUSU)
    LEFT JOIN TBCADEND (NOLOCK) ADR
      ON (ADR.NIDEND = CTO.NIDEND)
    LEFT JOIN TBSTAREC (NOLOCK) STA
      ON (STA.STAREC = CTO.STAREC)


        ]]>
				</query>
			</item>
		</view>

		<objectclass>
			<item script="true" alias="A." sql="" name="ContactList" return="int" returnmode="1" procname="" desc ="Objeto de Retenção de Informações de Contatos" returnvalue="1">
				<query>
					<![CDATA[
SELECT CTO.*
        ,DSCATR
		,DSCCTT
		,PAI.CODDDI
		,PAI.DSCPAI
		,LGNUSU = ISNULL(LGN.LGNUSU,'')
		,DSCEND = ISNULL(ADR.DSCEND,'')
		,FULCTO = '+' + CONVERT(VARCHAR, PAI.CODDDI) + ' (' + CONVERT(VARCHAR,CTO.NUMDDD) + ') ' + CTO.NUMTEL
		,DSCREC = ISNULL(STA.DSCREC,'')
    FROM TBCADCTO (NOLOCK) CTO
   INNER JOIN RFCODATR (NOLOCK) ATR
      ON (ATR.CODATR = CTO.CODATR)
   INNER JOIN RFTIPCTT (NOLOCK) CTT
      ON (CTT.TIPCTT = CTO.TIPCTT)
   INNER JOIN RFCODPAI (NOLOCK) PAI
      ON (PAI.NIDPAI = CTO.CODPAI)
   INNER JOIN RFTELOPE (NOLOCK) OPR
      ON (OPR.NIDOPT = CTO.NIDOPT)
    LEFT JOIN TBCADUSU (NOLOCK) LGN
      ON (LGN.CODUSU = CTO.UPDUSU)
    LEFT JOIN TBCADEND (NOLOCK) ADR
      ON (ADR.NIDEND = CTO.NIDEND)
    LEFT JOIN TBSTAREC (NOLOCK) STA
      ON (STA.STAREC = CTO.STAREC)

   WHERE NIDCTO = -1

        ]]>

				</query>
			</item>
		</objectclass>

		<insertcommand key="Identity" exceptionparamns="'DATCAD','DATUPD'" procname="PRCADCTOINS" method="Insert">
			<maxfield field=""/>
			<nextnumber field="" id="" />
			<pre>
				<![CDATA[
DECLARE @NIDCTO INT = 0;
IF(EXISTS(SELECT 1 FROM TBCADCTO (NOLOCK)
           WHERE NIDGER = @NIDGER
		     AND CODATR = @CODATR
			 AND TIPCTT = @TIPCTT
			 AND CODPAI = @CODPAI
		     AND NIDOPT = @NIDOPT
			 AND NUMDDD = @NUMDDD
			 AND NUMTEL = @NUMTEL))
	BEGIN
		SELECT @NIDCTO = ISNULL(NIDCTO,0) 
      FROM TBCADCTO (NOLOCK)    
      WHERE NIDGER = @NIDGER
		     AND CODATR = @CODATR
			 AND TIPCTT = @TIPCTT
			 AND CODPAI = @CODPAI
		     AND NIDOPT = @NIDOPT
			 AND NUMDDD = @NUMDDD
			 AND NUMTEL = @NUMTEL
	END
	
IF(@NIDCTO > 0)
  SET @RETURN_VALUE = -2;
  
      ]]>


			</pre>
			<body></body>
			<pos>
				<![CDATA[
				
IF(@RETURN_VALUE = -2)
	BEGIN
		UPDATE TBCADCTO
		   SET NIDEND = @NIDEND
			  ,NIDGER = @NIDGER
			  ,CODATR = @CODATR
			  ,TIPCTT = @TIPCTT
			  ,REGATV = @REGATV
			  ,CODPAI = @CODPAI
			  ,NIDOPT = @NIDOPT
			  ,ISWHAT = @ISWHAT
			  ,NUMDDD = @NUMDDD
			  ,NUMTEL = @NUMTEL
			  ,NUMRAM = @NUMRAM
			  ,OBSCTO = @OBSCTO
			  ,STAREC = @STAREC
			  ,DATUPD = GETDATE()
			  ,UPDUSU = @UPDUSU
		 WHERE NIDCTO = @NIDCTO
		 
		    IF(@@ERROR =0)
			   SET @RETURN_VALUE = @NIDCTO;
	END
ELSE
    SET @NIDCTO = @RETURN_VALUE;

 
IF(@RETURN_VALUE>0 AND @REGATV = 1)
            BEGIN
                UPDATE TBCADCTO 
                   SET REGATV = 0, DATUPD = GETDATE()
		         WHERE NIDGER = @NIDGER
				   AND CODATR = @CODATR
				   AND TIPCTT = @TIPCTT
				   AND CODPAI = @CODPAI
		           AND NIDCTO <> @RETURN_VALUE
                   AND STAREC = 1
                   AND @REGATV = 1
            END
      ]]>
			</pos>
			<returns>
				<return operator=">" value="0" message="Registro inserido com sucesso" error="OK"/>
				<return value="-1" message="" error="FAILALL"/>
			</returns>
		</insertcommand>

		<selectcommand>
			<item script="true" alias="A." sql="" method="Select" return="ContactBook" procname="PRCADCTOSEL" desc ="Seleciona o registro de acordo com o código do cadastro de contatos">
				<query>
					<![CDATA[SELECT * FROM TBCADCTO (nolock) A]]>
				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="ID do Registro de Contato" name="NIDCTO" type="int" default="" output="" null="false"/>
				</parameters>
			</item>

			<item script="true" alias="A." sql="" method="Select" return="ContactBook" procname="PRCADCTOSELCTO" desc ="Obtêm o registro de contato de acordo com os parâmetros informados">
				<query>
					<![CDATA[SELECT * FROM TBCADCTO (NOLOCK) A]]>
				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="ID do Cadastro" name="NIDGER" type="int" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Código do Atributo" name="CODATR" type="System.Int16" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Tipo de Contato" name="TIPCTT" type="System.Byte" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Registro Ativo" name="REGATV" type="System.Byte" default="1" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Status de Registro" name="STAREC" type="System.Byte" default="1" output="" null="false"/>
				</parameters>
			</item>

		</selectcommand>
		<selectallcommand>
			<item script="true" alias="A." sql="" method="SelectAll" type="List" return="ContactList" procname="PRCADCTOSELALL" desc ="Seleciona todos os registros de contato do usuário fornecido">
				<query>
					<![CDATA[
SELECT * FROM VWCADCTO A
        ]]>
				</query>
				<parameters>
					<parameter input="true" desc ="Código de Referência"  name="NIDGER" type="System.Int32" default="" output="" null="false"/>
					<parameter input="true" desc ="Atributo"  name="CODATR" type="System.Byte" default="" output="" null="false"/>
				</parameters>
			</item>
		</selectallcommand>
		<methods>
			<item script="true" alias="A." sql="" method="Find" return="int" returnmode="5" procname="PRCADCTOFIN" desc ="Localiza um contato com base nos parâmetros fornecidos" returnvalue="0">
				<query>
					<![CDATA[
DECLARE @RETURN_VALUE INT = 0

IF(EXISTS(SELECT 1 FROM TBCADCTO (NOLOCK)
           WHERE NIDGER = @NIDGER
		     AND CODATR = @CODATR
			 AND TIPCTT = @TIPCTT
			 AND CODPAI = @CODPAI
		     AND NIDOPT = @NIDOPT
			 AND NUMDDD = @NUMDDD
			 AND NUMTEL = @NUMTEL))
	BEGIN
		SELECT @RETURN_VALUE = ISNULL(NIDCTO,0) 
      FROM TBCADCTO (NOLOCK)    
      WHERE NIDGER = @NIDGER
		     AND CODATR = @CODATR
			 AND TIPCTT = @TIPCTT
			 AND CODPAI = @CODPAI
		     AND NIDOPT = @NIDOPT
			 AND NUMDDD = @NUMDDD
			 AND NUMTEL = @NUMTEL
	END
	
RETURN @RETURN_VALUE;          
          ]]>
				</query>
				<parameters>
					<parameter input="true" desc ="Código de Referência"  name="NIDGER" type="System.Int32" default="" output="" null="false"/>
					<parameter input="true" desc ="Atributo"  name="CODATR" type="System.Byte" default="" output="" null="false"/>

					<parameter input="true" desc ="Código do País" name="CODPAI" type="System.Int16" default="" output="" null="false"/>
					<parameter input="true" desc ="Código da Operadora" name="NIDOPT" type="System.Int16" default="" output="" null="false"/>
					<parameter input="true" desc ="Número do DDD" name="NUMDDD" type="System.Int16" size="4" default="" output="" null="false"/>
					<parameter input="true" desc ="Telefone" name="NUMTEL" type="System.String" size="15" default="" output="" null="false"/>
					<parameter input="true" desc ="Tipo de Contato" name="TIPCTT" type="System.Int32" default="" output="" null="false"/>

				</parameters>
			</item>
			<!--<item script="true" alias="A." sql="" method="Find" return="int" returnmode="2" procname="PRCADCTOFINBAS" desc ="Localiza um contato com base nos parâmetros fornecidos" returnvalue="0">
				<query>
					<![CDATA[
DECLARE @RETURN_VALUE INT = 0
 SELECT @RETURN_VALUE = COALESCE(CODCTO,0) 
   FROM TBCADCTO (NOLOCK) 
  WHERE STAREC=1
	  AND CODGER = @CODGER  
	  AND CODEND = @CODEND
	  AND TIPCTO = @TIPCTO
	  AND REGATV = @REGATV    
	SELECT @RETURN_VALUE          
          ]]>
				</query>
				<parameters>
					<parameter input="true" desc ="Código de Referência"  name="NIDGER" type="System.Int32" default="" output="" null="false"/>
					<parameter input="true" desc ="Atributo"  name="CODATR" type="System.Byte" default="" output="" null="false"/>


					<parameter input="true" desc ="ID do Cadastro" name="CODGER" type="System.Int32" default="" output="" null="false"/>
					<parameter input="true" desc ="Código do Endereço" name="CODEND" type="System.Int32" default="" output="" null="false"/>
					<parameter input="true" desc ="Tipo de Contato" name="TIPCTO" type="System.Int32" default="" output="" null="false"/>
					<parameter input="true" desc ="Indicador de Atividade do Registro" name="REGATV" type="System.Byte" default="" output="" null="false"/>
					<parameter input="true" desc ="Usuário de Atribuição" name="USUATR" type="System.Int32" default="" output="" null="false"/>
				</parameters>
			</item>-->

		</methods>
	</item>
	<item create="true"  id="5" name="TBCADEND" friendlyname="AddressBook" modelversion="3" descriptor="Cadastro de Endereços">

		<CSharpPartial>true</CSharpPartial>
		<SqlTable></SqlTable>

		<view>
			<item owner="dbo" script="true" name="VWCADEND" desc ="View de Informações de Endereços">
				<query>
					<![CDATA[
SELECT ADR.NIDEND
      ,ADR.NIDGER
	  ,ADR.CODATR
	  ,ADR.REGATV
	  ,ADR.TIPEND
	  ,ADR.TIPLOG
	  ,ADR.CODPAI
	  ,ADR.HASCEP
	  ,ADR.CODCEP
	  ,ADR.NUMEND
	  ,ADR.DSCEND
	  ,ADR.DSCCPL
	  ,ADR.DSCCID
	  ,ADR.DSCBAI
	  ,ADR.CODUFE
	  ,ADR.STAREC
	  ,ADR.DATCAD
	  ,ADR.DATUPD
	  ,ADR.UPDUSU
	  ,ATR.DSCATR
	  ,TEN.DSCTEN
	  ,LGD.DSCLOG
	  ,PAI.CODDDI
	  ,PAI.DSCPAI
	  ,STA.DSCREC
	  ,LGNUSU = ISNULL(LGN.LGNUSU,'')
	  ,FULEND = ISNULL(LGD.DSCLOG,'') + ' ' 
	  + TRIM(ADR.DSCEND) + IIF(ISNULL(NUMEND,'') <>'',',' + CONVERT(VARCHAR,NUMEND),'') + IIF(ISNULL(DSCCPL,'')<>'', ' compl :' + DSCCPL,'')
	  + IIF(ISNULL(DSCBAI,'')<> '', ' - ' + DSCBAI , '')  
	  + IIF(ISNULL(DSCCID,'')<> '', ' - ' + DSCCID , '') 
	  + IIF(ISNULL(CODUFE,'')<> '', ' - ' + CODUFE , '') 
	  + IIF(ISNULL(CODCEP,'00000000')<> '00000000', ' CEP : ' + CODCEP , '') 
  FROM TBCADEND AS ADR 
 INNER JOIN dbo.RFCODATR AS ATR ON ADR.CODATR = ATR.CODATR 
 INNER JOIN dbo.RFTIPEND AS TEN ON ADR.TIPEND = TEN.TIPEND 
 INNER JOIN dbo.RFTIPLOG AS LGD ON ADR.TIPLOG = LGD.TIPLOG 
 INNER JOIN dbo.TBSTAREC AS STA ON ADR.STAREC = STA.STAREC 
 INNER JOIN dbo.RFCODPAI AS PAI ON ADR.CODPAI = PAI.NIDPAI
  LEFT JOIN (SELECT CODUSU, LGNUSU FROM dbo.TBCADUSU (NOLOCK) ) AS LGN ON ADR.UPDUSU = LGN.CODUSU

        ]]>
				</query>
			</item>
		</view>

		<objectclass>
			<item acess="" modifier="" name="AddressBookList" inherit="" desc ="Objeto de Retenção de Informações de Usuários" remarks="">
				<query>
					<![CDATA[
SELECT ADR.NIDEND
      ,ADR.NIDGER
	  ,ADR.CODATR
	  ,ADR.REGATV
	  ,ADR.TIPEND
	  ,ADR.TIPLOG
	  ,ADR.CODPAI
	  ,ADR.HASCEP
	  ,ADR.CODCEP
	  ,ADR.NUMEND
	  ,ADR.DSCEND
	  ,ADR.DSCCPL
	  ,ADR.DSCCID
	  ,ADR.DSCBAI
	  ,ADR.CODUFE
	  ,ADR.STAREC
	  ,ADR.DATCAD
	  ,ADR.DATUPD
	  ,ADR.UPDUSU
	  ,ATR.DSCATR
	  ,TEN.DSCTEN
	  ,LGD.DSCLOG
	  ,PAI.CODDDI
	  ,PAI.DSCPAI
	  ,STA.DSCREC
	  ,LGNUSU = ISNULL(LGN.LGNUSU,'')
	  ,FULEND = ISNULL(LGD.DSCLOG,'') + ' ' 
	  + TRIM(ADR.DSCEND) + IIF(ISNULL(NUMEND,'') <>'',',' + CONVERT(VARCHAR,NUMEND),'') + IIF(ISNULL(DSCCPL,'')<>'', ' compl :' + DSCCPL,'')
	  + IIF(ISNULL(DSCBAI,'')<> '', ' - ' + DSCBAI , '')  
	  + IIF(ISNULL(DSCCID,'')<> '', ' - ' + DSCCID , '') 
	  + IIF(ISNULL(CODUFE,'')<> '', ' - ' + CODUFE , '') 
	  + IIF(ISNULL(CODCEP,'00000000')<> '00000000', ' CEP : ' + CODCEP , '') 
  FROM TBCADEND AS ADR 
 INNER JOIN dbo.RFCODATR AS ATR ON ADR.CODATR = ATR.CODATR 
 INNER JOIN dbo.RFTIPEND AS TEN ON ADR.TIPEND = TEN.TIPEND 
 INNER JOIN dbo.RFTIPLOG AS LGD ON ADR.TIPLOG = LGD.TIPLOG 
 INNER JOIN dbo.TBSTAREC AS STA ON ADR.STAREC = STA.STAREC 
 INNER JOIN dbo.RFCODPAI AS PAI ON ADR.CODPAI = PAI.NIDPAI
  LEFT JOIN (SELECT CODUSU, LGNUSU FROM dbo.TBCADUSU (NOLOCK) ) AS LGN ON ADR.UPDUSU = LGN.CODUSU
 WHERE NIDEND=-1
       ]]>

				</query>
			</item>


		</objectclass>
		<insertcommand key="Identity" exceptionparamns="'DATCAD','DATUPD'" procname="PRCADENDINS" method="Insert">
			<maxfield field=""/>
			<nextnumber field="" id="" />
			<pre>
				<![CDATA[
SET @DSCEND = @DSCEND + '          '   
SET @DSCEND=LTRIM(RTRIM(@DSCEND))   
IF(@DSCEND IS NULL OR @DSCEND='')
   SET @RETURN_VALUE=-3
IF(@CODATR IS NULL OR @CODATR<=0)
   SET @RETURN_VALUE=-6


IF(@RETURN_VALUE=0)
	BEGIN
		EXEC @RETURN_VALUE = PRCADENDFND @NIDGER,@CODATR, @DSCEND, @TIPEND
		IF(@RETURN_VALUE >0)
		    SET @RETURN_VALUE = -2
	END

IF(@RETURN_VALUE = 0)
   BEGIN
      IF(@TIPEND NOT IN (3,4,0))
        BEGIN
		  IF(@CODCEP='00000000') 
		     SET @RETURN_VALUE =-4
          IF (@CODUFE='')
             SET @RETURN_VALUE =-5
        END
  END      
      ]]>
			</pre>
			<body></body>
			<pos>
				<![CDATA[
          IF(@RETURN_VALUE>0 AND @REGATV=1 AND @STAREC=1)
              BEGIN
                UPDATE TBCADEND
                   SET REGATV = 0
				      ,DATUPD = GETDATE()
                 WHERE NIDGER = @NIDGER
				   AND CODATR = @CODATR
                   AND TIPEND = @TIPEND
                   AND NIDEND <> @RETURN_VALUE
                   AND STAREC = 1
                   AND @REGATV = 1
              END
        ]]>
			</pos>
			<returns>
				<return operator=">" value="0" message="Registro inserido com sucesso" error="OK"/>
				<return value="-1" message="" error="FAILALL"/>
				<return value="-2" message="" error="RECORDFOUND"/>
				<return value="-3" message="" error="INVALIDADDRESS"/>
				<return value="-4" message="" error="INVALIDARGUMENT" replaces="CEP"/>
				<return value="-5" message="" error="INVALIDARGUMENT" replaces="UF"/>
				<return value="-6" message="Atributo de definição não informado" error="FAILALL"/>
			</returns>
		</insertcommand>
		<updatecommand key="Identity" exceptionparamns="'DATCAD'" procname="PRCADENDUPD" method="Update">
			<maxfield field=""/>
			<nextnumber field="" id="" />
			<pre>
				<![CDATA[
				
IF(@STAREC >0 )     -- SE 0, PODE SER INATIVACAO DE REGISTRO
	BEGIN
		SET @DSCEND = @DSCEND + '          '   
		SET @DSCEND=LTRIM(RTRIM(@DSCEND))   

		IF(@DSCEND IS NULL OR @DSCEND='')
		   SET @RETURN_VALUE=-3
	    IF(@CODATR IS NULL OR @CODATR<=0)
		  SET @RETURN_VALUE=-6

		IF(@RETURN_VALUE=0)
			BEGIN
				EXEC @RETURN_VALUE = PRCADENDFND @NIDGER,@CODATR, @DSCEND, @TIPEND
				IF(@RETURN_VALUE >0)
					SET @RETURN_VALUE = -2
			END

		IF(@RETURN_VALUE = 0)
		   BEGIN
			  IF(@TIPEND NOT IN (3,4,0))
				BEGIN
				  IF(@CODCEP='00000000') 
					 SET @RETURN_VALUE =-4
				  IF (@CODUFE='')
					 SET @RETURN_VALUE =-5
				END
		  END   
	END
]]>

			</pre>
			<body></body>
			<pos>
				<![CDATA[
          IF(@RETURN_VALUE>0 AND @REGATV=1 AND @STAREC > 0)
              BEGIN
                UPDATE TBCADEND
                   SET REGATV = 0
				      ,DATUPD= GETDATE()
                 WHERE NIDGER = @NIDGER
				   AND CODATR = @CODATR
                   AND TIPEND = @TIPEND
                   AND NIDEND <> @RETURN_VALUE
                   AND STAREC = 1
                   AND @REGATV = 1
              END
        ]]>
			</pos>
			<returns>
				<return operator=">" value="0" message="Registro alterado com sucesso" error="OK"/>
				<return value="-1" message="" error="FAILALL"/>
				<return value="-2" message="" error="RECORDFOUND"/>
				<return value="-3" message="" error="INVALIDADDRESS"/>
				<return value="-4" message="" error="INVALIDARGUMENT" replaces="CEP"/>
				<return value="-5" message="" error="INVALIDARGUMENT" replaces="UF"/>
				<return value="-6" message="Atributo de definição não informado" error="FAILALL"/>
			</returns>
		</updatecommand>
		<selectcommand>
			<item script="false" alias="A." sql="" method="Select" return="AddressBook" procname="" desc ="Seleciona o registro de acordo com o código do cadastro de endereços">
				<query>
					<![CDATA[SELECT * FROM TBCADEND (nolock) A]]>
				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="ID de Registro do Endereço" name="NIDEND" type="int" default="" output="" null="false"/>
				</parameters>
			</item>
			<item script="false" alias="A." sql="" method="Select" return="AddressBook" procname="" desc ="Obtêm o registro de endereço de acordo com os parâmetros informados">
				<query>
					<![CDATA[SELECT * FROM TBCADEND (NOLOCK) A]]>
				</query>
				<parameters>
					<parameter input="true" desc ="Código de Referência" name="NIDGER" type="System.Int32" default="" output="" null="false"/>
					<parameter input="true" desc ="Atributo" name="CODATR" type="System.Byte" default="" output="" null="false"/>
				</parameters>
			</item>
			<item script="false" alias="A." sql="" method="Select" return="AddressBook" procname="" desc ="Obtêm o registro de endereço de acordo com os parâmetros informados">
				<query>
					<![CDATA[SELECT * FROM TBCADEND (NOLOCK) A]]>
				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="Código de Referência" name="NIDGER" type="System.Int32" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Atributo" name="CODATR" type="System.Byte" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Tipo de Endereço" name="TIPEND" type="System.Byte" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Registro Ativo" name="REGATV" type="System.Byte" default="1" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Status de Registro" name="STAREC" type="System.Byte" default="1" output="" null="false"/>
				</parameters>
			</item>

		</selectcommand>

		<selectallcommand>

			<item script="true" alias="A." sql="" method="SelectAll" return="AddressBookList" procname="PRCADENDSELALL" desc ="Seleciona todos os registros de endereço do usuário fornecido">
				<query>
					<![CDATA[SELECT * FROM VWCADEND A ]]>
				</query>
				<parameters>
					<parameter input="true" desc ="Código de Referência"  name="NIDGER" type="System.Int32" default="" output="" null="false"/>
					<parameter input="true" desc ="Atributo"  name="CODATR" type="System.Byte" default="" output="" null="false"/>
				</parameters>
			</item>
		</selectallcommand>

		<methods>
			<item script="true" alias="A." sql="" method="Find" return="int" returnmode="5" procname="PRCADENDFND" desc ="Obtêm o id de registro de endereço com base nos parâmetros informados" returnvalue="0">
				<query>
					<![CDATA[
DECLARE @RETURN_VALUE INT = 0
SELECT @RETURN_VALUE = COALESCE(NIDEND,0) 
  FROM TBCADEND (NOLOCK) 
 WHERE STAREC = 1
   AND NIDGER = @NIDGER
   AND CODATR = @CODATR
   AND DSCEND = @DSCEND
   AND TIPEND = @TIPEND    
IF(@RETURN_VALUE IS NULL)
   SET @RETURN_VALUE=0;
RETURN @RETURN_VALUE          
          ]]>
				</query>

				<parameters>
					<parameter input="true" desc ="Código de Referência" name="NIDGER" type="System.Int32" default="" output="" null="false"/>
					<parameter input="true" desc ="Atributo" name="CODATR" type="System.Byte" default="" output="" null="false"/>

					<parameter input="true" desc ="Endereço" name="DSCEND" type="System.String" size="70" default="" output="" null="false"/>
					<parameter input="true" desc ="Tipo de Endereço" name="TIPEND" type="System.Byte" default="" output="" null="false"/>
				</parameters>
			</item>
			<item script="true" alias="A." sql="" method="Find" return="int" returnmode="5" procname="PRCADENDFNDBAS" desc ="Obtêm o id de registro de endereço de um registro ativo com base nos parâmetros informados" returnvalue="0">
				<query>
					<![CDATA[
DECLARE @RETURN_VALUE INT = 0
SELECT @RETURN_VALUE = COALESCE(NIDEND,0) 
  FROM TBCADEND (NOLOCK) 
 WHERE STAREC = 1
   AND NIDGER = @NIDGER
   AND CODATR = @CODATR  
   AND TIPEND = @TIPEND    
   AND REGATV = @REGATV        
IF(@RETURN_VALUE IS NULL)
   SET @RETURN_VALUE=0;
RETURN @RETURN_VALUE          
          ]]>
				</query>
				<parameters>
					<parameter input="true" desc ="Código de Referência" name="NIDGER" type="System.Int32" default="" output="" null="false"/>
					<parameter input="true" desc ="Atributo" name="CODATR" type="System.Byte" default="" output="" null="false"/>
					<parameter input="true" desc ="Tipo de Endereço" name="TIPEND" type="System.Byte" default="" output="" null="false"/>
					<parameter input="true" desc ="Indicador de Atividade do Registro" name="REGATV" type="System.Byte" default="" output="" null="false"/>
				</parameters>
			</item>

			<item script="true" alias="A." sql="" method="SetAsMasterRecord" return="int" returnmode="1" procname="PRCADENDSETATV" desc ="Define o registro como principal de acordo com os parâmetros informados" returnvalue="1">
				<query>
					<![CDATA[
SET @RETURN_VALUE = 0          
UPDATE TBCADEND SET REGATV=0 WHERE NIDGER=@NIDGER AND CODATR=@CODATR AND TIPEND =@TIPEND
IF(@@ERROR=0)
		BEGIN
			UPDATE TBCADEND SET REGATV=1 WHERE NIDGER = @NIDGER AND CODATR = @CODATR AND TIPEND = @TIPEND AND NIDEND = @NIDEND
			IF(@@ERROR = 0)
				SET @RETURN_VALUE = 1
		END
RETURN @RETURN_VALUE
          ]]>
				</query>
				<parameters>
					<parameter input="true" desc ="Código de Referência" name="NIDGER" type="System.Int32" default="" output="" null="false"/>
					<parameter input="true" desc ="Atributo" name="CODATR" type="System.Byte" default="" output="" null="false"/>
					<parameter input="true" desc ="Tipo de Endereço" name="TIPEND" type="System.Byte" default="" output="" null="false"/>

					<parameter input="true" desc ="ID de Registro do Endereço" name="NIDEND" type="System.Int32" default="" output="" null="false"/>
				</parameters>
			</item>
		</methods>
	</item>


	<item create="true"  id="6" name="TBCADANI" friendlyname="Pets" modelversion="3" descriptor="Tabela de Animais">
		<CSharpPartial>true</CSharpPartial>
		<SqlTable></SqlTable>

		<extendedmodel></extendedmodel>
		<view>
			<item owner="dbo" script="true" name="VWCADANI" desc ="View de Informações de PETS">
				<query>
					<![CDATA[
SELECT ANI.CODANI
      ,ANI.CODCLI
	  ,CLI.CODCMF
	  ,CLI.RAZSOC
      ,ANI.NOMANI
      ,ANI.HASFAL
      ,ANI.DATOBT
      ,ANI.CODGEN
	  ,GEN.DSCGEN
      ,ANI.CODESP
	  ,ESP.DSCESP
      ,ANI.CODRAC
	  ,RAC.DSCRAC
      ,ANI.CODCOR
	  ,COR.DSCCOR
      ,ANI.CODPEL
	  ,PEL.DSCPEL
      ,ANI.CODPOR
	  ,POR.DSCPOR
      ,ANI.HASALE
      ,ANI.DSCALE
      ,ANI.HASRGA
      ,ANI.NUMRGA
      ,ANI.DATNAC
      ,ANI.OBSANI
      ,ANI.STAREC
	  ,STA.DSCREC
	  ,ANI.HASCAS
	  ,ANI.NUMPES
      ,ANI.DATCAD
      ,ANI.DATUPD
      ,ANI.UPDUSU
	  ,LGNUSU = ISNULL(LGN.LGNUSU,'')
	  ,IDAFUL = CASE WHEN ANI.DATNAC IS NOT NULL THEN dbo.CalculateAge(ANI.DATNAC, GETDATE()) ELSE '' END
	  ,IDAANI = CASE WHEN ANI.DATNAC IS NOT NULL THEN CONVERT( NUMERIC (10,4), (DATEDIFF(SECOND, ANI.DATNAC, GETDATE())/(86400.0*365.0))) ELSE 0.0 END
  FROM TBCADANI (NOLOCK) ANI
 INNER JOIN TBCADCLI (NOLOCK) CLI ON (CLI.CODCLI = ANI.CODCLI)
 INNER JOIN RFCODGEN (NOLOCK) GEN ON (GEN.CODGEN = ANI.CODGEN)
 INNER JOIN RFCODESP (NOLOCK) ESP ON (ESP.CODESP = ANI.CODESP)
 INNER JOIN RFCODRAC (NOLOCK) RAC ON (RAC.CODRAC = ANI.CODRAC)
 INNER JOIN RFCODCOR (NOLOCK) COR ON (COR.CODCOR = ANI.CODCOR)
 INNER JOIN RFCODPEL (NOLOCK) PEL ON (PEL.CODPEL = ANI.CODPEL)
 INNER JOIN RFCODPOR (NOLOCK) POR ON (POR.CODPOR = ANI.CODPOR)
 INNER JOIN TBSTAREC (NOLOCK) STA ON (STA.STAREC = ANI.STAREC)
  LEFT JOIN TBCADUSU (NOLOCK) LGN ON (LGN.CODUSU = ANI.UPDUSU)



        ]]>
				</query>
			</item>
		</view>
		
			
	<objectclass>
			<item script="true" alias="A." sql="" name="PetsList" return="int" returnmode="1" procname="" desc ="Objeto de Retenção de Informações de Pets" returnvalue="1">
				<query>
					<![CDATA[
SELECT ANI.CODANI
      ,ANI.CODCLI
	  ,CLI.CODCMF
	  ,CLI.RAZSOC
      ,ANI.NOMANI
      ,ANI.HASFAL
      ,ANI.DATOBT
      ,ANI.CODGEN
	  ,GEN.DSCGEN
      ,ANI.CODESP
	  ,ESP.DSCESP
      ,ANI.CODRAC
	  ,RAC.DSCRAC
      ,ANI.CODCOR
	  ,COR.DSCCOR
      ,ANI.CODPEL
	  ,PEL.DSCPEL
      ,ANI.CODPOR
	  ,POR.DSCPOR
      ,ANI.HASALE
      ,ANI.DSCALE
      ,ANI.HASRGA
      ,ANI.NUMRGA
      ,ANI.DATNAC
      ,ANI.OBSANI
      ,ANI.STAREC
	  ,STA.DSCREC
	  ,ANI.HASCAS
	  ,ANI.NUMPES
      ,ANI.DATCAD
      ,ANI.DATUPD
      ,ANI.UPDUSU
	  ,LGNUSU = ISNULL(LGN.LGNUSU,'')
	  ,IDAFUL = CASE WHEN ANI.DATNAC IS NOT NULL THEN dbo.CalculateAge(ANI.DATNAC, GETDATE()) ELSE '' END
	  ,IDAANI = CASE WHEN ANI.DATNAC IS NOT NULL THEN CONVERT( NUMERIC (10,4), (DATEDIFF(SECOND, ANI.DATNAC, GETDATE())/(86400.0*365.0))) ELSE 0.0 END
  FROM TBCADANI (NOLOCK) ANI
 INNER JOIN TBCADCLI (NOLOCK) CLI ON (CLI.CODCLI = ANI.CODCLI)
 INNER JOIN RFCODGEN (NOLOCK) GEN ON (GEN.CODGEN = ANI.CODGEN)
 INNER JOIN RFCODESP (NOLOCK) ESP ON (ESP.CODESP = ANI.CODESP)
 INNER JOIN RFCODRAC (NOLOCK) RAC ON (RAC.CODRAC = ANI.CODRAC)
 INNER JOIN RFCODCOR (NOLOCK) COR ON (COR.CODCOR = ANI.CODCOR)
 INNER JOIN RFCODPEL (NOLOCK) PEL ON (PEL.CODPEL = ANI.CODPEL)
 INNER JOIN RFCODPOR (NOLOCK) POR ON (POR.CODPOR = ANI.CODPOR)
 INNER JOIN TBSTAREC (NOLOCK) STA ON (STA.STAREC = ANI.STAREC)
  LEFT JOIN TBCADUSU (NOLOCK) LGN ON (LGN.CODUSU = ANI.UPDUSU)

   WHERE ANI.CODANI = -1

        ]]>

				</query>
			</item>
		</objectclass>

		<insertcommand key="key" exceptionparamns="'DATCAD','DATUPD'" procname="PRCADANIINS" method="Insert">
			<maxfield field="CODANI"/>
			<nextnumber field="" id="" />
			<pre>
				<![CDATA[
IF(EXISTS(SELECT 1 FROM TBCADANI WHERE CODCLI = @CODCLI AND NOMANI =@NOMANI AND DATNAC =@DATNAC))
   SET @RETURN_VALUE =-2;
			
			]]>
			</pre>
			<body></body>
			<pos>
				<![CDATA[
IF(@RETURN_VALUE = -2)
	BEGIN
		UPDATE dbo.TBCADANI
		   SET CODCLI = @CODCLI
			  ,NOMANI = @NOMANI
			  ,HASFAL = @HASFAL
			  ,DATOBT = @DATOBT
			  ,CODGEN = @CODGEN
			  ,CODESP = @CODESP
			  ,CODRAC = @CODRAC
			  ,CODCOR = @CODCOR
			  ,CODPEL = @CODPEL
			  ,CODPOR = @CODPOR
			  ,HASALE = @HASALE
			  ,DSCALE = @DSCALE
			  ,HASRGA = @HASRGA
			  ,NUMRGA = @NUMRGA
			  ,DATNAC = @DATNAC
			  ,OBSANI = @OBSANI
			  ,STAREC = @STAREC
			  ,DATUPD = GETDATE()
			  ,UPDUSU = @UPDUSU
			  ,HASCAS = @HASCAS
			  ,NUMPES = @NUMPES
		 WHERE CODANI = @CODANI		
		 
		    IF (@@ERROR = 0)
			   SET @RETURN_VALUE = 2;
	END

	/*
	 * Atualiza o controle de peso dos animais
	 */
 IF(@RETURN_VALUE = 1 OR @RETURN_VALUE=2)
	BEGIN
		DECLARE @RV INT = 0;
		DECLARE @HU DATETIME = GETDATE();
		EXEC dbo.PRANIPESINS @CODANI, @HU, @NUMPES, 1, @UPDUSU, @RV OUTPUT
    END
			
				]]>
			</pos>
			<returns>
				<return operator="==" value="1" message="Registro inserido com sucesso" error="OK"/>
				<return operator="==" value="2" message="Registro alterado com sucesso" error="OK"/>
				<return value="-1" message="" error="FAILALL"/>
			</returns>
		</insertcommand>

		<selectcommand>
			<item script="false" alias="A." sql="" method="Select" return="Pets" procname="" desc ="Obtêm o registro do animal de  acordo com o código do id de registro">
				<query>
					<![CDATA[SELECT * FROM TBCADANI (NOLOCK) A]]>
				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="Código do Animal" name="CODANI" type="int" default="" output="" null="false"/>
				</parameters>
			</item>
		</selectcommand>
		<selectallcommand>
			<item script="true" alias="A." sql="" method="SelectAll" type="List" return="PetsList" procname="PRCADANISELALL" desc ="Obtêm todos os registros de animais com base no ID de Registro do Cliente">
				<query order="DATCAD DESC">
					<![CDATA[
IF(@HASFAL=-1)
   SET @HASFAL  = NULL;
		
 SELECT * FROM VWCADANI A
        ]]>
				</query>
				<parameters>
					<parameter input="true" desc ="Código do Cliente"  name="CODCLI" type="int" size="15" default="" output="" null="false"/>
					<parameter input="true" desc ="Nome do Animal" islike="true" name="NOMANI" type="System.String" size="50" default="" output="" null="false"/>
					<parameter input="true" desc ="Vivo ou Morto"  islike="true" name="HASFAL" type="int"  default="" output="" null="false"/>
			
				</parameters>
			</item>
		</selectallcommand>
	</item>




	<item create="true"  id="6" name="TBANIPES" friendlyname="PetWeight" modelversion="3" descriptor="Tabela de Peso de Animais">
		<CSharpPartial>true</CSharpPartial>
		<SqlTable></SqlTable>

		<extendedmodel></extendedmodel>
		<insertcommand key="key" exceptionparamns="'DATCAD','DATUPD'" procname="PRANIPESINS" method="Insert">
			<maxfield field=""/>
			<nextnumber field="" id="" />
			<pre>
				<![CDATA[
IF(EXISTS(SELECT 1 FROM TBANIPES WHERE CODANI = @CODANI AND DATPES = @DATPES AND NUMPES=@NUMPES))
   SET @RETURN_VALUE =-2;
   
DECLARE @V1 NUMERIC (8,3)
SELECT @V1 = NUMPES FROM TBANIPES (NOLOCK) WHERE CODANI = @CODANI ORDER BY DATPES DESC

IF(@V1>0)
	BEGIN
		/*
		 * Se a ultima marcação de peso for igual a atual, ignora uma nova inserção
		 */
		IF(@V1 = @NUMPES)
			SET @RETURN_VALUE = -3;
	END

			
			]]>
			</pre>
			<body></body>
			<pos>
				<![CDATA[
				]]>
			</pos>
			<returns>
				<return operator="==" value="1" message="Registro inserido com sucesso" error="OK"/>
				<return operator="==" value="2" message="Registro alterado com sucesso" error="OK"/>
				<return value="-1" message="" error="FAILALL"/>
				<return value="-2" message="" error="RECORDFOUND"/>
				<return value="-3" message="Registro ignorado, a última marcação corresponde a atual." error="RECORDFOUND"/>


			</returns>
		</insertcommand>


	</item>






	<item create="true"  id="18" name="TPTIPCOR" friendlyname="AnimalColor" modelversion="3" descriptor ="Cor de Animal">
		<CSharpPartial>False</CSharpPartial>
		<SqlTable></SqlTable>

		<extendedmodel>
			<![CDATA[SELECT A.*, DSCREC= ISNULL(B.DSCTAB,''),LGNUSU = ISNULL(C.LGNUSU,'') FROM TPTIPCOR A (NOLOCK)
			INNER JOIN TBTABGER (NOLOCK) B ON (B.CODTAB = 7 AND B.KEYCOD=A.STAREC)
			LEFT JOIN TBLGNUSU (NOLOCK) C ON (C.CODGER = A.UPDUSU AND C.REGATV=1) WHERE CODCOR=-1]]>
		</extendedmodel>

		<insertcommand key="Key" exceptionparamns="'DATCAD','DATUPD','CODCOR'" procname="">
			<maxfield field="CODCOR"/>
			<nextnumber field="" id="" />
			<pre><![CDATA[DECLARE @CODCOR SMALLINT =0]]></pre>
			<body></body>
			<pos></pos>
			<returns>
				<return operator=">" value="0" message="Registro inserido com sucesso" error="OK"/>
				<return value="-1" message="" error="FAILALL"/>
			</returns>
		</insertcommand>
		<updatecommand key="Key" fieldreturn="CODCOR" exceptionparamns="'DATCAD'" procname="" >
			<maxfield field="CODCOR"/>
			<nextnumber field="" id="" />
			<pre>
				SET @DATUPD = GETDATE();
			</pre>
			<body></body>
			<pos></pos>
			<returns>
				<return operator=">" value="0" message="Registro alterado com sucesso" error="OK"/>
				<return value="-1" message="" error="FAILALL"/>
			</returns>
		</updatecommand>
		<selectcommand>
			<item script="true" alias="A." sql="" method="Select" return="AnimalColor" procname="" desc ="Obtêm o registro de cor de um id específico">
				<query>
					<![CDATA[SELECT * FROM TPTIPCOR (nolock) A]]>
				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="Código da Cor" name="CODCOR" type="int" default="" output="" null="false"/>
				</parameters>
			</item>
		</selectcommand>
		<selectallcommand>
			<item script="true" alias="A." sql="" type="List" method="SelectAll" return="AnimalColor" procname="" desc ="Obtêm todos os registros de cores cadastradas">
				<query>
					<![CDATA[SELECT A.*, DSCREC= ISNULL(B.DSCTAB,''),LGNUSU = ISNULL(C.LGNUSU,'') FROM TPTIPCOR A (NOLOCK)
INNER JOIN TBTABGER (NOLOCK) B ON (B.CODTAB = 7 AND B.KEYCOD=A.STAREC)
LEFT JOIN TBLGNUSU (NOLOCK) C ON (C.CODGER = A.UPDUSU AND C.REGATV=1)
]]>
				</query>
			</item>
		</selectallcommand>
	</item>

	<item create="true"  id="19" name="TPTIPESP" friendlyname="AnimalSpecies" modelversion="3" descriptor ="Especie de Animal">
		<CSharpPartial>False</CSharpPartial>
		<SqlTable></SqlTable>
		<extendedmodel>
			<![CDATA[SELECT A.*, DSCREC= ISNULL(B.DSCTAB,''),LGNUSU = ISNULL(C.LGNUSU,'') FROM TPTIPESP A (NOLOCK)
INNER JOIN TBTABGER (NOLOCK) B ON (B.CODTAB = 7 AND B.KEYCOD=A.STAREC)
LEFT JOIN TBLGNUSU (NOLOCK) C ON (C.CODGER = A.UPDUSU AND C.REGATV=1) WHERE CODESP=-1]]>
		</extendedmodel>
		<asp>1111000000</asp>
		<csharp>1111000000</csharp>
		<selectcommand>
			<item script="true" alias="A." sql="" method="Select" return="AnimalSpecies" procname="" desc ="Obtêm o registro de espécie de um id específico">
				<query>
					<![CDATA[SELECT * FROM TPTIPESP (NOLOCK) A]]>
				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="Código da Cor" name="CODESP" type="int" default="" output="" null="false"/>
				</parameters>
			</item>
		</selectcommand>

		<insertcommand key="Key" exceptionparamns="'DATCAD','DATUPD','CODESP'" procname="">
			<maxfield field="CODESP"/>
			<nextnumber field="" id="" />
			<pre><![CDATA[DECLARE @CODESP SMALLINT =0]]></pre>
			<body></body>
			<pos></pos>
			<returns>
				<return operator=">" value="0" message="Registro inserido com sucesso" error="OK"/>
				<return value="-1" message="" error="FAILALL"/>
			</returns>
		</insertcommand>
		<updatecommand key="Key" fieldreturn="CODESP" exceptionparamns="'DATCAD'" procname="" >
			<maxfield field="CODESP"/>
			<nextnumber field="" id="" />
			<pre>
				SET @DATUPD = GETDATE();
			</pre>
			<body></body>
			<pos></pos>
			<returns>
				<return operator=">" value="0" message="Registro alterado com sucesso" error="OK"/>
				<return value="-1" message="" error="FAILALL"/>
			</returns>
		</updatecommand>

		<selectallcommand>
			<item script="true" alias="A." sql="" type="List" method="SelectAll" return="AnimalSpecies" procname="" desc ="Obtêm todos os registros de espécies cadastrados">
				<query>
					<![CDATA[SELECT A.*, DSCREC= ISNULL(B.DSCTAB,''),LGNUSU = ISNULL(C.LGNUSU,'') FROM TPTIPESP A (NOLOCK)
INNER JOIN TBTABGER (NOLOCK) B ON (B.CODTAB = 7 AND B.KEYCOD=A.STAREC)
LEFT JOIN TBLGNUSU (NOLOCK) C ON (C.CODGER = A.UPDUSU AND C.REGATV=1) 
]]>
				</query>
			</item>
		</selectallcommand>
	</item>


	<item create="true"  id="20" name="TPTIPRAC" friendlyname="AnimalBreed" modelversion="3" descriptor ="Raças">
		<CSharpPartial>False</CSharpPartial>
		<SqlTable></SqlTable>
		<extendedmodel>
			<![CDATA[SELECT A.*, DSCREC= ISNULL(B.DSCTAB,''),LGNUSU = ISNULL(C.LGNUSU,'') FROM TPTIPRAC A (NOLOCK)
INNER JOIN TBTABGER (NOLOCK) B ON (B.CODTAB = 7 AND B.KEYCOD=A.STAREC)
LEFT JOIN TBLGNUSU (NOLOCK) C ON (C.CODGER = A.UPDUSU AND C.REGATV=1) WHERE CODRAC=-1]]>
		</extendedmodel>
		<asp>1111000000</asp>
		<csharp>1111000000</csharp>

		<insertcommand key="Key" exceptionparamns="'DATCAD','DATUPD','CODRAC'" procname="">
			<maxfield field="CODRAC"/>
			<nextnumber field="" id="" />
			<pre><![CDATA[DECLARE @CODRAC SMALLINT =0]]></pre>
			<body></body>
			<pos></pos>
			<returns>
				<return operator=">" value="0" message="Registro inserido com sucesso" error="OK"/>
				<return value="-1" message="" error="FAILALL"/>
			</returns>
		</insertcommand>
		<updatecommand key="Key" fieldreturn="CODRAC" exceptionparamns="'DATCAD'" procname="" >
			<maxfield field="CODRAC"/>
			<nextnumber field="" id="" />
			<pre>
				SET @DATUPD = GETDATE();
			</pre>
			<body></body>
			<pos></pos>
			<returns>
				<return operator=">" value="0" message="Registro alterado com sucesso" error="OK"/>
				<return value="-1" message="" error="FAILALL"/>
			</returns>
		</updatecommand>
		<selectcommand>
			<item script="true" alias="A." sql="" method="Select" return="AnimalBreed" procname="" desc ="Obtêm o registro de raça de um código específico">
				<query>
					<![CDATA[SELECT * FROM TPTIPRAC (NOLOCK) A]]>
				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="Código da Raça" name="CODRAC" type="short" default="" output="" null="false"/>
				</parameters>
			</item>
		</selectcommand>



		<selectallcommand>
			<item script="true" alias="A." sql="" type="List" method="SelectAll" return="AnimalBreed" procname="" desc ="Obtêm todos os registros de raça cadastrados">
				<query order="A.DSCRAC">
					<![CDATA[SELECT A.*, DSCREC= ISNULL(B.DSCTAB,''),LGNUSU = ISNULL(C.LGNUSU,'') FROM TPTIPRAC A (NOLOCK)
INNER JOIN TBTABGER (NOLOCK) B ON (B.CODTAB = 7 AND B.KEYCOD=A.STAREC)
LEFT JOIN TBLGNUSU (NOLOCK) C ON (C.CODGER = A.UPDUSU AND C.REGATV=1)]]>
				</query>
			</item>
		</selectallcommand>
	</item>





	<item create="true"  id="33" name="TBREGCCR" friendlyname="Controle CC" modelversion="3" descriptor="Registro de Conta Corrente">
		<UpdateKey>Key</UpdateKey>
		<audit>False</audit>
		<keyaudit></keyaudit>
		<FilterSelect>False</FilterSelect>
		<listselect></listselect>
		<CSharpPartial>True</CSharpPartial>
		<SqlTable>SELECT TOP 1 NIDCCR,	REFNID,	REGHAB,	STAREC,	TIPLCT,	REGPRO,	LOTFIN,	CODAPR,	ORGLCT,	DATCAD,	DATUPD,	UPDUSU,	REFLOT,	CODSOL,	CODPRT,	CODUSU,	USUPRO,	NIDBOL,	SIGOPE,	LINREF,	TIPLIN,	IDEPRE,	CODMOV,	DATPCL,	NUMPCL,	TIPVAL,	VLRMOV,	DSCMOV,	DATVEN,	DATMOV,	CONUSU,	STAREG,	NUMBOR,	STABOR,	DATPRC,	NIDUCT,	INDLCT,	NIDCTA,	NIDTRA,	CANTRA,	NIDTRB,	NUMIPA,	NIDTOK,	CODMOE,	NUMREX,	TIPRFE,	NIDRVM,	NIDPAG,	CODTRM, CODMCC, OPRCRT, TIPPRO, CODCRT, VISREC, TIPENT FROM TBREGCCR (NOLOCK)</SqlTable>
		<extendedmodel>
			<![CDATA[SELECT TOP 1 NIDCCR,	REFNID,	REGHAB,	STAREC,	TIPLCT,	REGPRO,	LOTFIN,	CODAPR,	ORGLCT,	DATCAD,	DATUPD,	UPDUSU,	REFLOT,	CODSOL,	CODPRT,	CODUSU,	USUPRO,	NIDBOL,	SIGOPE,	LINREF,	TIPLIN,	IDEPRE,	CODMOV,	DATPCL,	NUMPCL,	TIPVAL,	VLRMOV,	DSCMOV,	DATVEN,	DATMOV,	CONUSU,	STAREG,	NUMBOR,	STABOR,	DATPRC,	NIDUCT,	INDLCT,	NIDCTA,	NIDTRA,	CANTRA,	NIDTRB,	NUMIPA,	NIDTOK,	CODMOE,	NUMREX,	TIPRFE,	NIDRVM,	NIDPAG,	CODTRM, '' AS NUMNSU, CODMCC, OPRCRT, TIPPRO, CODCRT, VISREC, TIPENT FROM TBREGCCR (NOLOCK)]]>
		</extendedmodel>
		<fieldreturn></fieldreturn>
		<procedure>111100000000</procedure>
		<asp>1110000000</asp>
		<csharp>111100000</csharp>

		<view>
			<item script="true" alias="A." sql="" method="" return="" procname="VWREGCCRSLDUSUORG" desc ="View de Informações consolidados de Saldo por Usuario e Origem de conta">
				<query>
					<![CDATA[
SELECT CODUSU, ORGCTA, SUM(VLRMOV*SIGOPE) SLDACT 
  FROM TBREGCCR (NOLOCK) A1 	
 WHERE A1.STAREC >0
   AND A1.TIPVAL = 1
   AND A1.REGHAB = 1
   AND A1.INDLCT = 2
 GROUP BY A1.CODUSU, A1.ORGCTA
        ]]>
				</query>
			</item>



		</view>

		<objectproperty>
			<parameters>
				<parameter input="true" apply="true" desc ="ID da Transação" name="NIDTRA" type="System.String" default="" output="" null="false"/>
				<parameter input="true" apply="true" desc ="Lote Financeiro" name="LOTFIN" type="System.Int32" default="" output="" null="false"/>
			</parameters>
		</objectproperty>

		<objectclass>
			<item script="true" alias="A." sql="" method="ExtratoContaProduto" return="int" returnmode="1" procname="" desc ="Objeto de Retenção de Informações de Extrato de Cartoes com base em produto" returnvalue="1">
				<query>
					<![CDATA[
  DECLARE @RESULT TABLE 
  (
	  PAGNRO smallint NOT NULL,
	  NIDREX int NOT NULL,
	  PRNDAT VARCHAR(10) DEFAULT '',
	  PRNHOR VARCHAR(8) DEFAULT '',
	  NUMTRA varchar(17) NOT NULL  DEFAULT (''),
	  CODCRT int NOT NULL DEFAULT 0,
	  NOMEST varchar(70) NOT NULL DEFAULT (''),
	  DSCTRA varchar(50) NOT NULL DEFAULT (''),
	  VLRTRA money NOT NULL DEFAULT ((0)),
	  TIPPRO TINYINT NOT NULL DEFAULT 6,
    SBLMOE VARCHAR(6) DEFAULT 'R$',  
	  PAGMAX int NOT NULL DEFAULT 0  
  ) 
  SELECT * FROM @RESULT          
        ]]>

				</query>
			</item>
			<item script="true" alias="A." sql="" method="DataOut" return="int" returnmode="1" procname="" desc ="Objeto de Retenção de Informações de Registro de Contabilização de Lançamentos" returnvalue="1">
				<query>
					<![CDATA[
            SELECT CODPRT 
                  ,CODUSU 
                  ,USUPRO
                  ,USUDEB = CODUSU
                  ,CTADEB = NIDCTA
                  ,DEBPRT = CODCRT
                  ,CRDPRT = CODCRT
                  ,USUCRD = CODUSU
                  ,CTACRD = NIDCTA
                  ,CRDCTA = NIDCTA
                  ,DEBCTA = NIDCTA, TIPLIN = CAST(0 AS TINYINT), CODRSP = '00', CODPRO = CAST(0 AS SMALLINT), VALCRT = '00/00', PSWCRT = '0000', OPRCRT, DSCERR='' FROM TBREGCCR (NOLOCK) WHERE NIDCCR=-1
        ]]>
				</query>
			</item>

		</objectclass>


		<insertcommand key="Identity" exceptionparamns="'DATCAD','DATUPD', 'NIDCCR'">
			<maxfield field=""/>
			<nextnumber field="" id="" />
			<pre>
				<![CDATA[
DECLARE @ORGCTA TINYINT = 1
EXEC @ORGCTA = PRGETACTSRC @NIDCTA
]]>

			</pre>
			<body></body>
			<pos>
				<![CDATA[
IF(@RETURN_VALUE>0)
   UPDATE TBREGCCR SET ORGCTA = @ORGCTA WHERE NIDCCR=@RETURN_VALUE]]>
			</pos>
			<returns>
				<return value="-1" message="" error="FAILALL"/>
				<return value="-2" message="" error="RECORDFOUND"/>
			</returns>
		</insertcommand>
		<updatecommand key="Identity" exceptionparamns="'DATCAD'">
			<maxfield field=""/>
			<nextnumber field="" id="" />
			<pre>
				<![CDATA[SET @DATUPD =GETDATE();
DECLARE @ORGCTA TINYINT = 1
EXEC @ORGCTA = PRGETACTSRC @NIDCTA
        ]]>
			</pre>
			<body>
			</body>
			<pos>
				<![CDATA[
IF(@RETURN_VALUE>0)
   UPDATE TBREGCCR SET ORGCTA = @ORGCTA WHERE NIDCCR=@RETURN_VALUE]]>
			</pos>
			<returns>
				<return value="-1" message="" error="FAILALL"/>
				<return value="-2" message="" error="RECORDNOTFOUND"/>
			</returns>
		</updatecommand>

		<selectcommand>
			<item script="true" alias="A." sql="" type="" method="Select" return="ControleCC" procname="" desc ="Seleciona o registro de acordo com o id de registro do conta corrente">
				<query>
					<![CDATA[SELECT * FROM TBREGCCR (NOLOCK) A]]>
				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="ID do Registro de Conta Corrente" name="NIDCCR" type="System.Int32" default="" output="" null="false"/>
				</parameters>
			</item>


		</selectcommand>

		<methods>

			<item script="true" alias="A." sql="" method="GetRecordID" return="int" returnmode="5" procname="PRREGCCRGETNIDCCR" desc ="Obtêm o ID do Registro de Conta Corrente de acordo com os parâmetros fornecidos" returnvalue="0">
				<query>
					<![CDATA[
DECLARE @RETURN_VALUE INT = 0
IF(@CODMOV>0)
    BEGIN
      SELECT TOP 1 @RETURN_VALUE = ISNULL(NIDCCR,0)
        FROM TBREGCCR (NOLOCK) 
       WHERE STAREC=1
         AND NIDTRA = @NIDTRA
         AND CODMOV = @CODMOV
    END         
ELSE
    BEGIN
      SELECT TOP 1 @RETURN_VALUE = ISNULL(NIDCCR,0)
        FROM TBREGCCR (NOLOCK) 
       WHERE STAREC=1
         AND NIDTRA = @NIDTRA
    END         
RETURN @RETURN_VALUE
          ]]>
				</query>
				<parameters>
					<parameter input="true" desc ="Número da Transação" name="NIDTRA" type="System.String"  size="13" default="" output="" null="false"/>
					<parameter input="true" desc ="Código de Movimento" name="CODMOV" type="System.Int16" default="0" output="" null="false"/>

				</parameters>
			</item>
			<item script="true" alias="A." sql="" method="HasSolicitation" return="int" returnmode="5" procname="PRREGCCRGETCODSOL" desc ="Obtêm o ID do Registro de Conta Corrente de uma solicitação de acordo com os parâmetros fornecidos" returnvalue="0">
				<query>
					<![CDATA[
DECLARE @RETURN_VALUE INT = 0
SELECT TOP 1 @RETURN_VALUE = ISNULL(NIDCCR,0)
  FROM TBREGCCR (NOLOCK) 
 WHERE STAREC=1
   AND TIPLCT = @TIPLCT
   AND CODMOV = @CODMOV   
   AND CODUSU = @CODUSU
   AND CODSOL = @CODSOL   
   AND CODTRM = @CODTRM      
RETURN @RETURN_VALUE   
          ]]>
				</query>
				<parameters>
					<parameter input="true" desc ="Tipo de Solicitação"   name="TIPLCT" type="System.Int16" output="" null="false"/>
					<parameter input="true" desc ="Código de Movimento"   name="CODMOV" type="System.Int16" output="" null="false"/>
					<parameter input="true" desc ="Código do Usuário"     name="CODUSU" type="System.Int32" output="" null="false"/>
					<parameter input="true" desc ="Número da Solicitação" name="CODSOL" type="System.String"  size="15" default="" output="" null="false"/>
					<parameter input="true" desc ="Tipo de Transação Registro" name="CODTRM" type="System.Byte" default="" output="" null="false"/>
				</parameters>
			</item>

			<item webtype="POST" script="true" alias="A." sql="SELECT TOP 1 * FROM XLCRTMUL" type="List" method= "ExtratoContaProduto" return="ExtratoContaProduto" procname="PRREGCCREXTCRTMULL" desc ="Obtêm o extrato de conta corrente dos cartões multi" remarks="Extrato de Conta Corrente Cartões Multi">
				<query merge="true" order="A.DATCAD DESC">
					<![CDATA[
IF(@DATMOV1='')
   SET @DATMOV1=NULL;
IF(@DATMOV2='')
   SET @DATMOV2=NULL;

  DECLARE @RESULT TABLE (
	DATCAD DATETIME NOT NULL,  
	PAGNRO smallint NOT NULL,
	NIDREX int NOT NULL,
	PRNDAT VARCHAR(10) DEFAULT '',
	PRNHOR VARCHAR(8) DEFAULT '',
	NUMTRA varchar(17) NOT NULL  DEFAULT (''),
	CODCRT [int] NOT NULL,
	NOMEST varchar(70) NOT NULL DEFAULT (''),
	DSCTRA varchar(50) NOT NULL DEFAULT (''),
	VLRTRA money NOT NULL DEFAULT ((0)),
	TIPPRO TINYINT NOT NULL DEFAULT 6,
  SBLMOE VARCHAR(6) DEFAULT 'R$'  
) 

INSERT INTO @RESULT (DATCAD,PAGNRO,NIDREX,PRNDAT,PRNHOR,NUMTRA,CODCRT,NOMEST,DSCTRA,VLRTRA, TIPPRO, SBLMOE)

SELECT A.DATCAD
	,PAGNRO = ((((ROW_NUMBER() OVER(ORDER BY NIDBOL DESC))-1)/@PAGSIZ))+1 
	,NIDREX = NIDCCR
  ,CONVERT(VARCHAR(10), A.DATCAD,103) AS PRNDCA  
  ,CONVERT(VARCHAR(10), A.DATCAD,108) PRNHOR   
	,NUMTRA = NIDTRA
	,CODCRT = CODCRT
	,NOMEST = A.DSCMOV
	,DSCTRA = B.DSCMOV
	,VLRTRA = A.VLRMOV * A.SIGOPE
  ,TIPPRO
  ,E.SBLMOE
 FROM TBREGCCR (NOLOCK) A
INNER JOIN TBTIPMOV (NOLOCK) B
   ON (B.CODMOV = A.CODMOV) 
INNER JOIN TBCADMOE (NOLOCK) E
   ON (A.CODMOE = E.CODMOE)
WHERE A.STAREC=1
  AND ( (@DATMOV1 IS  NULL AND @DATMOV2 IS NULL) or (A.DATMOV >= @DATMOV1 AND  A.DATMOV <= @DATMOV2))     
  AND A.CODUSU = @CODUSU  
  --AND A.CODCRT IN (SELECT CODCRT FROM TBREGCRT (NOLOCK) WHERE STACRT=109 AND USUPRO IN (SELECT USUPRO FROM TBUSUPRO WHERE CODPRO = @CODPRO))
  AND A.INDLCT IN (SELECT INDLCT FROM TBINDLCT (NOLOCK) WHERE TIPPRO >0)
 
DECLARE @PAGMAX INT 
SELECT @PAGMAX = MAX(ISNULL(PAGNRO,0)) FROM @RESULT
SELECT PAGNRO,NIDREX,PRNDAT,PRNHOR,NUMTRA,CODCRT,NOMEST,DSCTRA,VLRTRA, TIPPRO, SBLMOE, @PAGMAX PAGMAX FROM @RESULT A WHERE (1=1)
        
        ]]>

				</query>
				<parameters>
					<parameter input="true" apply="false" desc ="Código do Usuário" name="CODUSU"  type="System.Int32" default="" output="" null="false"/>
					<parameter input="true" apply="false" desc ="Data Inicial de Movimento" name="DATMOV1" type="System.String" size="20"  default="" output="" null="true"/>
					<parameter input="true" apply="false" desc ="Data Final de Movimento" name="DATMOV2" type="System.String" size="20" default="" output="" null="true"/>
					<parameter input="true" apply="true" desc ="Número da Página" name="PAGNRO"  type="System.Int32" sysnull="true" default="" output="" null="true"/>
					<parameter input="true" apply="false" desc ="Codigo do Produto" name="CODPRO"  type="System.Int16" output="" null="false"/>
					<parameter input="true" apply="false" desc ="Tamanho de Página" name="PAGSIZ"  type="System.Int32" default="100" output="" null="false"/>
				</parameters>

			</item>


			<item webtype="POST" script="true" alias="A." sql="" method="CloseRegister" return="int" returnmode="1" procname="PRREGCCRCLOREG" desc ="Efetua o fechamento de um registro associado ao tipo de referencia externa" returnvalue="1" remarks="O registro é atualizada para STABOR = 29, concluido">
				<query>
					<![CDATA[
/*
  01 - REGISTRO DE VENDA POS
  11 - REGISTRO DE TRANSACAO INTERNA
  21 - REGISTO DE PAGAMENTO
*/
SET @RETURN_VALUE=0
IF(@UPDUSU<=0)
  SET @RETURN_VALUE=-1

IF(@NIDCCR<=0)
  SET @RETURN_VALUE=-2

IF(@NIDRVM<=0)
  SET @RETURN_VALUE=-3
  
IF(@CODACE<=0)
  SET @RETURN_VALUE=-5
 
IF(NOT EXISTS(SELECT 1 FROM TBUSUACE (NOLOCK) 
               WHERE CODUSU = @UPDUSU 
                 AND CODACE = @CODACE 
                 AND STAREC = 1) )
  SET @RETURN_VALUE=-6
 
IF(@RETURN_VALUE=0)
  BEGIN
        UPDATE TBREGCCR 
           SET STABOR = @STABOR, 
               DATUPD = GETDATE(), 
               UPDUSU = @UPDUSU 
         WHERE TIPRFE = @TIPRFE 
           AND NIDRVM = @NIDRVM 
           AND STAREC=1

            IF(@TIPRFE=1 AND @CLOREG=1)
               UPDATE TBREGPOS SET STAPOS=@STABOR, DATUPD=GETDATE(),UPDUSU=@UPDUSU WHERE NIDRVM = @NIDRVM AND STAPOS <>@STABOR
            IF(@TIPRFE=11 AND @CLOREG=1)
               BEGIN
                  UPDATE TBREGTIN SET STAFIN=@STABOR, DATUPD=GETDATE(),UPDUSU=@UPDUSU WHERE NIDRTI = @NIDRVM AND STAFIN <>@STABOR
                  UPDATE TBREGTED SET STAREC=109, DATUPD=GETDATE(),UPDUSU=@UPDUSU WHERE CANRTI = @NIDRVM AND STAREC=1                 
               END
            IF(@TIPRFE=21 AND @CLOREG=1)
               UPDATE TBREGPAG SET STAPAG=@STABOR, DATUPD=GETDATE(),UPDUSU=@UPDUSU WHERE NIDPAG = @NIDRVM AND STAPAG <>@STABOR
            SET @RETURN_VALUE=1
  END 
RETURN @RETURN_VALUE

        ]]>

				</query>
				<parameters>
					<parameter input="true" apply="false" desc ="ID de Referencia Externa" name="NIDRVM" type="System.Int32" default="" output="" null="false"/>
					<parameter input="true" apply="false" desc ="ID do Registro Conta Corrente" name="NIDCCR" type="System.Int32" default="" output="" null="false"/>
					<parameter input="true" apply="false" desc ="Usuário de Atualizacao" name="UPDUSU" type="System.Int32" default="" output="" null="false"/>
					<parameter input="true" apply="false" desc ="Tipo de Referencia Externa" name="TIPRFE" type="System.Byte" output="" null="false"/>
					<parameter input="true" apply="false" desc ="Código de Acesso" name="CODACE" type="System.Int16" output="" null="false"/>
					<parameter input="true" apply="false" desc ="Status do Bordero" name="STABOR" type="System.Int16" default="29" output="" null="false"/>
					<parameter input="true" apply="false" desc ="Executar Atualizacao Relacionada" name="CLOREG" type="System.Byte" default="1" output="" null="false"/>
				</parameters>
				<returns>
					<return value="0" message="" error="APPROVALFAIL"/>
					<return value="1" message="REGISTRO ATUALIZADO" error="OK"/>
					<return value="-1" message="" error="REQUIREDUSEROPERATION"/>
					<return value="-2" message="IDENTIFICADOR DE REGISTRO DO C/C NAO INFORMADO" error="FAILALL"/>
					<return value="-3" message="IDENTIFICADOR DE EXTERNO NAO INFORMADO" error="FAILALL"/>
					<return value="-4" message="O REGISTRO E INVALIDO OU ESTA BLOQUEADO PARA OUTRA PESSOA" error="FAILALL"/>
					<return value="-5" message="" error="INVALIDACCESSCODE"/>
					<return value="-6" message="" error="APPROVALUSERNOTALLOWED"/>

				</returns>

			</item>


			<!--<item webtype="POST" script="true" alias="A." sql="" method="ClosePaymentRegister" return="int" returnmode="4" procname="" desc ="Efetua o fechamento de um registro de pagamento de contas" returnvalue="1" remarks="O registro é atualizada para STABOR = 29, concluido">
        <body>
            return CloseRegister(pNIDPAG, pNIDCCR, pUPDUSU, 21, 123, pSTABOR, 1); 
        </body>
        <parameters>
          <parameter input="true" apply="false" desc ="ID do Registro de Pagamento" name="NIDPAG" type="System.Int32" default="" output="" null="false"/>
          <parameter input="true" apply="false" desc ="ID do Registro Conta Corrente" name="NIDCCR" type="System.Int32" default="" output="" null="false"/>
          <parameter input="true" apply="false" desc ="Usuário de Atualizacao" name="UPDUSU" type="System.Int32" default="" output="" null="false"/>
          <parameter input="true" apply="false" desc ="Status do Bordero" name="STABOR" type="System.Int16" default="29" output="" null="false"/>          
        </parameters>
     </item>-->


			<item  webtype="POST" script="true" alias="A." sql="" method="LockRecord" return="int" returnmode="1" returnvalue="1" procname="PRREGCCRLOKREC" desc ="Bloqueia o registro para o usuário informado">
				<query>
					<![CDATA[
SET @RETURN_VALUE=0
IF(@TIPBLO NOT IN (1,2))
   SET @RETURN_VALUE=-3
   
IF(@RETURN_VALUE=0)
  BEGIN
    IF(@UPDUSU>0)
        SET @RETURN_VALUE=-1
  END
  
IF(@RETURN_VALUE=0)  
  BEGIN
    IF(@NIDCCR>0)
      SET @RETURN_VALUE=-2
  END

IF(@RETURN_VALUE=0)
  BEGIN
    IF(EXISTS(SELECT 1 FROM TBREGCCR (NOLOCK) WHERE NIDCCR=@NIDCCR AND CODAPR=0))
        SET @RETURN_VALUE = -3
    ELSE
      BEGIN
          IF(@TIPBLO=1)
              UPDATE TBREGCCR SET CODAPR=@UPDUSU WHERE NIDCCR=@NIDCCR AND CODAPR=0
          ELSE
              UPDATE TBREGCCR SET CODAPR=0 WHERE NIDCCR=@NIDCCR AND CODAPR=@UPDUSU     
          SET @RETURN_VALUE = @@ROWCOUNT              
      END      
  END
RETURN @RETURN_VALUE  
        ]]>

				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="Tipo de Bloqueio (1 - Bloqueio, 2 - Desbloqueio)" name="TIPBLO" type="System.Byte" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="ID do Registro de Conta Corrente" name="NIDCCR" type="System.Int32" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Usuário de Bloqueio" name="UPDUSU" type="System.Int32" default="" output="" null="false"/>
				</parameters>
				<returns>
					<return value="0" message="" error="APPROVALFAIL"/>
					<return operator=">" value="0" message="" error="OK"/>
					<return value="-1" message="USUARIO PARA BLOQUEIO NAO INFORMADO" error="FAILALL"/>
					<return value="-2" message="IDENTIFICADOR DE REGISTRO NAO INFORMADO" error="FAILALL"/>
					<return value="-3" message="TIPO DE BLOQUEIO NAO INFORMADO" error="FAILALL"/>
				</returns>
			</item>


			<item script="true" alias="A." sql="" method="ApproveOperation" return="int" returnmode="2" procname="PRREGCCRAPROPE" desc ="Efetua o Registro de Aprovação de uma operação">
				<query>
					<![CDATA[
DECLARE @RETURN_VALUE INT = 0
DECLARE @VLRAPR MONEY=0
DECLARE @NIDTRA VARCHAR(13)
DECLARE @STAREC TINYINT
DECLARE @OLDAPR TINYINT
DECLARE @OLDBOR SMALLINT
DECLARE @CODAPR INT

SELECT @STAREC = STAREC,
			@OLDAPR = CODAPR,
			@OLDBOR = STABOR,
			@VLRAPR = VLRMOV,
			@NIDTRA = NIDTRA
  FROM TBREGCCR (NOLOCK) 
 WHERE NIDCCR = @NIDCCR

IF(@STAREC=0)
	SET @RETURN_VALUE=-1

IF(@OLDAPR>0)
	SET @RETURN_VALUE=-2

IF( NOT EXISTS(SELECT 1 FROM TBUSUACE WHERE CODUSU= @UPDUSU AND STAREC=1 AND CODACE=@CODACE))
	SET @RETURN_VALUE=-3


	 IF(@RETURN_VALUE=0)
		BEGIN
			INSERT 
	  		 INTO TBREGAPR (STAREC, UPDUSU, NIDTRA, NIDCCR, USUAPR,  DATAPR,  VLRAPR)  VALUES (1,@UPDUSU,@NIDTRA,@NIDCCR,@UPDUSU,GETDATE(),@VLRAPR)
         IF(@@ERROR=0)
			      BEGIN
					    SET @CODAPR = @@IDENTITY
						UPDATE TBREGCCR
					     SET CODAPR = @CODAPR,
						       STABOR = @STABOR
				     WHERE NIDCCR = @NIDCCR
					  IF(@@ERROR=0)
						   SET @RETURN_VALUE = @CODAPR
					END
				ELSE
					BEGIN
						SET @RETURN_VALUE=-4
						UPDATE TBREGCCR
						   SET CODAPR = @OLDAPR,
							   STABOR = @OLDBOR
						 WHERE NIDCCR = @NIDCCR
						 IF(@@ERROR<>0)
						    SET @RETURN_VALUE = -5
					END	
		END
	SELECT @RETURN_VALUE
        
        ]]>

				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="ID do Registro de Conta Corrente" name="NIDCCR" type="System.Int32" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Status da Operação" name="STABOR" type="System.Int16" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Usuário de Aprovação" name="UPDUSU" type="System.Int32" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Codigo de Acesso" name="CODACE" type="System.Int32" default="" output="" null="false"/>
				</parameters>
				<returns>
					<return value="0" message="" error="APPROVALFAIL"/>
					<return operator=">" value="0" message="" error="OK"/>
					<return value="-1" message="" error="APPROVALFAILRECORD"/>
					<return value="-2" message="" error="APPROVALEXISTING"/>
					<return value="-3" message="" error="APPROVALUSERNOTALLOWED"/>
					<return value="-4" message="" error="APPROVALFAIL"/>
					<return value="-5" message="" error="APPROVALFAIL"/>
				</returns>
			</item>
			<item script="true" alias="A." sql="" method="GetSaldoContaCorrente" return="double"  returnmode="2" procname="PRREGCCRSALUSU" desc ="Obtêm o saldo da conta do indicador de lançamento do usuário">
				<query>
					<![CDATA[
DECLARE @SQL VARCHAR(512)=N''
SET @SQL = N'SELECT COALESCE(SUM((VLRMOV*SIGOPE)),0) AS VLRTRA FROM TBREGCCR A (NOLOCK) WHERE A.STAREC =1'
SET @SQL = @SQL + ' AND (A.TIPVAL IN (' + @TIPVAL +'))'
SET @SQL = @SQL + ' AND A.REGHAB=1'
SET @SQL = @SQL + ' AND A.INDLCT = ' + CAST(@INDLCT AS VARCHAR(3)) 
SET @SQL = @SQL + ' AND ORGCTA = ' + CAST(@ORGCTA AS VARCHAR(3))
SET @SQL = @SQL + ' AND A.CODUSU = ' + CAST(@CODUSU AS VARCHAR(10))
EXEC (@SQL)]]>
				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="Código do Usuário"       name="CODUSU" type="System.Int32" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Tipo de Valor"           name="TIPVAL" size="30" type="System.String" default="1" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Indicador de Lançamento" name="INDLCT" type="System.Byte" default="2" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Origem da Conta"         name="ORGCTA" type="System.Byte" default="1" output="" null="false"/>
				</parameters>
			</item>

			<item script="true" alias="A." sql="" method="GetCurrentAccountMovement" return="DataTable" procname="PRREGCCRSELCCT" desc ="Recupera os registros do conta corrente de acordo com os parâmetros fornecidos">
				<query>
					<![CDATA[
DECLARE @SLDANT float
DECLARE @TBLSLD TABLE (CODUSU int, SLDANT money DEFAULT 0 )
DECLARE @TBLIND TABLE (INDLCT smallint )  
DECLARE @NIDBOL int = NULL
DECLARE @NIDTRA varchar(13) = NULL
DECLARE @DSCMOV varchar(150) = NULL
DECLARE @DATFIL varchar(20) = NULL
IF(@INDLCT IS NULL)
    INSERT INTO @TBLIND SELECT INDLCT FROM TBINDLCT WHERE TIPPRO>0
ELSE
 	  INSERT INTO @TBLIND (INDLCT) VALUES (@INDLCT)

IF (@DATMOV1 = '')
		SET @DATMOV1 = NULL
IF (@DATMOV2 = '')
		SET @DATMOV2 = NULL

IF ((@DATMOV1 IS NOT NULL) AND (@DATMOV2 IS NOT NULL))
		BEGIN
			INSERT @TBLSLD (CODUSU, SLDANT)
			SELECT @CODUSU, SUM(VLRMOV * SIGOPE) SLDANT
			  FROM TBREGCCR
			 WHERE STAREC = 1
			   AND (@INDLCT IS NULL OR INDLCT = @INDLCT)
         AND CODUSU = @CODUSU
         AND DATMOV < @DATMOV1
         AND ORGCTA = @ORGCTA
			SET @NUMDAY = NULL
		END
	ELSE
      BEGIN
          INSERT @TBLSLD (CODUSU, SLDANT)
			    SELECT @CODUSU, SUM(VLRMOV * SIGOPE) SLDANT
			      FROM TBREGCCR (NOLOCK)
			     WHERE STAREC = 1
			       AND (@INDLCT IS NULL OR INDLCT = @INDLCT)
             AND CODUSU = @CODUSU
             AND ORGCTA = @ORGCTA
      END

	IF (@NUMDAY IS NOT NULL)
	  SET @DATFIL = CONVERT(varchar(10), DATEADD(DD, @NUMDAY * -1, GETDATE()), 112)

	IF (@TIPSEL = 1 AND (@ARGSEL IS NOT NULL))
	  SET @NIDBOL = CAST(@ARGSEL AS int)

	IF (@TIPSEL = 2 AND (@ARGSEL IS NOT NULL))
	  SET @NIDTRA = @ARGSEL

	IF (@TIPSEL = 3 AND (@ARGSEL IS NOT NULL))
	  SET @DSCMOV = '%' + RTRIM(@ARGSEL) + '%'

SELECT DATNUM = CONVERT(INT, DATMOV),
		   NIDCCR,
		   REFNID,
		   REGHAB,
		   A.STAREC,
		   ISNULL(b.DSCTAB, '''') AS DSCREC,
		   TIPLCT,
		   REGPRO,
		   LOTFIN,
		   A.DATCAD,
		   A.DATMOV,
		   CONVERT(varchar(10), A.DATMOV, 103) AS PRNDCA,
		   CONVERT(varchar(8), A.DATCAD, 8) AS PRNHCA,
		   A.DATUPD,
		   A.UPDUSU,
		   ISNULL(e.LGNUSU, '''') AS DSCUPD,
		   A.REFLOT,
		   A.CODSOL,
		   A.CODPRT,
		   A.CODUSU,
		   A.USUPRO,
		   ISNULL(I.NOMUSU, '''') AS USUNOM,
		   A.NIDBOL,
		   A.SIGOPE,
		   ISNULL(c.dsctab, '''') AS DSCOPE,
		   A.LINREF,
		   A.TIPLIN,
		   A.IDEPRE,
		   A.CODMOV,
		   DSCCPR = (CASE WHEN A.CODTRM IN (2, 3) THEN LTRIM(RTRIM(M.DSCTAB)) + ' ' ELSE '' END) + D.DSCMOV,
		   A.DATPCL,
		   A.NUMPCL,
		   A.TIPVAL,
		   A.VLRMOV,
		   (a.vlrmov * a.sigope) AS VLRTRA,
		   CASE WHEN a.tipval = 7 THEN (a.vlrmov * a.sigope) ELSE 0 END AS VLRBLO,
		   CASE WHEN a.tipval = 2 THEN (a.vlrmov * a.sigope) ELSE 0 END AS VLRVIN,
		   A.DSCMOV,
		   A.DATVEN,
		   A.DATMOV,
		   CONVERT(varchar, A.DATMOV, 103) AS PRNDMV,
 		   A.CONUSU,
		   A.STAREG,
		   ISNULL(G.DSCSTA, '') AS DSCSTA,
		   A.NUMBOR,
		   A.STABOR,
		   ISNULL(K.DSCSTA, '') AS DSCBOR,
		   A.DATPRC,
		   A.NIDUCT,
		   A.INDLCT,
		   L.DSCLCT,
		   A.NIDCTA,
		   NIDTRA = RIGHT('00000000000' + A.NIDTRA,11),
		   A.CANTRA,
		   A.CODMOE,
		   A.TIPRFE,
		   A.NIDRVM,
		   A.NIDPAG,
		   ISNULL(F.NOMUSU, '') AS NOMUSU,
		   ISNULL(dbo.NomeContaUsuario(A.NIDUCT), '') AS DSCUCT,
		   '' AS DSCCTA,
		   ISNULL(N.SLDANT, 0) SLDANT,
		   A.TIPPRO
  FROM TBREGCCR A (NOLOCK)
 INNER JOIN tbtipmov D (NOLOCK) ON (A.CODMOV = D.CODMOV)
	LEFT JOIN tbtabger b (NOLOCK) ON (B.NUMTAB = 7  AND B.KEYCOD = a.starec)
	LEFT JOIN tbtabger c (NOLOCK) ON (C.NUMTAB = 10 AND C.KEYCOD = a.sigope)
	LEFT JOIN TBCADUSU e (NOLOCK) ON (A.UPDUSU = e.CODUSU)
	LEFT JOIN TBCADUSU F (NOLOCK) ON (A.CODUSU = F.CODUSU)
 INNER JOIN TBCADSTA G (NOLOCK) ON (A.STAREG = G.CODSTA)
 INNER JOIN TBCADSTA K (NOLOCK) ON (A.STABOR = K.CODSTA)
	LEFT JOIN TBUSUPRO H (NOLOCK) ON (A.USUPRO = H.USUPRO)
	LEFT JOIN TBCADUSU I (NOLOCK) ON (H.CODUSU = I.CODUSU)
	LEFT JOIN TBCADCTA J (NOLOCK) ON (A.NIDCTA = J.NIDCTA)
 INNER JOIN TBINDLCT L (NOLOCK) ON (L.INDLCT = A.INDLCT)
	LEFT JOIN TBTABGER M (NOLOCK) ON (M.NUMTAB = 59 AND M.KEYCOD = A.CODTRM)
	LEFT JOIN @TBLSLD  N          ON (N.CODUSU = A.CODUSU)
 WHERE (A.STAREC IN (1, 2))
	 AND (A.TIPVAL IN (1, 2, 4))
	 AND (A.VISREC = 1)    
	 AND (A.INDLCT IN (SELECT INDLCT FROM @TBLIND))
	 AND A.CODUSU = @CODUSU
	 AND (@NIDBOL IS NULL OR A.NIDBOL = @NIDBOL)
	 AND (@NIDTRA IS NULL OR A.NIDTRA = @NIDTRA)
	 AND (@DSCMOV IS NULL OR A.DSCMOV LIKE @DSCMOV)
	 AND ((@DATMOV1 IS NULL AND @DATMOV2 IS NULL) OR (A.DATMOV >= @DATMOV1 AND A.DATMOV <= @DATMOV2))
	 AND (@DATFIL IS NULL OR A.DATMOV >= @DATFIL)
	 AND (@ORGCTA IS NULL OR A.ORGCTA = @ORGCTA)    
		ORDER BY NIDCCR DESC
]]>

				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="Código do Usuário"            name="CODUSU" type="System.Int32" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Indicador de Lançamento"      name="INDLCT" sysnull="true" type="System.Int16"  default="" output="" null="true"/>
					<parameter input="true" apply="true" desc ="Data Inicial de Movimento (yyyyMMdd)"    name="DATMOV1" size="20" type="System.String" default="" output="" null="true"/>
					<parameter input="true" apply="true" desc ="Data Final de Movimento (yyyyMMdd)"      name="DATMOV2" size="20" type="System.String" default="" output="" null="true"/>
					<parameter input="true" apply="true" desc ="Argumento de Seleção"         name="ARGSEL" type="System.String" size="50" default=" " output="" null="true"/>
					<parameter input="true" apply="true" desc ="Tipo de Selecao"              name="TIPSEL" type="System.Byte"  sysnull="true" output="" null="true"/>
					<parameter input="true" apply="true" desc ="Número Máximo de Registros"   name="TOPREC" type="System.Int32" sysnull="true" output="" null="true"/>
					<parameter input="true" apply="true" desc ="Numero de Dias para Exibição" name="NUMDAY" type="System.Int32" sysnull="true" output="" null="true"/>
					<parameter input="true" apply="true" desc ="Origem da Conta"              name="ORGCTA" type="System.Byte" default="1" output="" null="false" />
				</parameters>
			</item>
			<item script="true" alias="A." sql="" type="" method= "GetCurrentAccountBalance" return="DataTable" procname="PRREGCCRSALACT" desc ="Obtêm o saldo da conta corrente do tipo de lançamento e usuário especificado">
				<query>
					<![CDATA[
	SET NOCOUNT ON
 SELECT SUM(a.vlrmov*a.sigope) AS VLRTRA, 
        SUM(case when a.tipval=2 then (a.vlrmov*a.sigope) else 0 end) AS VLRVIN,
        SUM(case when a.tipval=7 then (a.vlrmov*a.sigope) else 0 end) AS VLRBLO        
   FROM TBREGCCR A (nolock) 
	INNER JOIN tbtipmov D (nolock) 
	   on (A.CODMOV = D.CODMOV) 
 	 left join tbtabger b (nolock) 
	   on (7 = B.NUMTAB AND a.starec = b.keycod)
 	 left join tbtabger c (nolock) 
	   on (10 = C.NUMTAB AND a.sigope = c.keycod)
 	 LEFT JOIN TBCADUSU e (NOLOCK) 
	   ON (A.UPDUSU = e.CODUSU)
 	 LEFT JOIN TBCADUSU F (NOLOCK) 
	   ON (A.CODUSU = F.CODUSU)
	INNER JOIN TBCADSTA G (NOLOCK) 
	   ON (A.STAREG = G.CODSTA)
    INNER JOIN TBCADSTA K (NOLOCK) 
	   ON (A.STABOR = K.CODSTA)
     LEFT JOIN TBUSUPRO H (NOLOCK) 
	   ON (A.USUPRO = H.USUPRO)
	 LEFT JOIN TBCADUSU I (NOLOCK) 
	   ON (H.CODUSU = I.CODUSU)
	 LEFT JOIN TBCADCTA J (NOLOCK) 
	   ON (A.NIDCTA = J.NIDCTA)
	INNER JOIN TBTABGER L (NOLOCK) 
	   ON (39 = L.NUMTAB AND A.INDLCT = L.KEYCOD)
	 LEFT JOIN TBTABGER M (NOLOCK) 
	   ON (59 = M.NUMTAB AND A.CODTRM = M.KEYCOD)
	WHERE (A.STAREC IN (1,2))
	  AND (A.TIPVAL IN(1,2,4))
      AND (@INDLCT IS NULL OR A.INDLCT = @INDLCT)
      AND (@CODUSU IS NULL OR A.CODUSU = @CODUSU)
	      ]]>
				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="Indicador de Lançamento" name="INDLCT" type="System.Byte" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Código do Usuário" name="CODUSU" type="System.Int32" default="" output="" null="false"/>
				</parameters>
			</item>


			<item script="true" alias="A." sql="" method="RemoveBatch" return="int" returnmode="1" procname="PRREGCCRREMBAT" desc ="Remove um Lote" returnvalue="1">
				<query>
					<![CDATA[
SET @RETURN_VALUE=0
IF(@TIPRFE<=0)
   SET @RETURN_VALUE=-1
IF(@UPDUSU<=0)
   SET @RETURN_VALUE=-2
IF(@LOTFIN<=0)
   SET @RETURN_VALUE=-3

/* REMOVE O LOTE DE INSCRIÇÃO */

BEGIN TRAN
IF(@RETURN_VALUE=0)
		BEGIN
			IF(@LOTFIN>0 AND @NIDRVM=0)
				BEGIN
					UPDATE TBREGCCR SET STAREC=0, UPDUSU=@UPDUSU, DATUPD=GETDATE() 
			 		 WHERE LOTFIN = @LOTFIN AND TIPRFE = @TIPRFE
					IF(@@ERROR=0)
						SET @RETURN_VALUE=1
				END

			IF(@LOTFIN>0 AND @NIDRVM>0)
				BEGIN
					UPDATE TBREGCCR SET STAREC=0, UPDUSU=@UPDUSU,  DATUPD=GETDATE() 
					 WHERE LOTFIN = @LOTFIN AND TIPRFE = @TIPRFE AND NIDRVM= @NIDRVM
					IF(@@ERROR=0)
						SET @RETURN_VALUE=1
				END
		END

IF(@RETURN_VALUE=1 AND @LOTFIN>0 AND @NIDRVM=0)
		BEGIN
      IF(@TIPRFE=4)
        BEGIN
			    UPDATE TBCTRMEN SET LOTINS = 0, DATUPD=GETDATE() WHERE LOTINS = @LOTFIN	AND LOTFIN=0
			    IF(@@ERROR=0)
				     SET @RETURN_VALUE=1
		    END
    END        
        
IF(@RETURN_VALUE=1 AND @LOTFIN>0 AND @NIDRVM>0)
		BEGIN
      IF(@TIPRFE=4)
        BEGIN
			    UPDATE TBCTRMEN SET LOTINS = 0, DATUPD=GETDATE() WHERE LOTINS = @LOTFIN	AND LOTFIN=0 AND NIDMEN=@NIDRVM
			    IF(@@ERROR=0)
				     SET @RETURN_VALUE=1
		    END
    END

IF(@RETURN_VALUE=1)
		COMMIT TRAN
ELSE
	ROLLBACK TRAN		
RETURN @RETURN_VALUE		
        ]]>
				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="Lote Financeiro" name="LOTFIN" type="System.String" size="13" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Tipo de Referencia Externa" name="TIPRFE" type="System.Byte" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="ID do Registros de Referencia" name="NIDRVM" type="System.Int32" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Usuário de Atualização" name="UPDUSU" type="System.Int32" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Controle de Processamento" name="CTLPRO" type="System.Byte" default="0" output="" null="false"/>
				</parameters>
				<returns>
					<return value="0" message="" error="EMPTYDATARECORDS"/>
					<return value="1" message="LOTE REMOVIDO" error="OK"></return>
					<return value="-1" message="TIPO DE REFERENCIA EXTERNA NAO INFORMADA" error="FAILALL"/>
					<return value="-2" message="" error="REQUIREDUSEROPERATION"/>
					<return value="-3" message="LOTE FINANCEIRO NAO INFORMADO" error="FAILALL"/>
				</returns>
			</item>


			<item script="true" alias="A." sql="" method="RemoveTransaction" return="int" returnmode="1" procname="PRREGCCRREMTRA" desc ="Remove uma transação" returnvalue="1">
				<query>
					<![CDATA[
    SET @RETURN_VALUE=0
	DECLARE @NIDRVM INT
	DECLARE @LOTFIN INT
	DECLARE @TIPRFE TINYINT
	IF(@UPDUSU=0)
		SET @RETURN_VALUE=-2

	IF(EXISTS(SELECT 1 FROM TBREGCCR (NOLOCK) WHERE NIDTRA = @NIDTRA AND STAREC<>1))
		SET @RETURN_VALUE=-3

	IF(@RETURN_VALUE=0)
		BEGIN
			IF(EXISTS(SELECT 1 FROM TBREGCCR (NOLOCK) WHERE NIDTRA = @NIDTRA AND STAREC=1))
				BEGIN

				    SELECT @LOTFIN = LOTFIN, @NIDRVM = NIDRVM, @TIPRFE = TIPRFE FROM TBREGCCR (NOLOCK) WHERE NIDTRA = @NIDTRA

					IF(@LOTFIN>0 AND @NIDRVM>0)
						BEGIN
							UPDATE TBREGCCR 
							   SET STAREC=0, DATUPD=GETDATE(), UPDUSU = @UPDUSU 
					         WHERE NIDTRA = @NIDTRA
							 
							 IF(@@ERROR=0) 
								BEGIN
									IF(@TIPRFE=11)
										BEGIN
											UPDATE TBREGTIN 
											   SET STAREC=0, DATUPD=GETDATE(), UPDUSU = @UPDUSU  
									         WHERE NIDRTI = @NIDRVM

											UPDATE TBREGPAY 
											   SET STAREC=13, APLLCT=3  
									         WHERE NIDRTI = @NIDRVM

										END
								END
						    SET @RETURN_VALUE=1						
						END						         
				END     
		ELSE
			SET @RETURN_VALUE=-1
		END
RETURN @RETURN_VALUE
        ]]>

				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="ID da Transação" name="NIDTRA" type="System.String" size="13" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Usuário de Atualização" name="UPDUSU" type="System.Int32" default="" output="" null="false"/>
				</parameters>
				<returns>
					<return value="0" message="" error="EMPTYDATARECORDS"/>
					<return operator=">" value="0" message="" error="OK">
						<![CDATA[TrappedError.UserError = string.Format("{0} REGISTROS ATUALIZADOS", RETURN_VALUE);]]>
					</return>
					<return value="-1" message="" error="TRANSACTIONNOTHASRECORD"/>
					<return value="-2" message="" error="REQUIREDUSEROPERATION"/>
					<return value="-3" message="" error="TRANSACTIONNOTENABLED"/>
				</returns>
			</item>

			<item script="true" alias="A." sql="" method="ClassifyRecord" return="int" returnmode="1" procname="PRREGCCRLIBLAN" desc ="Libera Lançamento para agregação ao saldo do usuário e atualiza o registro de vendas, se aplicável" returnvalue="1" remarks="Esta opção define o campo TIPVAL para 1, posteriormente identifica se o registro é de origem de vendas, caso positivo, atualiza as informações pertinentes a origem da venda e registro">
				<query>
					<![CDATA[
SET @RETURN_VALUE=0
DECLARE @NIDBXA int
IF(@UPDUSU=0)
   SET @RETURN_VALUE=-3

IF(@RETURN_VALUE=0)
  BEGIN
    UPDATE TBREGCCR 
       SET TIPVAL = 1, UPDUSU=@UPDUSU, DATUPD=GETDATE() 
     WHERE NIDCCR = @NIDCCR AND TIPVAL<>1 
    IF(@@ERROR<>0)
        BEGIN
          SET @RETURN_VALUE=1        
          INSERT INTO TBAUDDAT (UPDUSU, AUDDAT, AUDKEY, AUDIDR, AUDIMS,AUDDSC) 
          VALUES (@UPDUSU,GETDATE(),43,@NIDCCR,100,'LANCAMENTO LIBERADO')  
  	    END
	ELSE
		SET @RETURN_VALUE=-1
   END	

IF(@RETURN_VALUE=0)
   BEGIN
		/* ATUALIZA REGISTRO DE VENDAS POS */
		SELECT @NIDBXA=NIDRVM 
          FROM TBREGCCR (NOLOCK) 
         WHERE NIDCCR = @NIDCCR AND TIPRFE = 1 AND STAREC<>0
   
        IF(@NIDBXA > 0)
          BEGIN
             UPDATE TBREGPOS 
                SET SITPGT = 2, UPDUSU = @UPDUSU, LIBPGT = GETDATE(), DATUPD = GETDATE()
              WHERE NIDRVM = @NIDBXA           
          END    
    END				
RETURN @RETURN_VALUE
          
        ]]>
				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="ID do Conta Corrente" name="NIDCCR" type="System.Int32" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Tipo de Valor" name="TIPVAL" type="System.Byte" default="1" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Usuário de Atualização" name="UPDUSU" type="System.Int32" default="0" output="" null="false"/>

				</parameters>
				<returns>
					<return value="0" message="" error="">
						<![CDATA[TrappedError.UserError = "NAO FOI POSSIVEL EXECUTAR A OPERACAO";]]>
					</return>
					<return value="1" message="" error="OK"/>
					<return value="-1" message="" error="">
						<![CDATA[TrappedError.UserError = "PARAMETROS INCORRETOS";]]>
					</return>
					<return value="-2" message="" error="">
						<![CDATA[TrappedError.UserError = "FALHA NA ATUALIZAÇÃO DO REGISTRO DE LANÇAMENTO";]]>
					</return>
					<return value="-3" message="" error="REQUIREDUSEROPERATION"/>
				</returns>
			</item>

			<item script="true" alias="A." sql="" method="ChangeTrustLevel" return="int" returnmode="1" procname="PRREGCCRCHGREGHAB" desc ="Altera a condição de registro habilitado para processamento (Trust Level)" returnvalue="1" remarks="Esta função só opera em nivel de transação" >
				<query>
					<![CDATA[
SET @RETURN_VALUE = 0
IF(@UPDUSU=0)
   SET @RETURN_VALUE=-1

IF(EXISTS(SELECT 1 FROM TBREGCCR (NOLOCK) WHERE NIDTRA = @NIDTRA AND STAREC<>1))
   SET @RETURN_VALUE=-2

IF(@RETURN_VALUE=0)
  BEGIN
    UPDATE TBREGCCR 
       SET REGHAB = @REGHAB 
     WHERE NIDTRA = @NIDTRA AND STAREC = 1
    IF(@@ERROR=0)
	    SET @RETURN_VALUE = 1
  END      
RETURN @RETURN_VALUE          
        ]]>
				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="ID da Transação" name="NIDTRA" size="13" type="System.String" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Usuário de Atualização" name="UPDUSU" type="System.Int32" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Marcador de Atualização do Registro" name="REGHAB" type="System.Byte" default="" output="" null="false"/>
				</parameters>
				<returns>
					<return value="0" message="" error="">
						<![CDATA[TrappedError.UserError = "NAO FOI POSSIVEL EXECUTAR A OPERACAO";]]>
					</return>
					<return value="1" message="REGISTRO ATUALIZADO COM SUCESSO" error="OK"/>
					<return value="-1" message="" error="REQUIREDUSEROPERATION"/>
					<return value="-2" message="" error="TRANSACTIONNOTENABLED"/>
				</returns>
			</item>

			<item script="true" alias="A." sql="" method="RevertTransaction" return="int" returnmode="1" procname="PRREGCCRREVTRA" desc ="Reverte uma transação para estorno ou cancelamento" returnvalue="1" remarks="Operação            Status Registro     Status Bordero@2 - Estorno         25                  23      @3 - Cancelamento    23                  25" >
				<query>
					<![CDATA[
    SET @RETURN_VALUE = 0
    IF(@NIDTRA='')
       SET @RETURN_VALUE=-1
    IF(@UPDUSU=0)
       SET @RETURN_VALUE=-3
       
--    IF(EXISTS(SELECT 1 FROM TBREGCCR (NOLOCK) WHERE NIDTRA = @NIDTRA AND STAREC<>1))
--      SET @RETURN_VALUE=-4
       

    DECLARE @RESULT TABLE (
        [REFNID] INT           DEFAULT 0 NOT NULL,
        [REGHAB] TINYINT       DEFAULT ((1)) NOT NULL,
        [STAREC] TINYINT       DEFAULT ((1)) NOT NULL,
        [TIPLCT] SMALLINT      DEFAULT 0 NOT NULL,
        [REGPRO] INT           DEFAULT 0 NOT NULL,
        [LOTFIN] INT           DEFAULT 0 NOT NULL,
        [CODAPR] INT           DEFAULT ((1)) NOT NULL,
        [ORGLCT] TINYINT       DEFAULT ((1)) NOT NULL,
        [DATCAD] DATETIME      DEFAULT getdate() NOT NULL,
        [DATUPD] DATETIME      DEFAULT getdate() NOT NULL,
        [UPDUSU] INT           DEFAULT 0 NOT NULL,
        [REFLOT] VARCHAR (10)  NULL,
        [CODSOL] VARCHAR (15)  DEFAULT ('') NOT NULL,
        [CODPRT] INT           NOT NULL,
        [CODUSU] INT           NOT NULL,
        [USUPRO] INT           NOT NULL,
        [NIDBOL] INT           NOT NULL,
        [SIGOPE] SMALLINT      DEFAULT 0 NOT NULL,
        [LINREF] SMALLINT      DEFAULT 0 NOT NULL,
        [TIPLIN] SMALLINT      DEFAULT 0 NOT NULL,
        [IDEPRE] TINYINT       DEFAULT 0 NOT NULL,
        [CODMOV] INT           NOT NULL,
        [DATPCL] DATE          NULL,
        [NUMPCL] INT           DEFAULT 0 NOT NULL,
        [TIPVAL] TINYINT       DEFAULT 0 NOT NULL,
        [VLRMOV] MONEY         NOT NULL,
        [DSCMOV] VARCHAR (150) NOT NULL,
        [DATVEN] DATE          NULL,
        [DATMOV] DATETIME      NOT NULL,
        [CONUSU] TINYINT       DEFAULT 0 NOT NULL,
        [STAREG] INT           NOT NULL,
        [NUMBOR] VARCHAR (14)  DEFAULT ('') NOT NULL,
        [STABOR] INT           DEFAULT 0 NOT NULL,
        [DATPRC] DATETIME      NULL,
        [NIDUCT] INT           DEFAULT 0 NOT NULL,
        [INDLCT] TINYINT       DEFAULT ((1)) NOT NULL,
        [NIDCTA] INT           DEFAULT 0 NOT NULL,
        [NIDTRA] VARCHAR (13)  DEFAULT ('') NOT NULL,
        [CANTRA] VARCHAR (13)  DEFAULT ('') NOT NULL,
        [NIDTRB] INT           DEFAULT 0 NOT NULL,
        [NUMIPA] VARCHAR (50)  DEFAULT ('') NOT NULL,
        [NIDTOK] INT           DEFAULT 0 NOT NULL,
        [CODMOE] INT           DEFAULT ((1)) NOT NULL,
        [NUMREX] VARCHAR (20)  NULL,
        [TIPRFE] TINYINT       DEFAULT 0 NOT NULL,
        [NIDRVM] INT           DEFAULT 0 NOT NULL,
        [NIDPAG] INT           DEFAULT 0 NOT NULL,
        [CODTRM] TINYINT       DEFAULT ((1)) NOT NULL
    )

IF(@RETURN_VALUE=0)
        BEGIN
        INSERT INTO @RESULT (
                    REFNID,
                    REGHAB,
                    STAREC,
                    TIPLCT,
                    REGPRO,
                    LOTFIN,
                    CODAPR,
                    ORGLCT,
                    DATCAD,
                    DATUPD,
                    UPDUSU,
                    REFLOT,
                    CODSOL,
                    CODPRT,
                    CODUSU,
                    USUPRO,
                    NIDBOL,
                    SIGOPE,
                    LINREF,
                    TIPLIN,
                    IDEPRE,
                    CODMOV,
                    DATPCL,
                    NUMPCL,
                    TIPVAL,
                    VLRMOV,
                    DSCMOV,
                    DATVEN,
                    DATMOV,
                    CONUSU,
                    STAREG,
                    NUMBOR,
                    STABOR,
                    DATPRC,
                    NIDUCT,
                    INDLCT,
                    NIDCTA,
                    NIDTRA,
                    CANTRA,
                    NIDTRB,
                    NUMIPA,
                    NIDTOK,
                    CODMOE,
                    NUMREX,
                    TIPRFE,
                    NIDRVM,
                    NIDPAG,
                    CODTRM)
        SELECT
                    NIDCCR,
                    REGHAB,
                    STAREC,
                    999 TIPLCT,
                    REGPRO,
                    LOTFIN,
                    CODAPR,
                    ORGLCT,
                    DATCAD,
                    DATUPD,
                    @UPDUSU,
                    REFLOT,
                    CODSOL,
                    CODPRT,
                    CODUSU,
                    USUPRO,
                    NIDBOL,
                    CASE WHEN SIGOPE=1 THEN -1 ELSE 1 END  SIGOPE,
                    LINREF,
                    TIPLIN,
                    IDEPRE,
                    CODMOV,
                    DATPCL,
                    NUMPCL,
                    TIPVAL,
                    VLRMOV,
                    DSCMOV,
                    DATVEN,
                    CASE WHEN @CHGDAT=0 THEN DATMOV ELSE GETDATE() END,
                    CONUSU,
                    STAREG,
                    NUMBOR,
                    STABOR,
                    DATPRC,
                    NIDUCT,
                    INDLCT,
                    NIDCTA,
                    '' NIDTRA,
                    NIDTRA CANTRA,
                    0 NIDTRB,
                    '' NUMIPA,
                    0 NIDTOK,
                    CODMOE,
                    NUMREX,
                    0 TIPRFE,
                    0 NIDRVM,
                    0 NIDPAG,
                    @CODTRM
                FROM TBREGCCR (NOLOCK)
                WHERE NIDTRA = @NIDTRA
                  AND STAREC=1

            IF(@@ROWCOUNT>0)
                BEGIN
                    DECLARE @LOTFIN INT
                    DECLARE @NXTTRA INT
                    DECLARE @NEWTRA VARCHAR(13)
                    EXEC PRGETNXTNUM 12, @LOTFIN OUTPUT
                    EXEC PRGETNXTNUM  6, @NXTTRA OUTPUT
                    SET @NEWTRA = '999' + RIGHT('00000000' + CAST(@NXTTRA AS VARCHAR(8)),8)
                    UPDATE @RESULT 
					   SET LOTFIN=@LOTFIN, 
					       NIDTRA = @NEWTRA
                    DELETE FROM @RESULT WHERE IDEPRE=0 AND @CODTRM=3

                INSERT INTO TBREGCCR(
                    REFNID,
                    REGHAB,
                    STAREC,
                    TIPLCT,
                    REGPRO,
                    LOTFIN,
                    CODAPR,
                    ORGLCT,
                    UPDUSU,
                    REFLOT,
                    CODSOL,
                    CODPRT,
                    CODUSU,
                    USUPRO,
                    NIDBOL,
                    SIGOPE,
                    LINREF,
                    TIPLIN,
                    IDEPRE,
                    CODMOV,
                    DATPCL,
                    NUMPCL,
                    TIPVAL,
                    VLRMOV,
                    DSCMOV,
                    DATVEN,
                    DATMOV,
                    CONUSU,
                    STAREG,
                    NUMBOR,
                    STABOR,
                    DATPRC,
                    NIDUCT,
                    INDLCT,
                    NIDCTA,
                    NIDTRA,
                    CANTRA,
                    NIDTRB,
                    NUMIPA,
                    NIDTOK,
                    CODMOE,
                    NUMREX,
                    TIPRFE,
                    NIDRVM,
                    NIDPAG,
                    CODTRM)

                SELECT
                    REFNID,
                    REGHAB,
                    STAREC,
                    TIPLCT,
                    REGPRO,
                    LOTFIN,
                    CODAPR,
                    ORGLCT,
                    UPDUSU,
                    REFLOT,
                    CODSOL,
                    CODPRT,
                    CODUSU,
                    USUPRO,
                    NIDBOL,
                    SIGOPE,
                    LINREF,
                    TIPLIN,
                    IDEPRE,
                    CODMOV,
                    DATPCL,
                    NUMPCL,
                    TIPVAL,
                    VLRMOV,
                    DSCMOV,
                    DATVEN,
                    DATMOV,
                    CONUSU,
                    STAREG,
                    NUMBOR,
                    STABOR,
                    DATPRC,
                    NIDUCT,
                    INDLCT,
                    NIDCTA,
                    NIDTRA,
                    CANTRA,
                    NIDTRB,
                    NUMIPA,
                    NIDTOK,
                    CODMOE,
                    NUMREX,
                    TIPRFE,
                    NIDRVM,
                    NIDPAG,
                    CODTRM
                FROM @RESULT

				IF(@@ERROR=0)
					BEGIN
						UPDATE TBREGCCR 
						   SET STAREG = CASE WHEN @CODTRM = 2 THEN 25 ELSE 23 END,
						       STABOR = CASE WHEN @CODTRM = 2 THEN 23 ELSE 25 END
						 WHERE NIDTRA = @NIDTRA
						   AND STAREC = 1
						SET @RETURN_VALUE=1
					END
                END
            ELSE      
                SET @RETURN_VALUE=-2

    END
    RETURN @RETURN_VALUE;    
          
        ]]>
				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="ID da Transação" name="NIDTRA" size="13" type="System.String" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Operação de Reversão" name="CODTRM" type="System.Byte" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Alterar data do movimento" name="CHGDAT" type="System.Byte" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Usuário de Atualização" name="UPDUSU" type="System.Int32" default="" output="" null="false"/>
				</parameters>
				<returns>
					<return value="0" message="" error="">
						<![CDATA[TrappedError.UserError = "NAO FOI POSSIVEL EXECUTAR A OPERACAO";]]>
					</return>
					<return value="1" message="" error="OK"/>
					<return value="-1" message="" error="TRANSACTIONNOTFOUND"/>
					<return value="-2" message="" error="TRANSACTIONNOTHASRECORD"/>
					<return value="-3" message="" error="REQUIREDUSEROPERATION"/>
					<return value="-4" message="" error="TRANSACTIONNOTENABLED"/>
				</returns>
			</item>

			<item webtype="POST" script="true" alias="A." sql="" method="CloseTransaction" return="int" returnmode="1" procname="PRREGCCRCLONIDTRA" desc ="Altera a condição de status de bordero para 29 (Fechamento da Transacao)" returnvalue="1" remarks="" >
				<query>
					<![CDATA[
SET @RETURN_VALUE =0
DECLARE @TIPRFE TINYINT = 0
IF(@UPDUSU=0)
  SET @RETURN_VALUE=-1
IF(@NIDTRA='' OR @NIDTRA IS NULL)
  SET @RETURN_VALUE=-2
IF(@STABOR<=0)
  SET @RETURN_VALUE=-3

SELECT TOP 1 @TIPRFE = TIPRFE FROM TBREGCCR (NOLOCK) WHERE NIDTRA = @NIDTRA AND STAREC=1

IF(@RETURN_VALUE=0)
  BEGIN
      UPDATE TBREGCCR
         SET STABOR = @STABOR,
             UPDUSU = @UPDUSU,
	           DATUPD = GETDATE()
       WHERE NIDTRA = @NIDTRA AND STAREC = 1          
       
       IF(@@ERROR=0)
          BEGIN
            IF(@TIPRFE>0)
                BEGIN
                  IF(@TIPRFE=11)
                      UPDATE TBREGTIN SET STAFIN = @STABOR, UPDUSU =@UPDUSU, DATUPD=GETDATE() WHERE NIDTRA = @NIDTRA AND STAREC=1
                  IF(@TIPRFE=21)
                      UPDATE TBREGPAG SET STAPAG = @STABOR, UPDUSU =@UPDUSU, DATUPD=GETDATE() WHERE NIDTRA = @NIDTRA AND STAREC=1
                      
                  SET @RETURN_VALUE = 1                               
                END
          END                
       ELSE
	        SET @RETURN_VALUE = 0          
   END     
RETURN @RETURN_VALUE
        ]]>
				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="ID da Transação" name="NIDTRA" size="13" type="System.String" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Usuário de Atualização" name="UPDUSU" type="System.Int32" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Status do Borderô" name="STABOR" type="System.Int16" default="" output="" null="false"/>
				</parameters>
				<returns>
					<return value="1" message="REGISTRO ATUALIZADO" error="OK"/>
					<return value="0" message="NAO FOI POSSIVEL EXECUTAR A OPERACAO" error=""/>
					<return value="-1" message="" error="REQUIREDUSEROPERATION"/>
					<return value="-2" message="" error="TRANSACTIONNOTGIVEN"/>
					<return value="-3" message="" error="INVALIDSTATUSRECORD"/>

				</returns>
			</item>


			<item script="true" alias="A." sql="" method="ChangeStatusTransaction" return="int" returnmode="1" procname="PRREGCCRCHGSTATRA" desc ="Altera o status de uma transação e respectivamente dos seus periféricos" returnvalue="1" remarks="Esta função só opera em nivel de transação" >
				<query>
					<![CDATA[
SET @RETURN_VALUE=0
DECLARE @NIDRVM INT=0
DECLARE @LOTFIN INT=0
DECLARE @TIPRFE TINYINT=0
IF(@UPDUSU=0)
	SET @RETURN_VALUE=-2


IF(@RETURN_VALUE=0)
		BEGIN
			IF(EXISTS(SELECT 1 FROM TBREGCCR (NOLOCK) WHERE NIDTRA = @NIDTRA AND STAREC<>@STAREC))
				BEGIN
				    SELECT @LOTFIN = LOTFIN, @NIDRVM = NIDRVM, @TIPRFE = TIPRFE FROM TBREGCCR (NOLOCK) WHERE NIDTRA = @NIDTRA

					IF(@LOTFIN>0 AND @NIDRVM>0)
						BEGIN
							UPDATE TBREGCCR SET STAREC=@STAREC, DATUPD=GETDATE(), UPDUSU = @UPDUSU  WHERE NIDTRA = @NIDTRA
						  IF(@@ERROR=0) 
								 BEGIN
									IF(@TIPRFE=11)
										BEGIN
											UPDATE TBREGTIN 
											   SET STAREC=@STAREC, DATUPD=GETDATE(), UPDUSU = @UPDUSU  
									         WHERE NIDRTI = @NIDRVM

											UPDATE TBREGPAY 
											   SET STAREC=@STAREC, APLLCT=3  
									         WHERE NIDRTI = @NIDRVM

										END
								END
						    SET @RETURN_VALUE=1						
						END						         
				END     
		ELSE
			SET @RETURN_VALUE=-1
		END
RETURN @RETURN_VALUE
          
        ]]>
				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="ID da Transação" name="NIDTRA" size="13" type="System.String" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Usuário de Atualização" name="UPDUSU" type="System.Int32" default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Status do Registro" name="STAREC" type="System.Byte" default="" output="" null="false"/>
				</parameters>
				<returns>
					<return value="0" message="" error="">
						<![CDATA[TrappedError.UserError = "NAO FOI POSSIVEL EXECUTAR A OPERACAO";]]>
					</return>
					<return value="1" message="TRANSACAO ALTERADA COM SUCESSO" error="OK"/>
					<return value="-1" message="FALHA NA ATUALIZACAO DA TRANSACAO" error="FAILALL"/>
					<return value="-2" message="" error="REQUIREDUSEROPERATION"/>
				</returns>
			</item>
		</methods>


		<selectallcommand>
			<item script="true" alias="A." sql="" type="" method="Select" return="DataTable" procname="PRREGCCRSELTRA" desc ="Recupera os registros da transação informada">
				<query>
					<![CDATA[SELECT A.*, B.DSCMOV MOVDSC 
 FROM TBREGCCR (NOLOCK) A
INNER JOIN TBTIPMOV (NOLOCK) B
   ON (B.CODMOV = A.CODMOV)
]]>
				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="ID da Transação" name="NIDTRA" type="System.String" size="13" default="" output="" null="false"/>
				</parameters>
			</item>
			<item script="true" alias="A." sql="" type="" method="Select" return="DataTable" procname="PRREGCCRSELTIPIND" desc ="Seleciona o registro de acordo com o Tipo e Indicador de Lançamento">
				<query>
					<![CDATA[SELECT * FROM TBREGCCR (NOLOCK) A]]>
				</query>
				<parameters>
					<parameter input="true" apply="true" desc ="Tipo de Lançamento" name="TIPLCT" type="System.Int16"  default="" output="" null="false"/>
					<parameter input="true" apply="true" desc ="Indicador de Lançamento" name="INDLCT" type="System.Int16" default="" output="" null="false"/>
				</parameters>
			</item>

		</selectallcommand>
	</item>

	<item create="true"  id="35" name="TBAUDDAT" friendlyname="Auditoria" modelversion="3" descriptor="Tabela de Registro de Auditoria">
		<CSharpPartial>true</CSharpPartial>
		<SqlTable></SqlTable>
		<fieldreturn></fieldreturn>

		<interface>
			<item script="false" alias="A." sql="" method="Insert" return="int" returnmode="2" procname="" desc ="Insere um registro de Auditoria" returnvalue="0">
				<query>
				</query>
				<parameters>
					<parameter input="true" desc ="Código Chave" name="pAUDKEY" type="System.Int32" default="" output="" null="false"/>
					<parameter input="true" desc ="Usuário de Atualização" name="pUPDUSU" type="System.Int32" default="" output="" null="false"/>
					<parameter input="true" desc ="Identificador de Auditoria" name="pAUDIDR" type="System.Int32" default="" output="" null="false"/>
					<parameter input="true" desc ="Descrição" name="pAUDDSC" type="System.String" size="4000" default="" output="" null="false"/>
					<parameter input="true" desc ="Id do Token" name="pNIDTOK" type="System.Int32" default="" output="" null="false"/>
					<parameter input="true" desc ="Ip de Acesso" name="pNUMIPA" type="System.String" size="50" default="" output="" null="false"/>
					<parameter input="true" desc ="ID Auxiliar de Identificação da Operação" name="pAUDIMS" type="System.Int32" default="" output="" null="false"/>
				</parameters>
			</item>
		</interface>

		<insertcommand key="Identity" exceptionparamns="'DATCAD','DATUPD', 'AUDNUM'">
			<maxfield field=""/>
			<nextnumber field="" id="" />
			<pre></pre>
			<body></body>
			<pos>
			</pos>
			<returns>
				<return value="-1" message="" error="FAILALL"/>

			</returns>
		</insertcommand>
	</item>




	<lists>


		<item reference="0" procbase="" script="false" alias="A." sql="" type="List" method="UsersProfile" return="ItemList" procname="" desc ="Obtêm uma lista de Perfil de usuários" remarks ="O perfil de usuário e listado a partir do perfil do solicitante">
			<query>
				<![CDATA[SELECT PFLUSU AS CODREF,DSCPFU AS DSCREF FROM RFPFLUSU (NOLOCK) A WHERE STAREC IN (1,2)]]>
			</query>
			<parameters>
				<parameter input="true" apply="true" desc ="Perfil Solicitante" operator="&gt;=" name="PFLUSU" type="System.Byte" default="" output="" null="false"/>
			</parameters>
		</item>

		<item reference="0" procbase="" script="false" alias="A." sql="" type="List" method="Specialties" return="ItemList" procname="" desc ="Obtêm uma lista de Especialidades de Veterinários">
			<query>
				<![CDATA[SELECT CODSPT AS CODREF,DSCSPT AS DSCREF FROM RFSPTVET (NOLOCK) WHERE STAREC IN (1,2)]]>
			</query>
		</item>

		<item reference="2" procbase="" alias="A." sql="" type="List" method="UF" return="ItemList" procname="" desc ="Obtêm todas as unidades da federação cadastradas - somente a sigla da unidade da federação">
			<query>
				<![CDATA[SELECT LTRIM(CODUFE) AS TXTREF, LTRIM(CODUFE) AS DSCREF FROM RFCODUFE (NOLOCK) WHERE STAREC=1 ORDER BY CODUFE]]>
			</query>
		</item>
		<item reference="2" procbase="" alias="A." sql="" type="List" method="UFDescricao" return="ItemList" procname="" desc ="Obtêm todas as unidades da federação cadastradas">
			<query>
				<![CDATA[SELECT LTRIM(CODUFE) AS TXTREF,  DSCUFE AS DSCREF FROM RFCODUFE (NOLOCK) WHERE STAREC=1 ORDER BY CODUFE]]>
			</query>
		</item>

		<item reference="0" procbase="" script="false" alias="A." sql="" type="List" method="RegistrationStatus" return="ItemList" procname="" desc ="Obtêm uma lista de Status de Registro">
			<query>
				<![CDATA[SELECT STAREC AS CODREF,DSCREC AS DSCREF FROM TBSTAREC (NOLOCK) ]]>
			</query>
		</item>
		<item reference="0" procbase="" script="false" alias="A." sql="" type="List" method="HumanGenus" return="ItemList" procname="" desc ="Obtêm uma lista de Gênero Humano">
			<query>
				<![CDATA[SELECT CODGEN AS CODREF,DSCGEN AS DSCREF FROM RFCODGEN (NOLOCK) WHERE STAREC=1 AND TIPGEN = 1 ]]>
			</query>
		</item>
		<item reference="0" procbase="" script="false" alias="A." sql="" type="List" method="AnimalGenus" return="ItemList" procname="" desc ="Obtêm uma lista de Gênero Animal">
			<query>
				<![CDATA[SELECT CODGEN AS CODREF,DSCGEN AS DSCREF FROM RFCODGEN (NOLOCK) WHERE STAREC=1 AND TIPGEN = 2 ]]>
			</query>
		</item>

		<item reference="0" procbase="" script="false" alias="A." sql="" type="List" method="IdentificationTypes" return="ItemList" procname="" desc ="Obtêm uma lista de Tipos de Identificação de Identificador de Registro">
			<query>
				<![CDATA[SELECT TYPCMF AS CODREF,DSCTYP AS DSCREF FROM RFTYPCMF (NOLOCK) WHERE STAREC=1 ]]>
			</query>
		</item>
		<item reference="940" procbase="" script="false" alias="A." sql="" type="List" method="AccessTypes" return="ItemList" procname="" desc ="Obtêm uma lista de Tipos de Acesso">
			<query order="KEYCOD">
				<![CDATA[SELECT KEYCOD AS CODREF,DSCTAB AS DSCREF FROM TBTABGER (NOLOCK) A WHERE CODTAB = 940 AND STAREC=1]]>
			</query>
		</item>

		<item reference="942" procbase="" script="false" alias="A." sql="" type="List" method="RelationsList" return="ItemList" procname="" desc ="Obtêm uma lista de Tipos de Relações de Responsabilidade">
			<query order="DSCTAB">
				<![CDATA[SELECT KEYCOD AS CODREF,DSCTAB AS DSCREF FROM TBTABGER (NOLOCK) A WHERE CODTAB = 942 AND STAREC=1]]>
			</query>
		</item>
		<item reference="" procbase="" alias="A." sql="" type="List" method="Countries" return="ItemList" procname="" desc ="Obtêm uma lista de países cadastradoss">
			<query>
				<![CDATA[SELECT  NIDPAI AS CODREF, DSCPAI AS DSCREF, CODDDI AS TXTREF, CODCTN AS REFAX1 FROM RFCODPAI (NOLOCK)  WHERE STAREC=1 ORDER BY DSCPAI]]>
			</query>
		</item>

		<item reference="" procbase="" alias="A." sql="" type="List" method="AddressTypes" return="ItemList" procname="" desc ="Obtêm uma lista de tipos de endereços cadastrados">
			<query>
				<![CDATA[SELECT TIPEND AS CODREF, DSCTEN AS DSCREF FROM RFTIPEND (NOLOCK)  WHERE STAREC=1 ORDER BY 1]]>
			</query>
		</item>

		<item reference="" procbase="" alias="A." sql="" type="List" method="AttributesTypes" return="ItemList" procname="" desc ="Obtêm uma lista de tipos de atributos">
			<query>
				<![CDATA[SELECT CODATR AS CODREF, DSCATR AS DSCREF FROM RFCODATR (NOLOCK)  WHERE STAREC=1 ORDER BY 1]]>
			</query>
		</item>
		<item reference="" procbase="" alias="A." sql="" type="List" method="ContactTypes" return="ItemList" procname="" desc ="Obtêm uma lista de tipos de contatos cadastrados">
			<query>
				<![CDATA[SELECT TIPCTT AS CODREF, DSCCTT AS DSCREF FROM RFTIPCTT (NOLOCK)  WHERE STAREC=1 ORDER BY 1]]>
			</query>
		</item>

		<item reference="" procbase="" alias="A." sql="" type="List" method="PublicPlaces" return="ItemList" procname="" desc ="Obtêm uma lista de tipos de logradouros cadastrados">
			<query>
				<![CDATA[SELECT TIPLOG AS CODREF, DSCLOG AS DSCREF FROM RFTIPLOG (NOLOCK)  WHERE STAREC=1 ORDER BY 1]]>
			</query>
		</item>

		<item reference="" procbase="" alias="A." sql="" type="List" method="Companies" return="ItemList" procname="" desc ="Obtêm uma lista de empresas">
			<query>
				<![CDATA[SELECT CODEMP AS CODREF, APEEMP AS DSCREF FROM TBCADEMP (NOLOCK)  WHERE STAREC=1 ORDER BY 1]]>
			</query>
		</item>

		<item reference="" procbase="" alias="A." sql="" type="List" method="Users" return="ItemList" procname="" desc ="Obtêm uma lista de usuários">
			<query order="RAZSOC">
				<![CDATA[SELECT CODUSU AS CODREF, RAZSOC AS DSCREF FROM TBCADUSU (NOLOCK) A WHERE STAREC=1 AND CODATR = @CODATR AND (@CODUSU IS NULL OR CODUSU = @CODUSU)]]>
			</query>
			<parameters>
				<parameter input="true" apply="true" omit="true" desc ="Atributo" name="CODATR" type="System.Byte" default="" output="" null=""/>
				<parameter input="true" apply="true" omit="true" desc ="Usuário"  name="CODUSU" type="System.Int32" default="" output="" null="false"/>

			</parameters>
		</item>

		<item reference="" procbase="" alias="A." sql="" type="List" method="PhoneOperators" return="ItemList" procname="" desc ="Obtêm uma lista de Operadoras de Telefonia">
			<query order ="DSCOPT">
				<![CDATA[SELECT NIDOPT AS CODREF, DSCOPT AS DSCREF FROM RFTELOPE (NOLOCK) A WHERE STAREC=1]]>
			</query>
		</item>

		<item reference="" procbase="" alias="A." sql="" type="List" method="IndicationsList" return="ItemList" procname="" desc ="Obtêm uma lista de Indicadores de clientes">
			<query>
				<![CDATA[SELECT CODIND AS CODREF, DSCIND AS DSCREF FROM RFCODIND (NOLOCK) WHERE STAREC=1]]>
			</query>
		</item>

		<item reference="" procbase="" alias="A." sql="" type="List" method="Breeds" return="ItemList" procname="" desc ="Obtêm uma lista de Raças">
			<query order="DSCRAC">
				<![CDATA[SELECT CODRAC AS CODREF, DSCRAC AS DSCREF FROM RFCODRAC (NOLOCK) WHERE STAREC=1 ]]>
			</query>
		</item>
		<item reference="" procbase="" alias="A." sql="" type="List" method="Species" return="ItemList" procname="" desc ="Obtêm uma lista de Espécies">
			<query order="DSCESP">
				<![CDATA[SELECT CODESP AS CODREF, DSCESP AS DSCREF FROM RFCODESP (NOLOCK) WHERE STAREC=1 ]]>
			</query>
		</item>

		<item reference="" procbase="" alias="A." sql="" type="List" method="Colors" return="ItemList" procname="" desc ="Obtêm uma lista de Cores">
			<query order="DSCCOR">
				<![CDATA[SELECT CODCOR AS CODREF, DSCCOR AS DSCREF FROM RFCODCOR (NOLOCK) WHERE STAREC=1 ]]>
			</query>
		</item>

		<item reference="" procbase="" alias="A." sql="" type="List" method="Pelages" return="ItemList" procname="" desc ="Obtêm uma lista de Pelagens">
			<query order="">
				<![CDATA[SELECT CODREF = CODPEL, ISNULL(ESP.DSCESP,'') + ' ' + DSCPEL AS DSCREF FROM RFCODPEL (NOLOCK)  PEL LEFT JOIN RFCODESP (NOLOCK) ESP ON (ESP.CODESP = PEL.CODESP)
 ]]>
			</query>
		</item>


		<item reference="" procbase="" alias="A." sql="" type="List" method="Sizes" return="ItemList" procname="" desc ="Obtêm uma lista de Porte de Pets">
			<query order="">
				<![CDATA[SELECT CODPOR AS CODREF, DSCPOR AS DSCREF FROM RFCODPOR (NOLOCK) WHERE STAREC=1 ]]>
			</query>
		</item>

		<item reference="" procbase="" script="true" alias="A." sql="" type="List" method="DynamicClients" return="ItemList" procname="PRCADANILSTDYN" desc ="Obtêm uma lista de Clientes por busca dinâmica">
			<query order="RAZSOC">
				<![CDATA[SELECT CODCLI AS CODREF, RAZSOC AS DSCREF FROM TBCADCLI (NOLOCK) A  WHERE STAREC=1 ]]>
			</query>
			<parameters>
				<parameter input="true" apply="true" islike="true" desc ="Nome do Cliente" name="RAZSOC" type="System.String" size="70" default="" output="" null=""/>
			</parameters>
		</item>
		
		<item reference="" procbase="" script="true" alias="A." sql="" type="List" method="RegistrationReferences" return="ItemList" procname="PRCADGEREFCAD" desc ="Obtêm uma lista de Referências do Cadastro Geral">
			<query>
				<![CDATA[
IF(@CODATR =3 OR @CODATR = 5)
	  BEGIN
	      IF(@NIDGER >0 )
		      SELECT CODUSU AS CODREF, RAZSOC AS DSCREF FROM TBCADUSU (NOLOCK) WHERE CODUSU = @NIDGER AND CODATR = @CODATR;
		  ELSE
 		      SELECT CODUSU AS CODREF, RAZSOC AS DSCREF FROM TBCADUSU (NOLOCK) WHERE CODATR = @CODATR ORDER BY RAZSOC;
	  END

  IF(@CODATR =1)
	  BEGIN
	      IF(@NIDGER >0 )
		      SELECT CODCLI AS CODREF, RAZSOC AS DSCREF FROM TBCADCLI (NOLOCK) WHERE CODCLI = @NIDGER AND CODATR = @CODATR;
		  ELSE
 		      SELECT CODCLI AS CODREF, RAZSOC AS DSCREF FROM TBCADCLI (NOLOCK) WHERE CODATR = @CODATR ORDER BY RAZSOC;
	  END
				
				]]>
			</query>
			<parameters>
				<parameter input="true" apply="true" omit="true" desc ="Atributo" name="CODATR" type="System.Byte" sysnull="true" default="" output="" null="false"/>
				<parameter input="true" apply="true" omit="true" desc ="Código de Referência" name="NIDGER" type="System.Int32" sysnull="true" default="" output="" null="false"/>

			</parameters>
		</item>

	</lists>

	<actions>



		<item  modifier="static" script="false" alias="" sql="" method="GetActiveUsers" return="int" returnmode="2" procname="" desc ="Retorna o número de usuários logados no aplicativo" returnvalue="0">
			<query>
				<![CDATA[
DECLARE @RETURN_VALUE INT = 0;
SELECT @RETURN_VALUE =  COUNT(*) FROM TBCADUSU (NOLOCK) A WHERE STAREC=1 AND HASLOG=1
IF(@RETURN_VALUE ==NULL)
SET @RETURN_VALUE = 0;
RETURN @RETURN_VALUE;

]]>
			</query>

		</item>
		<item  modifier="static" script="true" alias="" sql="" method="Logout" return="int" returnmode="2" procname="PRCADUSULOGOUT" desc ="Efetua o logout de usuário" returnvalue="0">
			<query>
				<![CDATA[
DECLARE @RETURN_VALUE INT = 0;
UPDATE TBCADUSU SET ULTLOG = GETDATE() WHERE CODUSU = @CODUSU;
IF(@@ERROR=0 AND @@ROWCOUNT>0)
	BEGIN
		INSERT INTO [dbo].[TBAUDDAT]
			   ([AUDDAT]
			   ,[AUDKEY]
			   ,[AUDIDR]
			   ,[AUDIMS]
			   ,[AUDOBJ]
			   ,[AUDSRC]
			   ,[AUDCHG]
			   ,[NUMIPA]
			   ,[UPDUSU])
		 VALUES
			   (GETDATE()
			   ,1
			   ,@CODUSU
			   ,2
			   ,OBJECT_NAME(@@PROCID)
			   ,''
			   ,'EXECUTOU LOGOUT DE APLICATIVO'
			   ,@NUMIPA
			   ,@CODUSU);
		IF(@@ERROR=0)
			SET @RETURN_VALUE = 1
	END

]]>
			</query>
			<parameters>
				<parameter input="true" apply="true" omit="true" desc ="ID do Usuário" name="CODUSU" type="int" default="" output="" null="false"/>
				<parameter input="true" apply="true" omit="true" desc ="Localizacao" name="NUMIPA" type="System.String" size="255" default="" output="" null="false"/>
				<parameter input="false" apply="true" omit="true" desc ="Retorno" name="RETURN_VALUE" type="System.Int32" default="" output="" null="false" inputmode="4"/>
			</parameters>
		</item>

		<item modifier="static" script="true" alias="" sql="" responsemode="1" method="Login" return="int" returnmode="2" procname="PRCADUSULGN" desc ="Efetua o login de usuário" returnvalue="1">
			<query>
				<![CDATA[
    DECLARE @CODUSU  INT = 0;
    DECLARE @RETURN_VALUE INT =0;
    
    IF(@LGNUSU IS NULL OR @LGNUSU= '')
        BEGIN
            SET @RETURN_VALUE=-3;
        END
    
    IF(COALESCE(@PSWUSU,'')='')
        BEGIN
            SET @RETURN_VALUE=-5;
        END
    
    
    IF(@RETURN_VALUE=0)
        BEGIN
        	IF(NOT EXISTS (SELECT 1 FROM TBCADUSU (NOLOCK) A WHERE LGNUSU = @LGNUSU AND STAREC=1 ))
         		SET @RETURN_VALUE=-2;
        END
    
    IF(@RETURN_VALUE=0)
        BEGIN
            SELECT @CODUSU = COALESCE(CODUSU,0)
          	  FROM TBCADUSU (NOLOCK) A
        	 WHERE PSWUSU = @PSWUSU AND LGNUSU = @LGNUSU AND STAREC=1
    
	        PRINT @CODUSU
    
        	IF(@CODUSU > 0)
				BEGIN
				   UPDATE TBCADUSU SET ULTACE = GETDATE(), ULTLOG=NULL, HASLOG=1 WHERE CODUSU = @CODUSU;    
				   IF(@@ERROR=0)
						BEGIN
							INSERT INTO 
								   TBAUDDAT (   AUDDAT,AUDKEY,  AUDIDR, AUDIMS,               AUDOBJ,AUDSRC,                        AUDCHG, NUMIPA, UPDUSU)
    								 VALUES (GETDATE(),     1, @CODUSU,      1,OBJECT_NAME(@@PROCID),    '','EXECUTOU LOGIN DE APLICATIVO',@NUMIPA,@CODUSU);
    						IF(@@ERROR=0)
    							SET @RETURN_VALUE = 1
					     END
				END
			ELSE
			    SET @RETURN_VALUE = -4;
        END
  
        RETURN @RETURN_VALUE;	
					
 ]]>
			</query>
			<parameters>
				<parameter input="true" apply="true" omit="true" desc ="Tipo de Login" name="LGNTYP" type="System.Byte"  default="" output="" null="false"/>
				<parameter input="true" apply="true" omit="true" desc ="Login do Usuário" name="LGNUSU" type="System.String" size="255" default="" output="" null="false"/>
				<parameter input="true" apply="true" omit="true" desc ="Senha de Usuário" name="PSWUSU" type="System.String" size="255" default="" output="" null="false"/>
				<parameter input="true" apply="true" omit="true" desc ="IP" name="NUMIPA" type="System.String" size="255" default="" output="" null="false"/>
				<parameter input="false" apply="true" omit="true" desc ="Retorno" name="RETURN_VALUE" type="System.Int32" default="" output="" null="false" inputmode="4"/>
			</parameters>

			<returns>
				<return value="0" operator=">" message="LOGIN EFETUADO COM SUCESSO" error=""></return>
				<return value="-1" message="FALHA NA INCLUSAO DO REGISTRO" error="FAILALL"/>
				<return value="-2" message="" error="USERNOTFOUND"/>
				<return value="-3" message="" error="LOGINBLANK"/>
				<return value="-4" message="" error="LOGINFAILREAD" />
				<return value="-5" message="" error="PASSWORDEMPTY" />
			</returns>
		</item>

		<item modifier="static" script="true" alias="" sql="" responsemode="1" method="ChangePassword" return="int" returnmode="2" procname="PRCADUSUCHGPSW" desc ="Altera a senha do usuário" returnvalue="1">
			<query>
				<![CDATA[
DECLARE @RETURN_VALUE INT = 0;
DECLARE @AUDCHG VARCHAR(2048) = N'';

IF(NOT EXISTS (SELECT 1 FROM TBCADGER (NOLOCK) WHERE NIDGER=@CODUSU)) 
   BEGIN
       SET @RETURN_VALUE=-2;
   END

IF((@RETURN_VALUE=0) AND COALESCE(@PSWUSU,'')='')
		BEGIN
			SET @RETURN_VALUE=-3;
		END

IF(@RETURN_VALUE=0) 
    BEGIN
		IF(NOT EXISTS (SELECT 1 FROM TBCADGER (NOLOCK) WHERE NIDGER=@CODUSU AND STAREC=1)) 
			BEGIN
				SET @RETURN_VALUE=-4;
			END
	END
IF(@RETURN_VALUE =0) 
    BEGIN
	       /* Altera senha somente de usuários ativos */
	       SET @AUDCHG = 'Trocou a senha para ' + @PSWUSU;
		UPDATE TBCADGER
		   SET PSWUSU = @PSWUSU,
		       UPDUSU = @UPDUSU,
   			   PSWRST = CASE WHEN  (@CODUSU = @UPDUSU) THEN 0 ELSE 1 END
		 WHERE NIDGER = @CODUSU AND STAREC = 1;
		   
		   IF(@@ERROR= 0) 
		      /* senha efetivamente alterada, retorna o id de auditoria da alteração */
			  
		      BEGIN
			    --registra auditoria
					INSERT INTO TBAUDDAT(AUDDAT,    AUDKEY,        AUDIDR,  AUDIMS,           AUDOBJ,  AUDSRC,  AUDCHG,  NUMIPA,  UPDUSU)
                                 VALUES (GETDATE(),      8, @RETURN_VALUE,       2, 'PRCADUSUCHGPSW',      '', @AUDCHG,     '' , @RETURN_VALUE);
					SET @RETURN_VALUE=@@IDENTITY;
			  END
		   
	END	
 RETURN @RETURN_VALUE;
]]>
			</query>
			<parameters>
				<parameter input="true" apply="true" omit="true" desc ="ID do usuário" name="CODUSU" type="System.Int32" default="" output="" null="false"/>
				<parameter input="true" apply="true" omit="true" desc ="Senha do Usuário" name="PSWUSU" type="System.String" size="255" default="" output="" null="false"/>
				<parameter input="true" apply="true" omit="true" desc ="Usuário de Atualização" name="UPDUSU" type="System.Int32" default="" output="" null="false"/>
				<parameter input="false" apply="true" omit="true" desc ="Retorno" name="RETURN_VALUE" type="System.Int32" default="" output="" null="false" inputmode="4"/>

			</parameters>

			<returns>
				<return value="0" operator=">" message="SENHA ALTERADA COM SUCESSO" error=""></return>
				<return value="-1" message="FALHA NA INCLUSAO DO REGISTRO" error="FAILALL"/>
				<return value="-2" message="" error="USERNOTFOUND"/>
				<return value="-3" message="" error="INVALIDARGUMENT" replaces="SENHA"/>
				<return value="-4" message="ESTA OPERAÇÃO NÃO PODE SER REALIZADA, O USUÁRIO ESTÁ INATIVO" error="" replaces="SENHA"/>
			</returns>
		</item>

		<item modifier="static" script="true" alias="AUD." sql="" route="" processcode="110" method="GetUserLogged" return="UserLogged" returnmode="2" procname="PRCADUSUGETUSR" desc ="Retorna informações do id de login informado" remarks="O sistema liga o ID de usuario com o ID de Chave de Associação de auditoria">
			<query>
				<![CDATA[
     SELECT TOP 1
          USU.LGNUSU,
          USU.CODUSU,
		  USU.RAZSOC,
          NUMTEL = ISNULL(CTO.NUMTEL,''),
          DSCMAL = ISNULL(ADR.DSCMAL,''),
          USU.PFLUSU,
		   DSCPFU,
		   PSWRST
    FROM TBCADUSU (NOLOCK) USU
   LEFT JOIN (SELECT NIDGER, CODATR, DSCEND AS DSCMAL FROM TBCADEND (NOLOCK) A WHERE A.STAREC=1 ) ADR
      ON (ADR.NIDGER = USU.CODUSU AND ADR.CODATR  = USU.CODATR)
   LEFT JOIN (SELECT NIDGER, CODATR, NUMTEL FROM TBCADCTO (NOLOCK) A WHERE A.STAREC=1 ) CTO
      ON (CTO.NIDGER = USU.CODUSU AND CTO.CODATR  = USU.CODATR)
   INNER JOIN RFPFLUSU (NOLOCK) PFL ON (PFL.PFLUSU = USU.PFLUSU)
]]>
			</query>
			<parameters>
				<parameter input="true" apply="true" desc ="Código do Usuário" alias="USU." name="CODUSU " type="System.Int32"   default=""  output="" null="false"/>
			</parameters>
		</item>

		<item modifier="static" script="true" alias="" sql="" route="" processcode="110" method="GetVeterinariansNumber" return="int" returnmode="2" procname="PRCADVETGETNUM" desc ="Retorna o número de veterinários cadastrados" remarks="O sistema apura o número de veterinários de forma distinta em relação ao apelido ou login do veterinário">
			<query order="">
				<![CDATA[DECLARE @RETURN_VALUE INT = 0;
				SELECT @RETURN_VALUE = COUNT(DISTINCT APEVET) FROM TBCADVET (NOLOCK) A WHERE STAREC=1;
				RETURN @RETURN_VALUE;]]>
			</query>
			<parameters>
				<parameter input="false" apply="true" omit="true" desc ="Retorno" name="RETURN_VALUE" type="System.Int32" default="" output="" null="false" inputmode="4"/>
			</parameters>
		</item>

		<item modifier="static" script="true" alias="" sql="" route="" processcode="110" method="GetUsersLoggedCount" return="int" returnmode="2" procname="PRCADUSULOGCNT" desc ="Retorna o número de usuários logados" remarks="">
			<query order="">
				<![CDATA[DECLARE @RETURN_VALUE INT = 0;
				SELECT @RETURN_VALUE = COUNT(DISTINCT(NIDGER)) FROM RGLOGACE (NOLOCK) A WHERE STAREC=1;
				RETURN @RETURN_VALUE;]]>
			</query>
			<parameters>
				<parameter input="false" apply="true" omit="true" desc ="Retorno" name="RETURN_VALUE" type="System.Int32" default="" output="" null="false" inputmode="4"/>
			</parameters>
		</item>

	</actions>
</root>



